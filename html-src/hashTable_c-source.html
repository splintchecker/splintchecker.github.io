<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>hashTable.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.3 on Fri Nov 3 18:57:41 2000 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>hashTable.c</h1><a href="hashTable_c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">** LCLint - annotation-assisted static program checker</font>
00003 <font class="comment">** Copyright (C) 1994-2000 University of Virginia,</font>
00004 <font class="comment">**         Massachusetts Institute of Technology</font>
00005 <font class="comment">**</font>
00006 <font class="comment">** This program is free software; you can redistribute it and/or modify it</font>
00007 <font class="comment">** under the terms of the GNU General Public License as published by the</font>
00008 <font class="comment">** Free Software Foundation; either version 2 of the License, or (at your</font>
00009 <font class="comment">** option) any later version.</font>
00010 <font class="comment">** </font>
00011 <font class="comment">** This program is distributed in the hope that it will be useful, but</font>
00012 <font class="comment">** WITHOUT ANY WARRANTY; without even the implied warranty of</font>
00013 <font class="comment">** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</font>
00014 <font class="comment">** General Public License for more details.</font>
00015 <font class="comment">** </font>
00016 <font class="comment">** The GNU General Public License is available from http://www.gnu.org/ or</font>
00017 <font class="comment">** the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston,</font>
00018 <font class="comment">** MA 02111-1307, USA.</font>
00019 <font class="comment">**</font>
00020 <font class="comment">** For information on lclint: lclint-request@cs.virginia.edu</font>
00021 <font class="comment">** To report a bug: lclint-bug@cs.virginia.edu</font>
00022 <font class="comment">** For more information: http://lclint.cs.virginia.edu</font>
00023 <font class="comment">*/</font>
00024 <font class="comment">/*</font>
00025 <font class="comment">** hashTable.c</font>
00026 <font class="comment">**</font>
00027 <font class="comment">** Since hsearch defined in &lt;search.h&gt; only allows one hash table,</font>
00028 <font class="comment">** I'll implement my own.</font>
00029 <font class="comment">**</font>
00030 <font class="comment">** Try to find a decent hash function, etc. later...</font>
00031 <font class="comment">**</font>
00032 <font class="comment">** hashTable is from string -&gt; unsigned</font>
00033 <font class="comment">**</font>
00034 <font class="comment">*/</font>
00035 
00036 <font class="preprocessor"># include "lclintMacros.nf"</font>
00037 <font class="preprocessor"># include "basic.h"</font>
00038 
00039 <font class="comment">/*@constant null hbucket hbucket_undefined; @*/</font>
<a name="l00040"></a><a class="code" href="hashTable_c.html#a0">00040</a> <font class="preprocessor"># define hbucket_undefined 0</font>
00041 <font class="preprocessor"></font>
00042 <font class="keyword">static</font> <font class="comment">/*@truenull@*/</font> <font class="keywordtype">bool</font> hbucket_isNull (<font class="comment">/*@null@*/</font> hbucket h)<font class="keyword"> </font>
00043 <font class="keyword"></font>{ 
00044   <font class="keywordflow">return</font> (h == hbucket_undefined); 
00045 }
00046 
00047 <font class="keyword">static</font> hentry
00048 hentry_create (cstring key, <font class="keywordtype">int</font> val)<font class="keyword"></font>
00049 <font class="keyword"></font>{
00050   hentry h;
00051 
00052   h.key = key;
00053   h.val = val;
00054   <font class="keywordflow">return</font> (h);
00055 }
00056 
00057 <font class="keyword">static</font> <font class="keywordtype">bool</font>
00058 hbucket_isEmpty (hbucket h)<font class="keyword"></font>
00059 <font class="keyword"></font>{
00060   <font class="keywordflow">return</font> (h == hbucket_undefined || h-&gt;size == 0);
00061 }
00062 
00063 <font class="keyword">static</font> cstring
00064 hbucket_unparse (hbucket h)<font class="keyword"></font>
00065 <font class="keyword"></font>{
00066   cstring s = cstring_undefined;
00067 
00068   <font class="keywordflow">if</font> (!hbucket_isNull (h))
00069     {
00070       <font class="keywordtype">int</font> i;
00071       
00072       <font class="keywordflow">for</font> (i = 0; i &lt; h-&gt;size; i++)
00073         {
00074           s = <a class="code" href="message_c.html#a18">message</a> (<font class="stringliteral">"%q %s:%d"</font>, s, h-&gt;entries[i].key, h-&gt;entries[i].val);
00075         }
00076     }
00077 
00078   <font class="keywordflow">return</font> s;
00079 }
00080 
00081 <font class="keyword">static</font> hbucket
00082 hbucket_single (hentry e)<font class="keyword"></font>
00083 <font class="keyword"></font>{
00084   hbucket h = (hbucket) dmalloc (<font class="keyword">sizeof</font> (*h));
00085   
00086   h-&gt;size = 1;
00087   h-&gt;nspace = HBUCKET_BASESIZE - 1;
00088   h-&gt;entries = (hentry *) dmalloc (HBUCKET_BASESIZE * <font class="keyword">sizeof</font> (*h-&gt;entries));
00089   h-&gt;entries[0] = e;
00090   
00091   <font class="keywordflow">return</font> (h);
00092 }
00093 
00094 <font class="keyword">static</font> <font class="keywordtype">void</font>
00095 hbucket_grow (<font class="comment">/*@notnull@*/</font> hbucket h)<font class="keyword"></font>
00096 <font class="keyword"></font>{
00097   <font class="keywordtype">int</font> i;
00098   hentry *newentries; 
00099   
00100   h-&gt;nspace += HBUCKET_BASESIZE;
00101 
00102   newentries = (hentry *) 
00103     dmalloc ((h-&gt;size + HBUCKET_BASESIZE) * <font class="keyword">sizeof</font> (*newentries));
00104   
00105   <font class="keywordflow">for</font> (i = 0; i &lt; h-&gt;size; i++) 
00106     {
00107       newentries[i] = h-&gt;entries[i]; 
00108     }
00109   
00110   <a class="code" href="general_c.html#a0">sfree</a> (h-&gt;entries);
00111   h-&gt;entries = newentries; 
00112 }
00113 
00114 <font class="keyword">static</font> <font class="keywordtype">int</font> hbucket_lookup (hbucket p_h, cstring p_key);
00115 
00116 <font class="comment">/*</font>
00117 <font class="comment">** bizarre duplicate behaviour</font>
00118 <font class="comment">** required for duplicate entries</font>
00119 <font class="comment">*/</font>
00120 
00121 <font class="keyword">static</font> <font class="keywordtype">void</font>
00122 hbucket_add (<font class="comment">/*@notnull@*/</font> hbucket h, hentry e)<font class="keyword"></font>
00123 <font class="keyword"></font>{
00124   <font class="keywordtype">int</font> exloc = hbucket_lookup (h, e.key);
00125 
00126   
00127   <font class="keywordflow">if</font> (exloc != HBUCKET_DNE)
00128     {
00129       h-&gt;entries[exloc].key = e.key;
00130       h-&gt;entries[exloc].val = e.val;
00131       <font class="keywordflow">return</font>;
00132     }
00133 
00134   <font class="keywordflow">if</font> (h-&gt;nspace == 0)
00135     {
00136             hbucket_grow (h);
00137     }
00138 
00139   h-&gt;entries[h-&gt;size] = e;
00140   h-&gt;size++;
00141   h-&gt;nspace--;
00142 }
00143 
00144 <font class="keyword">static</font> <font class="keywordtype">int</font>
00145 hbucket_ncollisions (hbucket h)<font class="keyword"></font>
00146 <font class="keyword"></font>{
00147   <font class="keywordflow">if</font> (!hbucket_isNull (h) &amp;&amp; (h-&gt;size &gt; 1))
00148     <font class="keywordflow">return</font> (h-&gt;size - 1);
00149   <font class="keywordflow">else</font>
00150     <font class="keywordflow">return</font> 0;
00151 }
00152 
00153 <font class="keywordtype">int</font>
00154 hbucket_lookup (hbucket h, cstring key)<font class="keyword"></font>
00155 <font class="keyword"></font>{
00156   <font class="keywordflow">if</font> (!hbucket_isNull (h))
00157     {
00158       <font class="keywordtype">int</font> i;
00159       
00160       <font class="keywordflow">for</font> (i = 0; i &lt; h-&gt;size; i++)
00161         {
00162           <font class="keywordflow">if</font> (<a class="code" href="cstring_c.html#a18">cstring_equal</a> (h-&gt;entries[i].key, key))
00163             {
00164               <font class="keywordflow">return</font> h-&gt;entries[i].val;
00165             }
00166         }
00167     }
00168 
00169   <font class="keywordflow">return</font> HBUCKET_DNE;
00170 }
00171 
00172 <font class="keyword">static</font>
00173 <font class="keywordtype">void</font> hbucket_free (<font class="comment">/*@only@*/</font> hbucket h)<font class="keyword"></font>
00174 <font class="keyword"></font>{
00175   <font class="keywordflow">if</font> (!hbucket_isNull (h))
00176     {
00177       <a class="code" href="general_c.html#a0">sfree</a> (h-&gt;entries);
00178       <a class="code" href="general_c.html#a0">sfree</a> (h);
00179     }
00180 }
00181 
00182 <font class="keywordtype">void</font> 
<a name="l00183"></a><a class="code" href="hashTable_c.html#a12">00183</a> <a class="code" href="hashTable_c.html#a12">hashTable_free</a> (<font class="comment">/*@only@*/</font> hashTable h)<font class="keyword"></font>
00184 <font class="keyword"></font>{
00185   <font class="keywordtype">int</font> i;
00186 
00187   <font class="keywordflow">for</font> (i = 0; i &lt; h-&gt;size; i++)
00188     {
00189       hbucket_free (h-&gt;buckets[i]);
00190     }
00191 
00192   <a class="code" href="general_c.html#a0">sfree</a> (h-&gt;buckets);
00193   <a class="code" href="general_c.html#a0">sfree</a> (h);
00194 }
00195   
00196 <font class="keyword">static</font> <font class="keywordtype">int</font>
00197 hashTable_countCollisions (hashTable h)<font class="keyword"></font>
00198 <font class="keyword"></font>{
00199   <font class="keywordtype">int</font> nc = 0;
00200   <font class="keywordtype">int</font> i;
00201 
00202   <font class="keywordflow">for</font> (i = 0; i &lt; h-&gt;size; i++)
00203     {
00204       nc += hbucket_ncollisions (h-&gt;buckets[i]);
00205     }
00206 
00207   <font class="keywordflow">return</font> (nc);
00208 }
00209 
00210 
00211 <font class="keyword">static</font> <font class="keywordtype">int</font>
00212 hashTable_countEmpty (hashTable h)<font class="keyword"></font>
00213 <font class="keyword"></font>{
00214   <font class="keywordtype">int</font> nc = 0;
00215   <font class="keywordtype">int</font> i;
00216 
00217   <font class="keywordflow">for</font> (i = 0; i &lt; h-&gt;size; i++)
00218     {
00219       <font class="keywordflow">if</font> (hbucket_isEmpty (h-&gt;buckets[i]))
00220         {
00221           nc++;
00222         }
00223     }
00224 
00225   <font class="keywordflow">return</font> (nc);
00226 }
00227 
00228 <font class="comment">/*</font>
00229 <font class="comment">** hash function snarfed from quake/hash.c Hash_String</font>
00230 <font class="comment">** by Stephen Harrison</font>
00231 <font class="comment">*/</font>
00232 
00233 <font class="comment">/*</font>
00234 <font class="comment"> * Here are 256 random numbers for use in the hash function</font>
00235 <font class="comment"> */</font>
00236 
00237 <font class="comment">/*@+ignoresigns@*/</font>
00238 <font class="keyword">static</font> <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> RandomNumbers[256] =
00239 {
00240 <font class="preprocessor">#include "256_random_numbers.nf"</font>
00241 };
00242 <font class="comment">/*@=ignoresigns@*/</font>
00243 
00244 <font class="keyword">static</font> <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> 
00245 hashTable_hashValue (hashTable h, cstring key)<font class="keyword"></font>
00246 <font class="keyword"></font>{
00247   <font class="keywordtype">char</font> *p;
00248   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> hash_value = 0;
00249 
00250   <font class="keywordflow">for</font> (p = <a class="code" href="cstring_c.html#a29">cstring_toCharsSafe</a> (key); *p != <font class="charliteral">'\0'</font>; p++)
00251     {
00252       hash_value = (hash_value &lt;&lt; 1) ^ RandomNumbers[*p % 256];
00253     }
00254 
00255   <font class="keywordflow">return</font> (hash_value % h-&gt;size);
00256 }
00257 
00258 <font class="keyword">static</font> <font class="comment">/*@exposed@*/</font> hbucket
00259 hashTable_hash (hashTable h, cstring key)<font class="keyword"></font>
00260 <font class="keyword"></font>{
00261   <font class="keywordflow">return</font> h-&gt;buckets[hashTable_hashValue (h, key)];
00262 }
00263 
00264 
00265 <font class="comment">/*@only@*/</font> hashTable
<a name="l00266"></a><a class="code" href="hashTable_c.html#a17">00266</a> <a class="code" href="hashTable_c.html#a17">hashTable_create</a> (<font class="keywordtype">int</font> size)<font class="keyword"></font>
00267 <font class="keyword"></font>{
00268   <font class="keywordtype">int</font> i;
00269   hashTable h = (hashTable) dmalloc (<font class="keyword">sizeof</font> (*h));
00270   
00271   h-&gt;size = size;
00272   h-&gt;nentries = 0;
00273   h-&gt;buckets = (hbucket *) dmalloc (<font class="keyword">sizeof</font> (*h-&gt;buckets) * size);
00274   
00275   <font class="comment">/*@+loopexec@*/</font>
00276   <font class="keywordflow">for</font> (i = 0; i &lt; size; i++)
00277     {
00278       h-&gt;buckets[i] = hbucket_undefined;
00279     }
00280   <font class="comment">/*@-loopexec@*/</font>
00281   <font class="keywordflow">return</font> h;
00282 }
00283 
00284 <font class="comment">/*@-mustfree@*/</font>
00285 <font class="keyword">static</font> <font class="comment">/*@unused@*/</font> <font class="keywordtype">void</font>
00286 hashTable_print (hashTable h)<font class="keyword"></font>
00287 <font class="keyword"></font>{
00288   <font class="keywordtype">int</font> i;
00289 
00290   <font class="keywordflow">for</font> (i = 0; i &lt; h-&gt;size; i++)
00291     {
00292       hbucket hb = h-&gt;buckets[i];
00293 
00294       <font class="keywordflow">if</font> (hb != NULL)
00295         {
00296           <a class="code" href="llerror_c.html#a21">llmsg</a> (message (<font class="stringliteral">"%d. %s\n"</font>, i, hbucket_unparse (hb)));
00297         }
00298     }
00299 
00300   <a class="code" href="llerror_c.html#a21">llmsg</a> (message (<font class="stringliteral">"size: %d, collisions: %d, empty: %d"</font>, 
00301                   h-&gt;size, 
00302                   hashTable_countCollisions (h),
00303                   hashTable_countEmpty (h)));
00304 }
00305 <font class="comment">/*@=mustfree@*/</font>
00306 
00307 <font class="comment">/*@only@*/</font> cstring
<a name="l00308"></a><a class="code" href="hashTable_c.html#a19">00308</a> <a class="code" href="hashTable_c.html#a19">hashTable_stats</a> (hashTable h)<font class="keyword"></font>
00309 <font class="keyword"></font>{
00310   <font class="keywordflow">return</font> (<a class="code" href="message_c.html#a18">message</a> (<font class="stringliteral">"size: %d, collisions: %d, empty: %d\n"</font>, 
00311                         h-&gt;size, hashTable_countCollisions (h),
00312                         hashTable_countEmpty (h)));
00313 }
00314 
00315 <font class="keyword">static</font> <font class="keywordtype">void</font>
00316 hashTable_addEntry (hashTable h, hentry e)<font class="keyword"></font>
00317 <font class="keyword"></font>{
00318   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> hindex = hashTable_hashValue (h, e.key);
00319   <font class="comment">/*</font>
00320 <font class="comment">  ** using</font>
00321 <font class="comment">  **   hbucket hb = h-&gt;buckets[hindex];  </font>
00322 <font class="comment">  ** instead reveals a bug I don't want to deal with right now!</font>
00323 <font class="comment">  */</font>
00324 
00325   h-&gt;nentries++;
00326   
00327   <font class="keywordflow">if</font> (hbucket_isNull (h-&gt;buckets[hindex]))
00328     {
00329       h-&gt;buckets[hindex] = hbucket_single (e); 
00330     }
00331   <font class="keywordflow">else</font>
00332     {
00333       hbucket_add (h-&gt;buckets[hindex], e);
00334     }
00335 }
00336 
00337 <font class="keywordtype">void</font>
<a name="l00338"></a><a class="code" href="hashTable_c.html#a21">00338</a> <a class="code" href="hashTable_c.html#a21">hashTable_insert</a> (hashTable h, cstring key, <font class="keywordtype">int</font> value)<font class="keyword"></font>
00339 <font class="keyword"></font>{
00340   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> hindex;
00341   hbucket hb;
00342   hentry e;  
00343 
00344   
00345   h-&gt;nentries++;
00346 
00347   <font class="comment">/*</font>
00348 <font class="comment">  ** rehashing based (loosely) on code by Steve Harrison</font>
00349 <font class="comment">  */</font>
00350 
00351   <font class="keywordflow">if</font> (h-&gt;nentries * 162 &gt; h-&gt;size * 100) 
00352     {
00353       <font class="keywordtype">int</font> i;
00354       <font class="keywordtype">int</font> oldsize = h-&gt;size;
00355       <font class="keywordtype">int</font> newsize = 1 + ((oldsize * 26244) / 10000); <font class="comment">/* 26244 = 162^2 */</font>
00356       hbucket *oldbuckets = h-&gt;buckets;
00357 
00358       
00359       h-&gt;size = newsize;  
00360       h-&gt;nentries = 0;
00361       h-&gt;buckets = (hbucket *) dmalloc (<font class="keyword">sizeof</font> (*h-&gt;buckets) * newsize);
00362 
00363       <font class="comment">/*@+loopexec@*/</font>
00364       <font class="keywordflow">for</font> (i = 0; i &lt; newsize; i++)
00365         {
00366           h-&gt;buckets[i] = hbucket_undefined;
00367         }
00368       <font class="comment">/*@=loopexec@*/</font>
00369       
00370       <font class="keywordflow">for</font> (i = 0; i &lt; oldsize; i++)
00371         {
00372           hbucket bucket = oldbuckets[i];
00373           
00374           <font class="keywordflow">if</font> (!hbucket_isNull (bucket))
00375             {
00376               <font class="keywordtype">int</font> j;
00377 
00378               <font class="keywordflow">for</font> (j = 0; j &lt; bucket-&gt;size; j++)
00379                 {
00380                   hashTable_addEntry (h, bucket-&gt;entries[j]);
00381                 }
00382 
00383               <a class="code" href="general_c.html#a0">sfree</a> (bucket);
00384             }
00385         }
00386 
00387       <a class="code" href="general_c.html#a0">sfree</a> (oldbuckets);
00388     }
00389 
00390   
00391   e = hentry_create (key, value);
00392   hindex = hashTable_hashValue (h, key);
00393   hb = h-&gt;buckets[hindex];
00394   
00395   <font class="keywordflow">if</font> (hbucket_isNull (hb))
00396     {
00397             h-&gt;buckets[hindex] = hbucket_single (e);
00398     }
00399   <font class="keywordflow">else</font>
00400     {
00401             hbucket_add (hb, e);
00402     }
00403 
00404   }
00405 
00406 <font class="keywordtype">int</font>
<a name="l00407"></a><a class="code" href="hashTable_c.html#a22">00407</a> <a class="code" href="hashTable_c.html#a22">hashTable_lookup</a> (hashTable h, cstring key)<font class="keyword"></font>
00408 <font class="keyword"></font>{
00409   hbucket hb = hashTable_hash (h, key);
00410 
00411   <font class="keywordflow">return</font> (hbucket_lookup (hb, key));
00412 }
00413 
00414 <font class="comment">/*</font>
00415 <font class="comment">** This is needed if oldkey is going to be released.</font>
00416 <font class="comment">*/</font>
00417 
00418 <font class="keywordtype">void</font>
<a name="l00419"></a><a class="code" href="hashTable_c.html#a23">00419</a> <a class="code" href="hashTable_c.html#a23">hashTable_replaceKey</a> (hashTable h, cstring oldkey, <font class="comment">/*@dependent@*/</font> cstring newkey)<font class="keyword"></font>
00420 <font class="keyword"></font>{
00421   hbucket hb = hashTable_hash (h, oldkey);
00422 
00423   llassert (cstring_equal (oldkey, newkey));
00424 
00425   <font class="keywordflow">if</font> (!hbucket_isNull (hb))
00426     {
00427       <font class="keywordtype">int</font> i;
00428       
00429       <font class="keywordflow">for</font> (i = 0; i &lt; hb-&gt;size; i++)
00430         {
00431           <font class="keywordflow">if</font> (<a class="code" href="cstring_c.html#a18">cstring_equal</a> (hb-&gt;entries[i].key, oldkey))
00432             {
00433               hb-&gt;entries[i].key = newkey;
00434               <font class="keywordflow">return</font>;
00435             }
00436         }
00437     }
00438 
00439   llbug (message (<font class="stringliteral">"hashTable_replaceKey: %s not found"</font>, oldkey));
00440 }
00441 
00442 <font class="keywordtype">void</font>
<a name="l00443"></a><a class="code" href="hashTable_c.html#a24">00443</a> <a class="code" href="hashTable_c.html#a24">hashTable_remove</a> (hashTable h, cstring key)<font class="keyword"></font>
00444 <font class="keyword"></font>{
00445   hbucket hb = hashTable_hash (h, key);
00446 
00447   <font class="keywordflow">if</font> (!hbucket_isNull (hb))
00448     {
00449       <font class="keywordtype">int</font> i;
00450       
00451       <font class="keywordflow">for</font> (i = 0; i &lt; hb-&gt;size; i++)
00452         {
00453           <font class="keywordflow">if</font> (<a class="code" href="cstring_c.html#a18">cstring_equal</a> (hb-&gt;entries[i].key, key))
00454             {
00455               <font class="keywordflow">if</font> (i &lt; hb-&gt;size - 1)
00456                 {
00457                   hb-&gt;entries[i] = hb-&gt;entries[hb-&gt;size - 1];
00458                 }
00459               
00460               hb-&gt;size--;
00461               <font class="keywordflow">return</font>;
00462             }
00463         }
00464     }
00465 
00466   llbug (message (<font class="stringliteral">"hashTable_removeKey: %s not found"</font>, key));
00467 }
00468 
00469 
</div></pre><hr><address><small>Generated at Fri Nov 3 18:57:41 2000 for LCLint by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.3 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2000</small></address>
</body>
</html>
