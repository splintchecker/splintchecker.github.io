<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>macrocache.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.3 on Fri Nov 3 18:57:43 2000 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>macrocache.c</h1><a href="macrocache_c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">** LCLint - annotation-assisted static program checker</font>
00003 <font class="comment">** Copyright (C) 1994-2000 University of Virginia,</font>
00004 <font class="comment">**         Massachusetts Institute of Technology</font>
00005 <font class="comment">**</font>
00006 <font class="comment">** This program is free software; you can redistribute it and/or modify it</font>
00007 <font class="comment">** under the terms of the GNU General Public License as published by the</font>
00008 <font class="comment">** Free Software Foundation; either version 2 of the License, or (at your</font>
00009 <font class="comment">** option) any later version.</font>
00010 <font class="comment">** </font>
00011 <font class="comment">** This program is distributed in the hope that it will be useful, but</font>
00012 <font class="comment">** WITHOUT ANY WARRANTY; without even the implied warranty of</font>
00013 <font class="comment">** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</font>
00014 <font class="comment">** General Public License for more details.</font>
00015 <font class="comment">** </font>
00016 <font class="comment">** The GNU General Public License is available from http://www.gnu.org/ or</font>
00017 <font class="comment">** the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston,</font>
00018 <font class="comment">** MA 02111-1307, USA.</font>
00019 <font class="comment">**</font>
00020 <font class="comment">** For information on lclint: lclint-request@cs.virginia.edu</font>
00021 <font class="comment">** To report a bug: lclint-bug@cs.virginia.edu</font>
00022 <font class="comment">** For more information: http://lclint.cs.virginia.edu</font>
00023 <font class="comment">*/</font>
00024 <font class="comment">/*</font>
00025 <font class="comment">** macrocache.c</font>
00026 <font class="comment">**</font>
00027 <font class="comment">** rep Invariant:</font>
00028 <font class="comment">**     no two fileloc's may be equal</font>
00029 <font class="comment">**</font>
00030 <font class="comment">*/</font>
00031 
00032 <font class="preprocessor"># include "lclintMacros.nf"</font>
00033 <font class="preprocessor"># include "llbasic.h"</font>
00034 <font class="preprocessor"># include "llmain.h"</font>
00035 
00036 <font class="comment">/*@constant int MCEBASESIZE;@*/</font>
<a name="l00037"></a><a class="code" href="macrocache_c.html#a0">00037</a> <font class="preprocessor"># define MCEBASESIZE 8</font>
00038 <font class="preprocessor"></font>
00039 <font class="comment">/*@constant int DNE;@*/</font>
<a name="l00040"></a><a class="code" href="macrocache_c.html#a1">00040</a> <font class="preprocessor"># define DNE -1</font>
00041 <font class="preprocessor"></font>
00042 <font class="comment">/*</font>
00043 <font class="comment">** Temporary file used for processing macros.</font>
00044 <font class="comment">*/</font>
00045 
00046 <font class="keyword">static</font> <font class="comment">/*@null@*/</font> FILE *s_macFile = NULL;
00047 
00048 <font class="comment">/*</font>
00049 <font class="comment">** mcDisable is set to TRUE when a macro is being processed, so</font>
00050 <font class="comment">** its contents are not added to the macrocache again, creating</font>
00051 <font class="comment">** a nasty infinite loop.</font>
00052 <font class="comment">*/</font>
00053 
00054 <font class="keyword">static</font> <font class="keywordtype">bool</font> mcDisable = TRUE;
00055 <font class="keyword">static</font> <font class="keywordtype">void</font> macrocache_grow (macrocache p_s);
00056 <font class="keyword">static</font> <font class="keywordtype">int</font> macrocache_exists (macrocache p_s, fileloc p_fl);
00057 <font class="keyword">static</font> <font class="keywordtype">void</font> macrocache_processMacro (macrocache p_m, <font class="keywordtype">int</font> p_i);
00058 
00059 <font class="keyword">static</font> <font class="comment">/*@only@*/</font> mce
00060   mce_create (<font class="comment">/*@only@*/</font> fileloc fl, <font class="comment">/*@only@*/</font> cstring def, <font class="keywordtype">bool</font> comment)<font class="keyword"></font>
00061 <font class="keyword"></font>{
00062   mce m = (mce) dmalloc (<font class="keyword">sizeof</font> (*m));
00063   m-&gt;fl = fl;
00064   m-&gt;def = def; <font class="comment">/*&lt; had a copy here! check this carefully */</font>
00065   m-&gt;defined = FALSE;
00066   m-&gt;scomment = comment;
00067   <font class="keywordflow">return</font> m;
00068 }
00069 
00070 <font class="keyword">static</font> <font class="keywordtype">void</font> mce_free (<font class="comment">/*@only@*/</font> mce m)<font class="keyword"></font>
00071 <font class="keyword"></font>{
00072   <a class="code" href="fileloc_c.html#a8">fileloc_free</a> (m-&gt;fl);
00073   <a class="code" href="cstring_c.html#a27">cstring_free</a> (m-&gt;def);
00074   <a class="code" href="general_c.html#a0">sfree</a> (m);
00075 }
00076 
00077 <font class="comment">/*@only@*/</font> macrocache
<a name="l00078"></a><a class="code" href="macrocache_c.html#a11">00078</a> <a class="code" href="macrocache_c.html#a11">macrocache_create</a> (<font class="keywordtype">void</font>)<font class="keyword"></font>
00079 <font class="keyword"></font>{
00080   macrocache s = (macrocache) dmalloc (<font class="keyword">sizeof</font> (*s));
00081 
00082   s-&gt;entries = 0;
00083   s-&gt;nspace = MCEBASESIZE;
00084   s-&gt;contents = (mce *) dmalloc (<font class="keyword">sizeof</font> (*s-&gt;contents) * MCEBASESIZE);
00085 
00086   mcDisable = FALSE;
00087 
00088   <font class="keywordflow">return</font> (s);
00089 }
00090 
00091 <font class="keywordtype">void</font>
<a name="l00092"></a><a class="code" href="macrocache_c.html#a12">00092</a> <a class="code" href="macrocache_c.html#a12">macrocache_free</a> (macrocache s)<font class="keyword"></font>
00093 <font class="keyword"></font>{
00094   <font class="keywordtype">int</font> i;
00095 
00096   llassert (s_macFile == NULL);
00097 
00098   <font class="keywordflow">for</font> (i = 0; i &lt; s-&gt;entries; i++)
00099     {
00100       mce_free (s-&gt;contents[i]);
00101     }
00102 
00103   <a class="code" href="general_c.html#a0">sfree</a> (s-&gt;contents);
00104   <a class="code" href="general_c.html#a0">sfree</a> (s);
00105 }
00106 
00107 <font class="keyword">static</font> <font class="keywordtype">void</font>
00108 macrocache_grow (macrocache s)<font class="keyword"></font>
00109 <font class="keyword"></font>{
00110   <font class="keywordtype">int</font> i;
00111   o_mce *oldcontents = s-&gt;contents;
00112 
00113   s-&gt;nspace = MCEBASESIZE;
00114   s-&gt;contents = (mce *) dmalloc (<font class="keyword">sizeof</font> (*s-&gt;contents) * (s-&gt;entries + s-&gt;nspace)); 
00115 
00116   <font class="keywordflow">for</font> (i = 0; i &lt; s-&gt;entries; i++)
00117     {
00118       s-&gt;contents[i] = oldcontents[i];
00119     }
00120 
00121   <a class="code" href="general_c.html#a0">sfree</a> (oldcontents);
00122 }
00123 
00124 <font class="keyword">static</font> <font class="keywordtype">void</font>
00125 macrocache_addGenEntry (macrocache s, <font class="comment">/*@only@*/</font> fileloc fl,
00126                         <font class="comment">/*@only@*/</font> cstring def, <font class="keywordtype">bool</font> sup)<font class="keyword"></font>
00127 <font class="keyword"></font>{
00128   <font class="keywordtype">int</font> i;
00129 
00130   <font class="keywordflow">if</font> (mcDisable)
00131     {
00132       <a class="code" href="fileloc_c.html#a8">fileloc_free</a> (fl);
00133       <a class="code" href="cstring_c.html#a27">cstring_free</a> (def);
00134       <font class="keywordflow">return</font>;
00135     }
00136 
00137   <font class="keywordflow">if</font> ((i = macrocache_exists (s, fl)) != DNE)
00138     {
00139       <font class="keywordflow">if</font> (<a class="code" href="cstring_c.html#a18">cstring_equal</a> (def, s-&gt;contents[i]-&gt;def))
00140         {
00141           <a class="code" href="fileloc_c.html#a8">fileloc_free</a> (fl);
00142           <a class="code" href="cstring_c.html#a27">cstring_free</a> (def);
00143 
00144           <font class="keywordflow">return</font>;
00145         }
00146       <font class="keywordflow">else</font>
00147         {
00148           <font class="comment">/*</font>
00149 <font class="comment">          ** macro definition contained macro that is expanded</font>
00150 <font class="comment">          ** replace with def</font>
00151 <font class="comment">          **</font>
00152 <font class="comment">          ** how do we know which is better??</font>
00153 <font class="comment">          */</font>
00154           
00155           <a class="code" href="cstring_c.html#a27">cstring_free</a> (s-&gt;contents[i]-&gt;def);
00156           s-&gt;contents[i]-&gt;def = def;
00157 
00158           <a class="code" href="fileloc_c.html#a8">fileloc_free</a> (fl);
00159           <font class="keywordflow">return</font>;
00160         }
00161     }
00162 
00163   <font class="keywordflow">if</font> (s-&gt;nspace &lt;= 0) {
00164     macrocache_grow (s);
00165   }
00166 
00167   s-&gt;nspace--;
00168   s-&gt;contents[s-&gt;entries] = mce_create (fl, def, sup);
00169   s-&gt;entries++;
00170 }
00171 
00172 <font class="keywordtype">void</font>
<a name="l00173"></a><a class="code" href="macrocache_c.html#a14">00173</a> <a class="code" href="macrocache_c.html#a14">macrocache_addEntry</a> (macrocache s, <font class="comment">/*@only@*/</font> fileloc fl, <font class="comment">/*@only@*/</font> cstring def)<font class="keyword"></font>
00174 <font class="keyword"></font>{
00175   macrocache_addGenEntry (s, fl, def, FALSE);
00176 }
00177 
00178 
00179 <font class="keywordtype">void</font>
<a name="l00180"></a><a class="code" href="macrocache_c.html#a15">00180</a> <a class="code" href="macrocache_c.html#a15">macrocache_addComment</a> (macrocache s, <font class="comment">/*@only@*/</font> fileloc fl, <font class="comment">/*@only@*/</font> cstring def)<font class="keyword"></font>
00181 <font class="keyword"></font>{
00182   macrocache_addGenEntry (s, fl, def, TRUE);
00183 }
00184 
00185 <font class="keyword">static</font> <font class="keywordtype">int</font>
00186 macrocache_exists (macrocache s, fileloc fl)<font class="keyword"></font>
00187 <font class="keyword"></font>{
00188   <font class="keywordtype">int</font> i;
00189 
00190   <font class="keywordflow">for</font> (i = 0; i &lt; s-&gt;entries; i++)
00191     {
00192       <font class="keywordflow">if</font> (<a class="code" href="fileloc_c.html#a11">fileloc_equal</a> (s-&gt;contents[i]-&gt;fl, fl))
00193         <font class="keywordflow">return</font> (i);
00194     }
00195 
00196   <font class="keywordflow">return</font> (DNE);
00197 }
00198 
00199 <font class="comment">/*@only@*/</font> cstring
<a name="l00200"></a><a class="code" href="macrocache_c.html#a16">00200</a> <a class="code" href="macrocache_c.html#a16">macrocache_unparse</a> (macrocache m)<font class="keyword"></font>
00201 <font class="keyword"></font>{
00202   cstring s = cstring_undefined;
00203   <font class="keywordtype">int</font> i;
00204 
00205   <font class="keywordflow">for</font> (i = 0; i &lt; m-&gt;entries; i++)
00206     {
00207       fileloc fl = m-&gt;contents[i]-&gt;fl;
00208       cstring def = m-&gt;contents[i]-&gt;def;
00209       <font class="keywordtype">bool</font> defined = m-&gt;contents[i]-&gt;defined;
00210       
00211       s = <a class="code" href="message_c.html#a18">message</a> (<font class="stringliteral">"%q%q: %s [%s]\n"</font>, s, fileloc_unparse (fl), def, 
00212                    bool_unparse (defined));
00213     }
00214   
00215   <font class="keywordflow">return</font> (s);
00216 }
00217 
00218 <font class="comment">/*</font>
00219 <font class="comment">** needs to call lex by hand...yuk!</font>
00220 <font class="comment">**</font>
00221 <font class="comment">** modifies gc fileloc!</font>
00222 <font class="comment">*/</font>
00223 
00224 <font class="comment">/*</font>
00225 <font class="comment">** there's gotta be a better way of doing this!</font>
00226 <font class="comment">*/</font>
00227 
00228 <font class="keyword">static</font> <font class="keywordtype">void</font> pushString (<font class="comment">/*@only@*/</font> cstring s)<font class="keyword"></font>
00229 <font class="keyword"></font>{
00230   <font class="keyword">static</font> fileId mtid = fileId_invalid;
00231   <font class="keywordtype">long</font> floc;
00232 
00233   <font class="keywordflow">if</font> (s_macFile == NULL)
00234     {
00235       cstring fname;
00236       mtid = <a class="code" href="fileTable_c.html#a23">fileTable_addMacrosFile</a> (context_fileTable ());
00237       
00238       fname = fileName (mtid);
00239       s_macFile = fopen (cstring_toCharsSafe (fname), <font class="stringliteral">"wb+"</font>);
00240       
00241       <font class="keywordflow">if</font> (s_macFile == NULL)
00242         {
00243           llcontbug (message (<font class="stringliteral">"Cannot open tmp file %s needed to process macro: %s"</font>, 
00244                               fname, s));
00245           <a class="code" href="cstring_c.html#a27">cstring_free</a> (s);
00246           <font class="keywordflow">return</font>;
00247         }
00248     }
00249 
00250   llassert (s_macFile != NULL);
00251 
00252   <font class="comment">/* SunOS, others? don't define SEEK_CUR and SEEK_SET */</font>
00253 <font class="preprocessor"># ifndef SEEK_CUR </font>
00254 <font class="preprocessor"></font><font class="preprocessor"># define SEEK_CUR 1</font>
00255 <font class="preprocessor"></font><font class="preprocessor"># endif</font>
00256 <font class="preprocessor"></font>  check (fseek (s_macFile, 0, SEEK_CUR) == 0);
00257 
00258   floc = ftell (s_macFile);
00259 
00260   <font class="keywordflow">if</font> (<a class="code" href="cstring_c.html#a30">cstring_length</a> (s) &gt; 0) {
00261     check (fputs (cstring_toCharsSafe (s), s_macFile) != EOF);
00262   }
00263 
00264   check (fputc (<font class="charliteral">'\n'</font>, s_macFile) == (<font class="keywordtype">int</font>) <font class="charliteral">'\n'</font>);
00265 
00266 <font class="preprocessor"># ifndef SEEK_SET </font>
00267 <font class="preprocessor"></font><font class="preprocessor"># define SEEK_SET 0</font>
00268 <font class="preprocessor"></font><font class="preprocessor"># endif</font>
00269 <font class="preprocessor"></font>  check (fseek (s_macFile, floc, SEEK_SET) == 0);
00270 
00271   yyin = s_macFile;
00272   (<font class="keywordtype">void</font>) yyrestart (yyin);
00273   <a class="code" href="cstring_c.html#a27">cstring_free</a> (s);
00274 }
00275 
00276 <font class="keyword">static</font> <font class="keywordtype">void</font>
00277 macrocache_processMacro (macrocache m, <font class="keywordtype">int</font> i)<font class="keyword"></font>
00278 <font class="keyword"></font>{
00279   fileloc fl = m-&gt;contents[i]-&gt;fl;
00280    
00281   m-&gt;contents[i]-&gt;defined = TRUE;
00282 
00283   <font class="keywordflow">if</font> (!fileId_equal (currentFile (), fileloc_fileId (fl)))
00284     {
00285       g_currentloc = <a class="code" href="fileloc_c.html#a6">fileloc_update</a> (g_currentloc, fl);
00286       <a class="code" href="context_c.html#a173">context_enterMacroFile</a> ();
00287     }
00288   <font class="keywordflow">else</font>
00289     {
00290       setLine (fileloc_lineno (fl));
00291     }
00292 
00293   beginLine ();
00294 
00295   DPRINTF ((<font class="stringliteral">"Process macro: %s"</font>, m-&gt;contents[i]-&gt;def));
00296 
00297   <font class="keywordflow">if</font> (m-&gt;contents[i]-&gt;scomment)
00298     {
00299       pushString (message (<font class="stringliteral">"%s%s%s"</font>, 
00300                            cstring_fromChars (BEFORE_COMMENT_MARKER),
00301                            m-&gt;contents[i]-&gt;def,
00302                            <a class="code" href="cstring_c.html#a28">cstring_fromChars</a> (AFTER_COMMENT_MARKER)));
00303       (<font class="keywordtype">void</font>) <a class="code" href="llgrammar_tab_c.html#a1">yyparse</a> ();
00304     }
00305   <font class="keywordflow">else</font>
00306     {
00307       <font class="keywordtype">bool</font> insup = <a class="code" href="context_c.html#a41">context_inSuppressRegion</a> ();
00308 
00309       pushString (message (<font class="stringliteral">"%s %s"</font>, 
00310                            cstring_makeLiteralTemp (PPMRCODE),
00311                            m-&gt;contents[i]-&gt;def));
00312       (<font class="keywordtype">void</font>) <a class="code" href="llgrammar_tab_c.html#a1">yyparse</a> ();
00313 
00314       <font class="keywordflow">if</font> (<a class="code" href="context_c.html#a41">context_inSuppressRegion</a> () &amp;&amp; !insup)
00315         {
00316           llerrorlit (FLG_SYNTAX, <font class="stringliteral">"Macro ends in ignore region"</font>);
00317         }
00318     }
00319   
00320   incLine ();  
00321   <a class="code" href="context_c.html#a181">context_exitMacroCache</a> ();
00322 }
00323 
<a name="l00324"></a><a class="code" href="macrocache_c.html#a18">00324</a> <font class="keyword">extern</font> <font class="keywordtype">void</font> <a class="code" href="macrocache_c.html#a18">macrocache_processUndefinedElements</a> (macrocache m)<font class="keyword"></font>
00325 <font class="keyword"></font>{
00326   fileloc lastfl = fileloc_undefined;
00327   <font class="keywordtype">int</font> i;
00328  
00329   mcDisable = TRUE;
00330 
00331   DPRINTF ((<font class="stringliteral">"Processing undefined elements"</font>));
00332 
00333   <font class="keywordflow">if</font> (!<a class="code" href="context_c.html#a189">context_getFlag</a> (FLG_PARTIAL))
00334     {
00335       <font class="keywordflow">for</font> (i = 0; i &lt; m-&gt;entries; i++) 
00336         {
00337           <font class="keywordflow">if</font> (m-&gt;contents[i]-&gt;defined)
00338             {
00339               ;
00340             }
00341           <font class="keywordflow">else</font> 
00342             { 
00343               fileloc fl = m-&gt;contents[i]-&gt;fl; 
00344               
00345               <font class="keywordflow">if</font> (fileloc_isDefined (lastfl) &amp;&amp; <a class="code" href="fileloc_c.html#a17">fileloc_sameFile</a> (fl, lastfl)) 
00346                 {
00347                   ;
00348                 }
00349               <font class="keywordflow">else</font>
00350                 {
00351                   <font class="keywordflow">if</font> (<a class="code" href="context_c.html#a189">context_getFlag</a> (FLG_SHOWSCAN))
00352                     {
00353                       <font class="keywordflow">if</font> (!<a class="code" href="fileloc_c.html#a47">fileloc_isLib</a> (fl))
00354                         {
00355                           <a class="code" href="llerror_c.html#a22">lldiagmsg</a> (message (<font class="stringliteral">"&lt; checking macros %s &gt;"</font>, fileloc_filename (fl)));
00356                         }
00357                     }
00358                   
00359                   lastfl = fl;
00360                   <a class="code" href="llerror_c.html#a32">cleanupMessages</a> ();
00361                 }
00362               
00363               macrocache_processMacro (m, i);   
00364             }
00365         }
00366     }
00367 
00368   mcDisable = FALSE;
00369 }
00370 
<a name="l00371"></a><a class="code" href="macrocache_c.html#a19">00371</a> <font class="keyword">extern</font> <font class="comment">/*@observer@*/</font> fileloc <a class="code" href="macrocache_c.html#a19">macrocache_processFileElements</a> (macrocache m, cstring base)<font class="keyword"></font>
00372 <font class="keyword"></font>{
00373   fileloc lastfl = fileloc_undefined;
00374   <font class="keywordtype">int</font> i;
00375  
00376   mcDisable = TRUE;
00377 
00378   <font class="keywordflow">for</font> (i = 0; i &lt; m-&gt;entries; i++) 
00379     {
00380       <font class="keywordflow">if</font> (m-&gt;contents[i]-&gt;defined)
00381         {
00382           ;
00383         }
00384       <font class="keywordflow">else</font> 
00385         { 
00386           fileloc fl = m-&gt;contents[i]-&gt;fl;  <font class="comment">/* should be dependent! */</font>
00387           cstring fb = <a class="code" href="fileloc_c.html#a10">fileloc_getBase</a> (fl);
00388 
00389           <font class="keywordflow">if</font> (<a class="code" href="cstring_c.html#a18">cstring_equal</a> (fb, base))
00390             {
00391               lastfl = fl;
00392               macrocache_processMacro (m, i);   
00393             }
00394         }
00395     }
00396 
00397   mcDisable = FALSE;
00398   <font class="keywordflow">return</font> lastfl;
00399 }
00400 
<a name="l00401"></a><a class="code" href="macrocache_c.html#a20">00401</a> <font class="keywordtype">void</font> <a class="code" href="macrocache_c.html#a20">macrocache_finalize</a> (<font class="keywordtype">void</font>)<font class="keyword"></font>
00402 <font class="keyword"></font>{
00403   <font class="keywordflow">if</font> (s_macFile != NULL)
00404     {
00405       check (fclose (s_macFile) == 0);
00406       s_macFile = NULL;
00407     }
00408 }
</div></pre><hr><address><small>Generated at Fri Nov 3 18:57:43 2000 for LCLint by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.3 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2000</small></address>
</body>
</html>
