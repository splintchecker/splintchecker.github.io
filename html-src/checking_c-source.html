<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>checking.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.3 on Fri Nov 3 18:57:39 2000 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>checking.c</h1><a href="checking_c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">** LCLint - annotation-assisted static program checker</font>
00003 <font class="comment">** Copyright (C) 1994-2000 University of Virginia,</font>
00004 <font class="comment">**         Massachusetts Institute of Technology</font>
00005 <font class="comment">**</font>
00006 <font class="comment">** This program is free software; you can redistribute it and/or modify it</font>
00007 <font class="comment">** under the terms of the GNU General Public License as published by the</font>
00008 <font class="comment">** Free Software Foundation; either version 2 of the License, or (at your</font>
00009 <font class="comment">** option) any later version.</font>
00010 <font class="comment">** </font>
00011 <font class="comment">** This program is distributed in the hope that it will be useful, but</font>
00012 <font class="comment">** WITHOUT ANY WARRANTY; without even the implied warranty of</font>
00013 <font class="comment">** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</font>
00014 <font class="comment">** General Public License for more details.</font>
00015 <font class="comment">** </font>
00016 <font class="comment">** The GNU General Public License is available from http://www.gnu.org/ or</font>
00017 <font class="comment">** the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston,</font>
00018 <font class="comment">** MA 02111-1307, USA.</font>
00019 <font class="comment">**</font>
00020 <font class="comment">** For information on lclint: lclint-request@cs.virginia.edu</font>
00021 <font class="comment">** To report a bug: lclint-bug@cs.virginia.edu</font>
00022 <font class="comment">** For more information: http://lclint.cs.virginia.edu</font>
00023 <font class="comment">*/</font>
00024 <font class="comment">/* </font>
00025 <font class="comment">** checking.c</font>
00026 <font class="comment">**</font>
00027 <font class="comment">** sort checking.</font>
00028 <font class="comment">**</font>
00029 <font class="comment">**  AUTHOR:</font>
00030 <font class="comment">**      Yang Meng Tan,</font>
00031 <font class="comment">**         Massachusetts Institute of Technology</font>
00032 <font class="comment">*/</font>
00033 
00034 <font class="preprocessor"># include "lclintMacros.nf"</font>
00035 <font class="preprocessor"># include "llbasic.h"</font>
00036 <font class="preprocessor"># include "llgrammar.h"</font>
00037 <font class="preprocessor"># include "checking.h"</font>
00038 <font class="preprocessor"># include "lclscan.h"</font>
00039 
00040 <font class="comment">/*@+ignorequals@*/</font>
00041 
00042 <font class="keyword">static</font> <font class="comment">/*@only@*/</font> cstring printBadArgs (sortSetList p_args);
00043 <font class="keyword">static</font> <font class="comment">/*@only@*/</font> sortSet 
00044   standardOperators (<font class="comment">/*@null@*/</font> nameNode p_n, sortSetList p_argSorts, sort p_qual);
00045 <font class="keyword">static</font> <font class="keywordtype">bool</font> isStandardOperator (<font class="comment">/*@null@*/</font> nameNode p_n);
00046 <font class="keyword">static</font> <font class="keywordtype">void</font> assignSorts (termNode p_t, sort p_s);
00047 
00048 <font class="comment">/*@null@*/</font> termNode
<a name="l00049"></a><a class="code" href="checking_c.html#a4">00049</a> <a class="code" href="checking_c.html#a4">computePossibleSorts</a> (<font class="comment">/*@returned@*/</font> <font class="comment">/*@null@*/</font> termNode t)<font class="keyword"></font>
00050 <font class="keyword"></font>{
00051   ltoken errtok;
00052 
00053   <font class="keywordflow">if</font> (t != (termNode) 0)
00054     {
00055       <font class="keywordflow">switch</font> (t-&gt;kind)
00056         {
00057         <font class="keywordflow">case</font> TRM_LITERAL:
00058         <font class="keywordflow">case</font> TRM_CONST:
00059         <font class="keywordflow">case</font> TRM_VAR:
00060         <font class="keywordflow">case</font> TRM_ZEROARY:
00061         <font class="keywordflow">case</font> TRM_SIZEOF:
00062         <font class="keywordflow">case</font> TRM_UNCHANGEDALL:
00063         <font class="keywordflow">case</font> TRM_UNCHANGEDOTHERS:
00064         <font class="keywordflow">case</font> TRM_QUANTIFIER:
00065           <font class="keywordflow">break</font>;
00066         <font class="keywordflow">case</font> TRM_APPLICATION:
00067           {
00068             <font class="keywordtype">bool</font> fail = FALSE;
00069             sortSetList argSorts = <a class="code" href="sortSetList_c.html#a0">sortSetList_new</a> ();
00070             lslOpSet ops;
00071             sortSet standards;
00072 
00073             <font class="keywordflow">if</font> (termNodeList_size (t-&gt;args) != 0)
00074               {
00075                 termNodeList_elements (t-&gt;args, arg)<font class="keyword"></font>
00076 <font class="keyword">                </font>{
00077                   (<font class="keywordtype">void</font>) <a class="code" href="checking_c.html#a4">computePossibleSorts</a> (arg);
00078 
00079                   <font class="keywordflow">if</font> (sortSet_size (arg-&gt;possibleSorts) == 0)
00080                     {
00081                       fail = TRUE;
00082                     }
00083                   <font class="keywordflow">else</font>
00084                     {
00085                       <a class="code" href="sortSetList_c.html#a2">sortSetList_addh</a> (argSorts, arg-&gt;possibleSorts);
00086                     } 
00087                 } end_termNodeList_elements;
00088 
00089                 <font class="keywordflow">if</font> (fail)
00090                   {
00091                     <a class="code" href="lslOpSet_c.html#a7">lslOpSet_free</a> (t-&gt;possibleOps);
00092                     <a class="code" href="sortSetList_c.html#a8">sortSetList_free</a> (argSorts);
00093                     t-&gt;possibleOps = <a class="code" href="lslOpSet_c.html#a1">lslOpSet_new</a> ();
00094                     <font class="keywordflow">return</font> t;
00095                   }
00096               }
00097             
00098             ops = <a class="code" href="symtable_c.html#a68">symtable_opsWithLegalDomain</a> (g_symtab, t-&gt;name, argSorts, t-&gt;given);
00099             <a class="code" href="lslOpSet_c.html#a7">lslOpSet_free</a> (t-&gt;possibleOps);
00100             t-&gt;possibleOps = ops;
00101 
00102             lslOpSet_elements (t-&gt;possibleOps, op)<font class="keyword"></font>
00103 <font class="keyword">              </font>{
00104                 sort sort;
00105                 sort = <a class="code" href="abstract_c.html#a224">sigNode_rangeSort</a> (op-&gt;signature);
00106                 (<font class="keywordtype">void</font>) <a class="code" href="sortSet_c.html#a3">sortSet_insert</a> (t-&gt;possibleSorts, sort);
00107               } end_lslOpSet_elements;
00108 
00109             standards = standardOperators (t-&gt;name, argSorts, t-&gt;given);
00110 
00111             sortSet_elements (standards, el)<font class="keyword"></font>
00112 <font class="keyword">              </font>{
00113                 (<font class="keywordtype">void</font>) <a class="code" href="sortSet_c.html#a3">sortSet_insert</a> (t-&gt;possibleSorts, el);
00114               } end_sortSet_elements;
00115 
00116             <a class="code" href="sortSet_c.html#a9">sortSet_free</a> (standards);
00117 
00118             <font class="keywordflow">if</font> (!(t-&gt;error_reported) &amp;&amp; sortSet_size (t-&gt;possibleSorts) == 0)
00119               {
00120                 <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> arity = termNodeList_size (t-&gt;args);
00121                 errtok = <a class="code" href="abstract_c.html#a75">nameNode_errorToken</a> (t-&gt;name);
00122                 
00123                 <font class="comment">/* errorShowPoint (tsource_thisLine (lclsource), ltoken_getCol (errtok)); */</font>
00124                 
00125                 <font class="keywordflow">if</font> (isStandardOperator (t-&gt;name))
00126                   {
00127                     <a class="code" href="llerror_c.html#a54">lclerror</a> (errtok, 
00128                               message (<font class="stringliteral">"Type error: %q not declared for %q"</font>,
00129                                       nameNode_unparse (t-&gt;name), printBadArgs (argSorts)));
00130                   }
00131                 <font class="keywordflow">else</font> <font class="keywordflow">if</font> (t-&gt;name != NULL 
00132                          &amp;&amp; <a class="code" href="symtable_c.html#a66">symtable_opExistsWithArity</a> (g_symtab, t-&gt;name, arity))
00133                   {
00134                     sigNodeSet possibleOps = <a class="code" href="symtable_c.html#a65">symtable_possibleOps</a> (g_symtab, t-&gt;name);
00135                     cstring opName = <a class="code" href="abstract_c.html#a100">nameNode_unparse</a> (t-&gt;name);
00136                     
00137                     <font class="comment">/*</font>
00138 <font class="comment">                    ** all these will be standardOperators soon...</font>
00139 <font class="comment">                    */</font>
00140 
00141                     <font class="keywordflow">if</font> (cstring_equalLit (opName, <font class="stringliteral">"__ [__]"</font>))
00142                       {
00143                         <a class="code" href="llerror_c.html#a54">lclerror</a> (errtok, 
00144                                   message (<font class="stringliteral">"Type error: %q not declared for %q"</font>,
00145                                           opName, printBadArgs (argSorts)));
00146                       }
00147                     <font class="keywordflow">else</font>
00148                       {
00149                         <a class="code" href="llerror_c.html#a54">lclerror</a> (errtok, 
00150                                   message (<font class="stringliteral">"Type error: %q declared: %q\ngiven: %q"</font>,
00151                                           opName, 
00152                                           sigNodeSet_unparseSomeSigs (possibleOps),
00153                                           printBadArgs (argSorts)));
00154                       }
00155                   }
00156                 <font class="keywordflow">else</font>
00157                   {
00158                     sigNodeSet possibleOps;
00159                     <font class="keywordtype">int</font> npossibleOps;
00160 
00161                     llassert (t-&gt;name != NULL);
00162 
00163                     possibleOps = <a class="code" href="symtable_c.html#a65">symtable_possibleOps</a> (g_symtab, t-&gt;name);
00164                     npossibleOps = sigNodeSet_size (possibleOps);
00165 
00166                     <font class="comment">/*</font>
00167 <font class="comment">                     ** evs --- check is it is wrong arity...</font>
00168 <font class="comment">                     */</font>
00169                     
00170                     <font class="keywordflow">if</font> (npossibleOps == 0)
00171                       {
00172                         lclerror 
00173                           (errtok, 
00174                            <a class="code" href="message_c.html#a18">message</a> (<font class="stringliteral">"Undeclared operator: %q"</font>, nameNode_unparse (t-&gt;name)));      
00175                       }
00176                     <font class="keywordflow">else</font>
00177                       {
00178                         lclerror
00179                           (errtok, 
00180                            <a class="code" href="message_c.html#a18">message</a> (<font class="stringliteral">"Operator %q declared for %q arguments, given %d"</font>,
00181                                    nameNode_unparse (t-&gt;name),
00182                                    <a class="code" href="sigNodeSet_c.html#a7">sigNodeSet_unparsePossibleAritys</a> (possibleOps),
00183                                    arity));
00184                       }
00185                   }
00186                 t-&gt;error_reported = TRUE;
00187               }
00188             <a class="code" href="sortSetList_c.html#a8">sortSetList_free</a> (argSorts);
00189             <font class="keywordflow">break</font>;
00190           }
00191         }
00192     }
00193       
00194   <font class="keywordflow">return</font> t;
00195 }
00196 
00197 <font class="keyword">static</font> <font class="comment">/*@only@*/</font> cstring
00198 printBadArgs (sortSetList args)<font class="keyword"></font>
00199 <font class="keyword"></font>{
00200   <font class="keywordflow">if</font> (sortSetList_size (args) == 1)
00201     {
00202       <font class="keywordflow">return</font> (<a class="code" href="sortSet_c.html#a8">sortSet_unparseOr</a> (sortSetList_head (args)));
00203     }
00204   <font class="keywordflow">else</font>
00205     {
00206       cstring s = cstring_undefined;
00207       <font class="keywordtype">int</font> argno = 1;
00208 
00209       sortSetList_elements (args, ss)<font class="keyword"></font>
00210 <font class="keyword">        </font>{
00211           <font class="keywordflow">if</font> (argno == 1)
00212             s = <a class="code" href="message_c.html#a18">message</a> (<font class="stringliteral">"arg %d: %q"</font>, argno, sortSet_unparseOr (ss));
00213           <font class="keywordflow">else</font>
00214             s = <a class="code" href="message_c.html#a18">message</a> (<font class="stringliteral">"%q; arg %d: %q"</font>, s, argno, sortSet_unparseOr (ss));
00215           argno++;
00216         } end_sortSetList_elements;
00217 
00218       <font class="keywordflow">return</font> s;
00219     }
00220 }
00221 
00222 termNode 
<a name="l00223"></a><a class="code" href="checking_c.html#a5">00223</a> <a class="code" href="checking_c.html#a5">checkSort</a> (<font class="comment">/*@returned@*/</font> termNode t)<font class="keyword"></font>
00224 <font class="keyword"></font>{
00225   sortSet sorts;
00226   sort theSort;
00227   <font class="keywordtype">int</font> size;
00228   ltoken errtok;
00229 
00230   (<font class="keywordtype">void</font>) <a class="code" href="checking_c.html#a4">computePossibleSorts</a> (t);
00231   sorts = t-&gt;possibleSorts;
00232 
00233   llassert (sortSet_isDefined (sorts));
00234 
00235   size = sortSet_size (sorts);
00236   <font class="keywordflow">switch</font> (size)
00237     {
00238     <font class="keywordflow">case</font> 0:                     <font class="comment">/* complain later */</font>
00239       <font class="keywordflow">break</font>;
00240     <font class="keywordflow">case</font> 1:                     <font class="comment">/* just right */</font>
00241       theSort = <a class="code" href="sortSet_c.html#a4">sortSet_choose</a> (sorts);
00242       assignSorts (t, theSort);
00243       <font class="keywordflow">break</font>;
00244     <font class="keywordflow">default</font>:
00245      <font class="comment">/* we allow C literals to have multiple sorts */</font>
00246       <font class="keywordflow">if</font> (t-&gt;kind != TRM_LITERAL)
00247         {
00248           errtok = <a class="code" href="abstract_c.html#a74">termNode_errorToken</a> (t);
00249           t-&gt;error_reported = TRUE;
00250 
00251           <a class="code" href="llerror_c.html#a54">lclerror</a> (errtok, 
00252                     message (<font class="stringliteral">"Term %q: can have more than one possible type.  Possible types: %q"</font>,
00253                              termNode_unparse (t), <a class="code" href="sortSet_c.html#a7">sortSet_unparseClean</a> (sorts)));
00254         }
00255     }
00256   <font class="keywordflow">return</font> t;
00257 }
00258 
00259 <font class="keyword">static</font> <font class="keywordtype">void</font>
00260   assignSorts (termNode t, sort s)<font class="keyword"></font>
00261 <font class="keyword"></font>{
00262  <font class="comment">/* other kinds are already assigned bottom-up */</font>
00263   ltoken errtok;
00264 
00265   <font class="keywordflow">switch</font> (t-&gt;kind)
00266     {
00267     <font class="keywordflow">case</font> TRM_ZEROARY:   <font class="comment">/* pick s to be the sort chosen */</font>
00268     <font class="keywordflow">case</font> TRM_LITERAL:
00269       sortSet_elements (t-&gt;possibleSorts, s2)<font class="keyword"></font>
00270 <font class="keyword">      </font>{
00271         <font class="keywordflow">if</font> (<a class="code" href="sort_c.html#a110">sort_equal</a> (&amp;s2, &amp;s))
00272           {
00273             <a class="code" href="sortSet_c.html#a9">sortSet_free</a> (t-&gt;possibleSorts);
00274             t-&gt;possibleSorts = <a class="code" href="sortSet_c.html#a0">sortSet_new</a> ();
00275             (<font class="keywordtype">void</font>) <a class="code" href="sortSet_c.html#a3">sortSet_insert</a> (t-&gt;possibleSorts, s);
00276             t-&gt;sort = s;
00277           }
00278         <font class="keywordflow">return</font>;
00279       } end_sortSet_elements;
00280       <font class="keywordflow">break</font>;
00281     <font class="keywordflow">case</font> TRM_APPLICATION:
00282       {
00283         lslOpSet sigs = t-&gt;possibleOps;
00284         lslOpSet oldops = lslOpSet_undefined;
00285         sigNode op = (sigNode) 0;
00286         nameNode name = t-&gt;name;
00287         termNodeList args = t-&gt;args;
00288         <font class="keywordtype">bool</font> found = FALSE;
00289 
00290         errtok = <a class="code" href="abstract_c.html#a75">nameNode_errorToken</a> (name);
00291 
00292         <font class="comment">/* why compute again? to check for duplicates */</font>
00293         lslOpSet_elements (sigs, sig)<font class="keyword"></font>
00294 <font class="keyword">          </font>{
00295             sort rsort = <a class="code" href="abstract_c.html#a224">sigNode_rangeSort</a> (sig-&gt;signature);
00296 
00297             <font class="keywordflow">if</font> (<a class="code" href="sort_c.html#a110">sort_equal</a> (&amp;s, &amp;rsort))
00298               {
00299                 lslOp iop;
00300                 
00301                 <font class="keywordflow">if</font> (found)
00302                   {
00303                     t-&gt;error_reported = TRUE;
00304                     
00305                     <a class="code" href="llerror_c.html#a54">lclerror</a> (errtok,
00306                               message (<font class="stringliteral">"Ambiguous operator %q: %q or %q"</font>,
00307                                        nameNode_unparse (name), 
00308                                        <a class="code" href="abstract_c.html#a102">sigNode_unparse</a> (op),
00309                                        <a class="code" href="abstract_c.html#a102">sigNode_unparse</a> (sig-&gt;signature)));
00310                     <font class="keywordflow">return</font>;
00311                   }
00312 
00313                 iop = (lslOp) dmalloc (<font class="keyword">sizeof</font> (*iop));
00314                 found = TRUE;
00315                 op = sig-&gt;signature;
00316 
00317                 oldops = t-&gt;possibleOps;
00318                 t-&gt;possibleOps = <a class="code" href="lslOpSet_c.html#a1">lslOpSet_new</a> ();
00319                 iop-&gt;name = <a class="code" href="abstract_c.html#a240">nameNode_copy</a> (name);
00320                 iop-&gt;signature = op;
00321                 (<font class="keywordtype">void</font>) <a class="code" href="lslOpSet_c.html#a4">lslOpSet_insert</a> (t-&gt;possibleOps, iop);
00322                 t-&gt;sort = s;
00323                 <font class="comment">/*@-branchstate@*/</font> 
00324               } 
00325             <font class="comment">/*@=branchstate@*/</font>
00326           } end_lslOpSet_elements;
00327 
00328         <a class="code" href="lslOpSet_c.html#a7">lslOpSet_free</a> (oldops);
00329 
00330         <font class="keywordflow">if</font> (!found)
00331           {
00332             <font class="keywordflow">if</font> (sortSet_size (t-&gt;possibleSorts) == 1)
00333               {
00334                 t-&gt;sort = <a class="code" href="sortSet_c.html#a4">sortSet_choose</a> (t-&gt;possibleSorts);
00335               }
00336             <font class="keywordflow">else</font>
00337               {
00338                 <font class="comment">/* errorShowPoint (tsource_thisLine (lclsource), ltoken_getCol (errtok)); */</font>
00339                 t-&gt;error_reported = TRUE;
00340                 
00341                 <a class="code" href="llerror_c.html#a54">lclerror</a> (errtok, message (<font class="stringliteral">"Operator not found: %q"</font>, 
00342                                            nameNode_unparse (name)));
00343                 <font class="comment">/* evs --- ??? */</font>
00344               }
00345             <font class="keywordflow">return</font>;
00346           }
00347         
00348         <font class="keywordflow">if</font> (termNodeList_empty (args))
00349           {
00350             <font class="keywordflow">if</font> (op != (sigNode) 0)
00351               {
00352                 <font class="comment">/* was --- NB: copy to avoid interference */</font>
00353                 <font class="comment">/* shouldn't need to copy --- its a fresh list */</font>
00354                 sortList dom = <a class="code" href="abstract_c.html#a225">sigNode_domain</a> (op);
00355 
00356                 <a class="code" href="sortList_c.html#a3">sortList_reset</a> (dom);
00357                 termNodeList_elements (args, arg)<font class="keyword"></font>
00358 <font class="keyword">                  </font>{
00359                     assignSorts (arg, sortList_current (dom));
00360                     <a class="code" href="sortList_c.html#a4">sortList_advance</a> (dom);
00361                   } end_termNodeList_elements;
00362 
00363                 <a class="code" href="sortList_c.html#a7">sortList_free</a> (dom);
00364               }
00365             <font class="keywordflow">else</font>
00366               {
00367                 errtok = <a class="code" href="abstract_c.html#a75">nameNode_errorToken</a> (name);
00368                 <font class="comment">/* errorShowPoint (tsource_thisLine (lclsource), ltoken_getCol (errtok)); */</font>
00369                 t-&gt;error_reported = TRUE;
00370                 
00371                 <a class="code" href="llerror_c.html#a54">lclerror</a> (errtok, message (<font class="stringliteral">"No matching operator: %q"</font>,
00372                                            nameNode_unparse (name)));
00373               }
00374             <font class="keywordflow">return</font>;
00375           }
00376         <font class="keywordflow">break</font>;
00377       }
00378     <font class="keywordflow">default</font>:                    <font class="comment">/* do nothing */</font>
00379       <font class="keywordflow">break</font>;
00380     }
00381 }
00382 
00383 <font class="keywordtype">void</font>
<a name="l00384"></a><a class="code" href="checking_c.html#a6">00384</a> <a class="code" href="checking_c.html#a6">checkLclPredicate</a> (ltoken t, lclPredicateNode n)<font class="keyword"></font>
00385 <font class="keyword"></font>{
00386   sort theSort;
00387 
00388   <font class="keywordflow">if</font> ((n == NULL) || (n-&gt;predicate == NULL))
00389     {
00390       llcontbuglit (<font class="stringliteral">"checkLclPredicate expects valid lclPredicate.  "</font>
00391                     <font class="stringliteral">"Skipping current check"</font>);
00392       <font class="keywordflow">return</font>;
00393     }
00394 
00395  <font class="comment">/* check only if there are no previous errors */</font>
00396 
00397   <font class="keywordflow">if</font> (!n-&gt;predicate-&gt;error_reported)
00398     {
00399      <font class="comment">/* check that the sort of n is boolean */</font>
00400       theSort = n-&gt;predicate-&gt;sort;
00401       <font class="keywordflow">if</font> (!<a class="code" href="sort_c.html#a111">sort_compatible</a> (theSort, sort_capBool))
00402         {
00403           <font class="keywordflow">if</font> (sort_isNoSort (theSort))
00404             {
00405              ; <font class="comment">/* "Expects a boolean term.  Given term has unknown sort" */</font>
00406             }
00407           <font class="keywordflow">else</font>
00408             {
00409               cstring clauset = ltoken_getRawString (t);
00410 
00411               <font class="keywordflow">if</font> (<a class="code" href="cstring_c.html#a1">cstring_firstChar</a> (clauset) == <font class="charliteral">'('</font>)
00412                 {
00413                   clauset = cstring_makeLiteral (<font class="stringliteral">"Equality"</font>);
00414                 }
00415               <font class="keywordflow">else</font>
00416                 {
00417                   <font class="comment">/* uppercase first letter */</font>
00418                   clauset = <a class="code" href="cstring_c.html#a9">cstring_copy</a> (clauset);
00419                   <a class="code" href="cstring_c.html#a7">cstring_setChar</a> (clauset, 1, 
00420                                    (<font class="keywordtype">char</font>) toupper (cstring_firstChar (clauset))); 
00421                 }
00422 
00423               <a class="code" href="llerror_c.html#a54">lclerror</a> (t, message (<font class="stringliteral">"%q expects a boolean term, given %q."</font>, 
00424                                     clauset, sort_unparse (theSort)));
00425               
00426             }
00427         }
00428     }
00429 }
00430 
00431 <font class="comment">/*</font>
00432 <font class="comment">** these should not be doing string comparisons!</font>
00433 <font class="comment">*/</font>
00434 
00435 <font class="keyword">static</font> <font class="keywordtype">bool</font> isDeRefOperator (cstring s)<font class="keyword"></font>
00436 <font class="keyword"></font>{
00437   <font class="keywordflow">return</font> (cstring_equalLit (s, <font class="stringliteral">"*"</font>));
00438 }
00439 
00440 <font class="keyword">static</font> <font class="keywordtype">bool</font> isStateOperator (cstring s)<font class="keyword"></font>
00441 <font class="keyword"></font>{
00442   <font class="keywordflow">return</font> (cstring_equalLit (s, <font class="stringliteral">"^"</font>) ||
00443           cstring_equalLit (s, <font class="stringliteral">"'"</font>) ||
00444           cstring_equalLit (s, <font class="stringliteral">"\\any"</font>) ||
00445           cstring_equalLit (s, <font class="stringliteral">"\\pre"</font>) ||
00446           cstring_equalLit (s, <font class="stringliteral">"\\post"</font>));
00447 }
00448 
00449 <font class="keyword">static</font> <font class="keywordtype">bool</font> isCompareOperator (cstring s) <font class="comment">/* YUCK!!! */</font>
00450 {
00451   <font class="keywordflow">return</font> (cstring_equalLit (s, <font class="stringliteral">"\\eq"</font>) ||
00452           cstring_equalLit (s, <font class="stringliteral">"\\neq"</font>) ||
00453           cstring_equalLit (s, <font class="stringliteral">"="</font>) ||
00454           cstring_equalLit (s, <font class="stringliteral">"!="</font>) ||
00455           cstring_equalLit (s, <font class="stringliteral">"~="</font>) ||
00456           cstring_equalLit (s, <font class="stringliteral">"=="</font>));
00457 }
00458 
00459 <font class="keyword">static</font> <font class="keywordtype">bool</font> isStandardOperator (<font class="comment">/*@null@*/</font> nameNode n)<font class="keyword"></font>
00460 <font class="keyword"></font>{
00461   <font class="keywordflow">if</font> (n != (nameNode) 0)
00462     {
00463       <font class="keywordflow">if</font> (!n-&gt;isOpId)
00464         {
00465           opFormNode opf = n-&gt;content.opform;
00466 
00467           llassert (opf != NULL);
00468 
00469           <font class="keywordflow">switch</font> (opf-&gt;kind)
00470             {
00471             <font class="keywordflow">case</font> OPF_IF: <font class="keywordflow">return</font> TRUE;
00472             <font class="keywordflow">case</font> OPF_ANYOP:
00473               <font class="keywordflow">break</font>;
00474             <font class="keywordflow">case</font> OPF_MANYOP:
00475               {
00476                 cstring s = ltoken_getRawString (opf-&gt;content.anyop);
00477                 
00478                 <font class="keywordflow">if</font> (isStateOperator (s)) <font class="keywordflow">return</font> TRUE;
00479                 <font class="keywordflow">return</font> FALSE;
00480               }
00481             <font class="keywordflow">case</font> OPF_ANYOPM:
00482               <font class="comment">/* operator: *__ */</font>
00483               {
00484                 cstring s = ltoken_getRawString (opf-&gt;content.anyop);
00485                 
00486                 <font class="keywordflow">return</font> (isDeRefOperator (s));
00487               }
00488             <font class="keywordflow">case</font> OPF_MANYOPM:
00489               {
00490                 cstring s = ltoken_getRawString (opf-&gt;content.anyop);
00491                 
00492                 <font class="keywordflow">return</font> (isCompareOperator (s));
00493               }
00494             <font class="keywordflow">case</font> OPF_MIDDLE:
00495               <font class="keywordflow">break</font>;
00496             <font class="keywordflow">case</font> OPF_MMIDDLE:
00497               <font class="keywordflow">break</font>;
00498             <font class="keywordflow">case</font> OPF_MIDDLEM:
00499               <font class="keywordflow">break</font>;
00500             <font class="keywordflow">case</font> OPF_MMIDDLEM:
00501               <font class="keywordflow">break</font>;
00502             <font class="keywordflow">case</font> OPF_BMIDDLE:
00503               <font class="keywordflow">break</font>;
00504             <font class="keywordflow">case</font> OPF_BMMIDDLE:
00505               <font class="keywordflow">break</font>;
00506             <font class="keywordflow">case</font> OPF_BMIDDLEM:
00507               <font class="keywordflow">break</font>;
00508             <font class="keywordflow">case</font> OPF_BMMIDDLEM:
00509               <font class="keywordflow">break</font>;
00510             <font class="keywordflow">case</font> OPF_SELECT:
00511               <font class="keywordflow">break</font>;
00512             <font class="keywordflow">case</font> OPF_MAP:
00513               <font class="keywordflow">break</font>;
00514             <font class="keywordflow">case</font> OPF_MSELECT:
00515               <font class="keywordflow">break</font>;
00516             <font class="keywordflow">case</font> OPF_MMAP:
00517               <font class="keywordflow">break</font>;
00518             <font class="keywordflow">default</font>:
00519               <font class="keywordflow">break</font>;
00520             }
00521         }
00522       <font class="keywordflow">else</font>
00523         {
00524           <font class="keywordtype">int</font> code = ltoken_getCode (n-&gt;content.opid);
00525           
00526           <font class="keywordflow">if</font> (code == simpleId)
00527             {
00528               cstring text = <a class="code" href="abstract_c.html#a100">nameNode_unparse</a> (n);
00529               <font class="keywordtype">bool</font> ret = (cstring_equalLit (text, <font class="stringliteral">"trashed"</font>) 
00530                           || cstring_equalLit (text, <font class="stringliteral">"maxIndex"</font>)  
00531                           || cstring_equalLit (text, <font class="stringliteral">"minIndex"</font>)
00532                           || cstring_equalLit (text, <font class="stringliteral">"isSub"</font>));
00533           
00534               <a class="code" href="cstring_c.html#a27">cstring_free</a> (text);
00535               <font class="keywordflow">return</font> ret;
00536             }
00537 
00538           <font class="keywordflow">return</font> (code == LLT_MODIFIES || code == LLT_FRESH 
00539                   || code == LLT_UNCHANGED || code == LLT_SIZEOF);
00540         }
00541     }
00542   <font class="keywordflow">return</font> FALSE;
00543 }
00544 
00545 <font class="keyword">static</font> <font class="comment">/*@only@*/</font> sortSet
00546 standardOperators (<font class="comment">/*@null@*/</font> nameNode n, sortSetList argSorts, <font class="comment">/*@unused@*/</font> sort qual)<font class="keyword"></font>
00547 <font class="keyword"></font>{
00548   sortSet argSet;
00549   sortSet ret = <a class="code" href="sortSet_c.html#a0">sortSet_new</a> ();
00550 
00551   <font class="keywordflow">if</font> (n == (nameNode) 0) <font class="keywordflow">return</font> ret;
00552 
00553   <font class="keywordflow">if</font> (n-&gt;isOpId)
00554     {
00555       <font class="keywordtype">int</font> code = ltoken_getCode (n-&gt;content.opid);
00556 
00557       <font class="keywordflow">if</font> (sortSetList_size (argSorts) == 1)
00558         {
00559           <a class="code" href="sortSetList_c.html#a3">sortSetList_reset</a> (argSorts);
00560           
00561           argSet = <a class="code" href="sortSetList_c.html#a6">sortSetList_current</a> (argSorts);
00562           
00563           sortSet_elements (argSet, current)<font class="keyword"></font>
00564 <font class="keyword">            </font>{
00565               sortNode sn;
00566 
00567               sn = <a class="code" href="sort_c.html#a95">sort_quietLookup</a> (current);
00568 
00569               <font class="keywordflow">while</font> (sn.kind == SRT_SYN)
00570                 {
00571                   sn = <a class="code" href="sort_c.html#a95">sort_quietLookup</a> (sn.baseSort);
00572                 }
00573               
00574               <font class="comment">/*@-loopswitchbreak@*/</font>
00575               <font class="keywordflow">switch</font> (code)
00576                 {
00577                 <font class="keywordflow">case</font> simpleId:
00578                   {
00579                     cstring text = ltoken_getRawString (n-&gt;content.opid); 
00580                     
00581                     <font class="keywordflow">if</font> (cstring_equalLit (text, <font class="stringliteral">"trashed"</font>)) <font class="comment">/* GACK! */</font>
00582                       {
00583                         <font class="keywordflow">if</font> (sn.kind == SRT_OBJ ||
00584                             sn.kind == SRT_ARRAY)
00585                         (<font class="keywordtype">void</font>) <a class="code" href="sortSet_c.html#a3">sortSet_insert</a> (ret, sort_bool);   
00586                       }
00587                     
00588                     <font class="keywordflow">if</font> (cstring_equalLit (text, <font class="stringliteral">"maxIndex"</font>) || 
00589                         cstring_equalLit (text, <font class="stringliteral">"minIndex"</font>))
00590                       {
00591                         <font class="keywordflow">if</font> (sn.kind == SRT_ARRAY || sn.kind == SRT_PTR)
00592                           (<font class="keywordtype">void</font>) <a class="code" href="sortSet_c.html#a3">sortSet_insert</a> (ret, sort_int);          
00593                         
00594                         <font class="comment">/*                if (lsymbol_fromChars ("maxIndex") */</font>
00595                       }
00596                   }
00597                   <font class="keywordflow">break</font>;
00598                 <font class="keywordflow">case</font> LLT_MODIFIES:
00599                 <font class="keywordflow">case</font> LLT_FRESH:
00600                 <font class="keywordflow">case</font> LLT_UNCHANGED:
00601                   <font class="keywordflow">if</font> (sn.kind == SRT_OBJ ||
00602                       sn.kind == SRT_ARRAY)
00603                     {
00604                       (<font class="keywordtype">void</font>) <a class="code" href="sortSet_c.html#a3">sortSet_insert</a> (ret, sort_bool);     
00605                     }
00606                   <font class="keywordflow">break</font>;
00607                 <font class="keywordflow">case</font> LLT_SIZEOF:
00608                   <font class="keywordflow">if</font> (sn.kind == SRT_OBJ ||
00609                       sn.kind == SRT_ARRAY ||
00610                       sn.kind == SRT_VECTOR)
00611                   (<font class="keywordtype">void</font>) <a class="code" href="sortSet_c.html#a3">sortSet_insert</a> (ret, sort_int);
00612                   <font class="keywordflow">break</font>;
00613                 <font class="keywordflow">default</font>:
00614                   <font class="keywordflow">break</font>;
00615                 }
00616             } end_sortSet_elements;
00617         }
00618     }
00619   <font class="keywordflow">else</font>
00620     {
00621       opFormNode opf = n-&gt;content.opform;
00622 
00623       llassert (opf != NULL);
00624 
00625       <font class="keywordflow">switch</font> (opf-&gt;kind)
00626         {
00627         <font class="keywordflow">case</font> OPF_IF:
00628           <font class="comment">/*</font>
00629 <font class="comment">          ** if __ then __ else __ : bool, S, S -&gt; S</font>
00630 <font class="comment">          **     is defined for all sorts</font>
00631 <font class="comment">          */</font>
00632           
00633           <font class="keywordflow">if</font> (sortSetList_size (argSorts) == 3)
00634             {
00635               argSet = <a class="code" href="sortSetList_c.html#a5">sortSetList_head</a> (argSorts);
00636               
00637               <font class="keywordflow">if</font> (<a class="code" href="sortSet_c.html#a5">sortSet_member</a> (argSet, sort_bool))
00638                 {
00639                   <a class="code" href="sortSetList_c.html#a3">sortSetList_reset</a> (argSorts);
00640                   <a class="code" href="sortSetList_c.html#a4">sortSetList_advance</a> (argSorts);
00641                   
00642                   argSet = <a class="code" href="sortSetList_c.html#a6">sortSetList_current</a> (argSorts);
00643                   
00644                   <font class="keywordflow">if</font> (sortSet_size (argSet) == 1)
00645                     {
00646                       sort clause = <a class="code" href="sortSet_c.html#a4">sortSet_choose</a> (argSet);
00647                       sort clause2;
00648 
00649                       <a class="code" href="sortSetList_c.html#a4">sortSetList_advance</a> (argSorts);
00650                       argSet = <a class="code" href="sortSetList_c.html#a6">sortSetList_current</a> (argSorts);
00651                       
00652                       clause2 = <a class="code" href="sortSet_c.html#a4">sortSet_choose</a> (argSet);
00653                       
00654                       <font class="keywordflow">if</font> (sortSet_size (argSet) == 1 &amp;&amp;
00655                           <a class="code" href="sort_c.html#a110">sort_equal</a> (&amp;clause, &amp;clause2))
00656                         {
00657                           (<font class="keywordtype">void</font>) <a class="code" href="sortSet_c.html#a3">sortSet_insert</a> (ret, clause);
00658                         }
00659                     }
00660                 }
00661             }
00662           <font class="keywordflow">break</font>;
00663         <font class="keywordflow">case</font> OPF_MANYOP:
00664           {
00665             cstring s = ltoken_getRawString (opf-&gt;content.anyop);
00666 
00667             <font class="keywordflow">if</font> (isStateOperator (s))
00668               {
00669                 <font class="keywordflow">if</font> (sortSetList_size (argSorts) == 1)
00670                   {
00671                     <a class="code" href="sortSetList_c.html#a3">sortSetList_reset</a> (argSorts);
00672                     
00673                     argSet = <a class="code" href="sortSetList_c.html#a6">sortSetList_current</a> (argSorts);
00674                     
00675                     sortSet_elements (argSet, current)<font class="keyword"></font>
00676 <font class="keyword">                      </font>{
00677                         sortNode sn;
00678 
00679                         sn = <a class="code" href="sort_c.html#a95">sort_quietLookup</a> (current);
00680 
00681                         <font class="keywordflow">while</font> (sn.kind == SRT_SYN)
00682                           {
00683                             sn = <a class="code" href="sort_c.html#a95">sort_quietLookup</a> (sn.baseSort);
00684                           }
00685                         
00686                         <font class="keywordflow">switch</font> (sn.kind)
00687                           {
00688                           <font class="keywordflow">case</font> SRT_OBJ:
00689                             (<font class="keywordtype">void</font>) <a class="code" href="sortSet_c.html#a3">sortSet_insert</a> (ret, sn.baseSort);
00690                             <font class="keywordflow">break</font>;
00691                           <font class="keywordflow">case</font> SRT_ARRAY:
00692                             (<font class="keywordtype">void</font>) <a class="code" href="sortSet_c.html#a3">sortSet_insert</a> (ret, 
00693                                                    sort_makeVec (ltoken_undefined, current));
00694                             <font class="keywordflow">break</font>; 
00695                           <font class="keywordflow">case</font> SRT_STRUCT:
00696                             (<font class="keywordtype">void</font>) <a class="code" href="sortSet_c.html#a3">sortSet_insert</a> (ret, 
00697                                                    sort_makeTuple (ltoken_undefined, current));
00698                             <font class="keywordflow">break</font>;
00699                           <font class="keywordflow">case</font> SRT_UNION:
00700                             (<font class="keywordtype">void</font>) <a class="code" href="sortSet_c.html#a3">sortSet_insert</a> (ret, 
00701                                                    sort_makeUnionVal (ltoken_undefined, current));
00702                             <font class="keywordflow">break</font>;
00703                           <font class="keywordflow">case</font> SRT_TUPLE:
00704                           <font class="keywordflow">case</font> SRT_UNIONVAL:
00705                           <font class="keywordflow">case</font> SRT_ENUM:
00706                           <font class="keywordflow">case</font> SRT_LAST:
00707                           <font class="keywordflow">case</font> SRT_FIRST:
00708                           <font class="keywordflow">case</font> SRT_NONE:       
00709                           <font class="keywordflow">case</font> SRT_HOF:
00710                           <font class="keywordflow">case</font> SRT_PRIM:
00711                           <font class="keywordflow">case</font> SRT_PTR:
00712                           <font class="keywordflow">case</font> SRT_VECTOR:
00713                             <font class="keywordflow">break</font>;
00714                           <font class="keywordflow">case</font> SRT_SYN:
00715                             llbuglit (<font class="stringliteral">"standardOperators: Synonym in switch"</font>);
00716                           }
00717                       } end_sortSet_elements ;
00718                   }
00719               }
00720           }
00721           <font class="keywordflow">break</font>;
00722         <font class="keywordflow">case</font> OPF_ANYOPM:
00723           <font class="comment">/* operator: *__ */</font>
00724           {
00725             cstring s = ltoken_getRawString (opf-&gt;content.anyop);
00726             
00727             <font class="keywordflow">if</font> (isDeRefOperator (s))
00728               {
00729                 <font class="keywordflow">if</font> (sortSetList_size (argSorts) == 1)
00730                   {
00731                     <a class="code" href="sortSetList_c.html#a3">sortSetList_reset</a> (argSorts);
00732                     
00733                     argSet = <a class="code" href="sortSetList_c.html#a6">sortSetList_current</a> (argSorts);
00734                     
00735                     sortSet_elements (argSet, current)<font class="keyword"></font>
00736 <font class="keyword">                      </font>{
00737                         sortNode sn;
00738 
00739                         sn = <a class="code" href="sort_c.html#a95">sort_quietLookup</a> (current);
00740                         
00741                         <font class="keywordflow">while</font> (sn.kind == SRT_SYN)
00742                           {
00743                             sn = <a class="code" href="sort_c.html#a95">sort_quietLookup</a> (sn.baseSort);
00744                           }
00745                         
00746                         <font class="keywordflow">if</font> (sn.kind == SRT_PTR)
00747                           {
00748                             (<font class="keywordtype">void</font>) <a class="code" href="sortSet_c.html#a3">sortSet_insert</a> (ret, sn.baseSort);           
00749                           }
00750                       } end_sortSet_elements; 
00751                   }
00752               }
00753           }
00754           <font class="keywordflow">break</font>;
00755         <font class="keywordflow">case</font> OPF_ANYOP:
00756           <font class="keywordflow">break</font>;
00757         <font class="keywordflow">case</font> OPF_MANYOPM:
00758           {
00759             cstring s = ltoken_getRawString (opf-&gt;content.anyop);
00760             
00761             <font class="keywordflow">if</font> (isCompareOperator (s))
00762               {
00763                 <font class="keywordflow">if</font> (sortSetList_size (argSorts) == 2)
00764                   {
00765                     sortSet argSet2;
00766 
00767                     <a class="code" href="sortSetList_c.html#a3">sortSetList_reset</a> (argSorts);
00768                     
00769                     argSet = <a class="code" href="sortSetList_c.html#a6">sortSetList_current</a> (argSorts);
00770                     <a class="code" href="sortSetList_c.html#a4">sortSetList_advance</a> (argSorts);
00771                     argSet2 = <a class="code" href="sortSetList_c.html#a6">sortSetList_current</a> (argSorts);
00772                     
00773                     <font class="keywordflow">if</font> (sortSet_size (argSet) == 1)
00774                       {
00775                         sortSet_elements (argSet, cl)<font class="keyword"></font>
00776 <font class="keyword">                          </font>{
00777                             sortSet_elements (argSet2, cl2)<font class="keyword"></font>
00778 <font class="keyword">                              </font>{
00779                                 <font class="keywordflow">if</font> (<a class="code" href="sort_c.html#a110">sort_equal</a> (&amp;cl, &amp;cl2))
00780                                   {
00781                                     (<font class="keywordtype">void</font>) <a class="code" href="sortSet_c.html#a3">sortSet_insert</a> (ret, sort_bool);
00782                                   }
00783                               } end_sortSet_elements;
00784                           } end_sortSet_elements; 
00785                       }
00786                   }
00787               }
00788           }
00789           <font class="keywordflow">break</font>;
00790         <font class="keywordflow">case</font> OPF_MIDDLE:
00791           <font class="keywordflow">break</font>;
00792         <font class="keywordflow">case</font> OPF_MMIDDLE:
00793           <font class="keywordflow">break</font>;
00794         <font class="keywordflow">case</font> OPF_MIDDLEM:
00795           <font class="keywordflow">break</font>;
00796         <font class="keywordflow">case</font> OPF_MMIDDLEM:
00797           <font class="keywordflow">break</font>;
00798         <font class="keywordflow">case</font> OPF_BMIDDLE:
00799           <font class="keywordflow">break</font>;
00800         <font class="keywordflow">case</font> OPF_BMMIDDLE:
00801           <font class="keywordflow">break</font>;
00802         <font class="keywordflow">case</font> OPF_BMIDDLEM:
00803           <font class="keywordflow">break</font>;
00804         <font class="keywordflow">case</font> OPF_BMMIDDLEM:
00805           <font class="keywordflow">break</font>;
00806         <font class="keywordflow">case</font> OPF_SELECT:
00807           <font class="keywordflow">break</font>;
00808         <font class="keywordflow">case</font> OPF_MAP:
00809           <font class="keywordflow">break</font>;
00810         <font class="keywordflow">case</font> OPF_MSELECT:
00811           <font class="keywordflow">break</font>;
00812         <font class="keywordflow">case</font> OPF_MMAP:
00813           <font class="keywordflow">break</font>;
00814         <font class="keywordflow">default</font>:
00815           <font class="keywordflow">break</font>;
00816         }
00817       <font class="comment">/*@=loopswitchbreak@*/</font>
00818     }
00819   <font class="keywordflow">return</font> ret;
00820 }
</div></pre><hr><address><small>Generated at Fri Nov 3 18:57:39 2000 for LCLint by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.3 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2000</small></address>
</body>
</html>
