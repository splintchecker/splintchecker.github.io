<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>lcllib.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.3 on Fri Nov 3 18:57:41 2000 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>lcllib.c</h1><a href="lcllib_c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">** LCLint - annotation-assisted static program checker</font>
00003 <font class="comment">** Copyright (C) 1994-2000 University of Virginia,</font>
00004 <font class="comment">**         Massachusetts Institute of Technology</font>
00005 <font class="comment">**</font>
00006 <font class="comment">** This program is free software; you can redistribute it and/or modify it</font>
00007 <font class="comment">** under the terms of the GNU General Public License as published by the</font>
00008 <font class="comment">** Free Software Foundation; either version 2 of the License, or (at your</font>
00009 <font class="comment">** option) any later version.</font>
00010 <font class="comment">** </font>
00011 <font class="comment">** This program is distributed in the hope that it will be useful, but</font>
00012 <font class="comment">** WITHOUT ANY WARRANTY; without even the implied warranty of</font>
00013 <font class="comment">** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</font>
00014 <font class="comment">** General Public License for more details.</font>
00015 <font class="comment">** </font>
00016 <font class="comment">** The GNU General Public License is available from http://www.gnu.org/ or</font>
00017 <font class="comment">** the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston,</font>
00018 <font class="comment">** MA 02111-1307, USA.</font>
00019 <font class="comment">**</font>
00020 <font class="comment">** For information on lclint: lclint-request@cs.virginia.edu</font>
00021 <font class="comment">** To report a bug: lclint-bug@cs.virginia.edu</font>
00022 <font class="comment">** For more information: http://lclint.cs.virginia.edu</font>
00023 <font class="comment">*/</font>
00024 <font class="comment">/*</font>
00025 <font class="comment">** lcllib.c</font>
00026 <font class="comment">**</font>
00027 <font class="comment">** routines for loading and creating library files</font>
00028 <font class="comment">**</font>
00029 <font class="comment">** this is a brute-force implementation, a more efficient</font>
00030 <font class="comment">** representation should be designed.</font>
00031 <font class="comment">**</font>
00032 <font class="comment">*/</font>
00033 
00034 <font class="preprocessor"># include "lclintMacros.nf"</font>
00035 <font class="preprocessor"># include "llbasic.h"</font>
00036 
00037 <font class="preprocessor"># include "osd.h"</font>
00038 
00039 <font class="preprocessor"># ifndef NOLCL</font>
00040 <font class="preprocessor"></font><font class="preprocessor"># include "gram.h"</font>
00041 
00042 <font class="preprocessor"># include "lclscan.h"</font>
00043 <font class="preprocessor"># endif</font>
00044 <font class="preprocessor"></font>
00045 
00046 <font class="preprocessor"># include "herald.h"</font>
00047 <font class="preprocessor"># include "lcllib.h"</font>
00048 <font class="preprocessor"># include "llmain.h"</font>
00049 <font class="preprocessor"># include "portab.h"</font>
00050 
00051 <font class="comment">/*@-incondefs@*/</font> <font class="comment">/*@-redecl@*/</font>
00052 <font class="keyword">extern</font> <font class="comment">/*@dependent@*/</font> FILE *yyin;
00053 <font class="comment">/*@=incondefs@*/</font> <font class="comment">/*@=redecl@*/</font>
00054 
00055 <font class="comment">/*@constant int NUMLIBS; @*/</font>
<a name="l00056"></a><a class="code" href="lcllib_c.html#a0">00056</a> <font class="preprocessor"># define NUMLIBS 17</font>
00057 <font class="preprocessor"></font>
00058 <font class="comment">/*@constant int NUMPOSIXLIBS; @*/</font>
<a name="l00059"></a><a class="code" href="lcllib_c.html#a1">00059</a> <font class="preprocessor"># define NUMPOSIXLIBS 12</font>
00060 <font class="preprocessor"></font>
00061 <font class="keyword">static</font> ob_mstring posixlibs[NUMPOSIXLIBS] = 
00062 {
00063   <font class="stringliteral">"sys/stat"</font>,
00064   <font class="stringliteral">"sys/types"</font>,
00065   <font class="stringliteral">"dirent"</font>,
00066   <font class="stringliteral">"fcntl"</font>,
00067   <font class="stringliteral">"grp"</font>,
00068   <font class="stringliteral">"pwd"</font>,
00069   <font class="stringliteral">"sys/times"</font>,
00070   <font class="stringliteral">"sys/utsname"</font>,
00071   <font class="stringliteral">"sys/wait"</font>,
00072   <font class="stringliteral">"termios"</font>,
00073   <font class="stringliteral">"unistd"</font>,
00074   <font class="stringliteral">"utime"</font>
00075 } ;
00076 
00077 <font class="keyword">static</font> ob_mstring stdlibs[NUMLIBS] =
00078 {
00079   <font class="stringliteral">"assert"</font>, 
00080   <font class="stringliteral">"ctype"</font>,
00081   <font class="stringliteral">"errno"</font>,
00082   <font class="stringliteral">"float"</font>, 
00083   <font class="stringliteral">"limits"</font>,
00084   <font class="stringliteral">"locale"</font>,
00085   <font class="stringliteral">"math"</font>, 
00086   <font class="stringliteral">"setjmp"</font>,
00087   <font class="stringliteral">"signal"</font>,
00088   <font class="stringliteral">"stdarg"</font>,
00089   <font class="stringliteral">"stddef"</font>,
00090   <font class="stringliteral">"stdio"</font>,
00091   <font class="stringliteral">"stdlib"</font>,
00092   <font class="stringliteral">"strings"</font>, 
00093   <font class="stringliteral">"string"</font>,
00094   <font class="stringliteral">"time"</font>,
00095   <font class="stringliteral">"wchar"</font>
00096 } ;
00097 
00098 <font class="keyword">static</font> <font class="keywordtype">bool</font> loadStateFile (FILE * p_f, cstring p_name);
00099 
00100 <font class="keywordtype">bool</font>
<a name="l00101"></a><a class="code" href="lcllib_c.html#a7">00101</a> <a class="code" href="lcllib_c.html#a7">lcllib_isSkipHeader</a> (cstring sname)<font class="keyword"></font>
00102 <font class="keyword"></font>{
00103   <font class="keywordtype">int</font> i;
00104   <font class="keywordtype">bool</font> posixlib = FALSE;
00105   <font class="keywordtype">char</font> *libname;
00106   <font class="keywordtype">char</font> *name = <a class="code" href="cstring_c.html#a29">cstring_toCharsSafe</a> (sname);
00107   <font class="keywordtype">char</font> *matchname;
00108 
00109   llassert (cstring_isDefined (sname));
00110   name = <a class="code" href="general_c.html#a9">removeExtension</a> (name, <font class="stringliteral">".h"</font>);
00111 
00112   libname = strrchr (name, CONNECTCHAR);
00113   matchname = libname;
00114 
00115   <font class="keywordflow">if</font> (libname == NULL) 
00116     {
00117       libname = name;
00118     }
00119   <font class="keywordflow">else</font>
00120     {
00121       libname++;
00122       <font class="comment">/*@-branchstate@*/</font>
00123     }
00124   <font class="comment">/*@=branchstate@*/</font>
00125 
00126   <font class="keywordflow">if</font> (<a class="code" href="general_c.html#a40">mstring_equal</a> (libname, <font class="stringliteral">"varargs"</font>))
00127     {
00128       fileloc tmp = <a class="code" href="fileloc_c.html#a30">fileloc_makePreprocPrevious</a> (g_currentloc);
00129       
00130       voptgenerror 
00131         (FLG_USEVARARGS,
00132          <a class="code" href="message_c.html#a18">message</a> (<font class="stringliteral">"Include file &lt;%s&gt; is inconsistent with "</font>
00133                   <font class="stringliteral">"ANSI library (should use &lt;stdarg.h&gt;)"</font>,
00134                   cstring_fromChars (libname)),
00135          tmp);
00136       
00137       <a class="code" href="fileloc_c.html#a8">fileloc_free</a> (tmp);
00138       <a class="code" href="general_c.html#a0">sfree</a> (name);
00139       <font class="keywordflow">return</font> TRUE;
00140     }
00141 
00142   <font class="keywordflow">if</font> (<a class="code" href="context_c.html#a189">context_getFlag</a> (FLG_SKIPANSIHEADERS)
00143       &amp;&amp; <a class="code" href="context_c.html#a54">context_usingAnsiLibrary</a> ())
00144     {
00145       
00146       <font class="keywordflow">for</font> (i = 0; i &lt; NUMLIBS; i++)
00147         {
00148           <font class="keywordflow">if</font> (<a class="code" href="general_c.html#a40">mstring_equal</a> (libname, stdlibs[i]))
00149             {
00150               <a class="code" href="general_c.html#a0">sfree</a> (name);
00151               <font class="keywordflow">return</font> TRUE;
00152             }
00153         }
00154     }
00155 
00156   <font class="keywordflow">for</font> (i = 0; i &lt; NUMPOSIXLIBS; i++)
00157     {
00158       <font class="keywordflow">if</font> (strchr (posixlibs[i], CONNECTCHAR) != NULL)
00159         {
00160           <font class="keywordtype">char</font> *ptr;
00161           
00162           <font class="keywordflow">if</font> ((ptr = strstr (name, posixlibs[i])) != NULL) 
00163             {
00164               <font class="keywordflow">if</font> (ptr[strlen (posixlibs[i])] == <font class="charliteral">'\0'</font>)
00165                 {
00166                   posixlib = TRUE;
00167                   matchname = ptr;
00168                   <font class="keywordflow">break</font>;
00169                 }
00170               <font class="keywordflow">else</font>
00171                 {
00172                   ; <font class="comment">/* no match */</font>
00173                 }
00174             }
00175         }
00176       <font class="keywordflow">else</font>
00177         {
00178           <font class="keywordflow">if</font> (<a class="code" href="general_c.html#a40">mstring_equal</a> (libname, posixlibs[i]))
00179             {
00180               posixlib = TRUE;
00181               matchname = libname;
00182               <font class="keywordflow">break</font>;
00183             }
00184           <font class="comment">/*@-branchstate@*/</font> 
00185         }
00186     } <font class="comment">/*@=branchstate@*/</font>
00187   
00188   <font class="keywordflow">if</font> (posixlib)
00189     {
00190       <font class="keywordflow">if</font> (<a class="code" href="context_c.html#a53">context_usingPosixLibrary</a> ())
00191         {
00192           <font class="keywordflow">if</font> (<a class="code" href="context_c.html#a189">context_getFlag</a> (FLG_SKIPPOSIXHEADERS))
00193             {
00194               <a class="code" href="general_c.html#a0">sfree</a> (name);
00195               <font class="keywordflow">return</font> TRUE;
00196             }
00197         }
00198       <font class="keywordflow">else</font>
00199         {       
00200           fileloc tmp = <a class="code" href="fileloc_c.html#a30">fileloc_makePreprocPrevious</a> (g_currentloc);           
00201           
00202           voptgenerror 
00203             (FLG_WARNPOSIX,
00204              <a class="code" href="message_c.html#a18">message</a> (<font class="stringliteral">"Include file &lt;%s&gt; matches the name of a "</font>
00205                       <font class="stringliteral">"POSIX library, but the POSIX library is "</font>
00206                       <font class="stringliteral">"not being used.  Consider using +posixlib "</font>
00207                       <font class="stringliteral">"or +posixstrictlib to select the POSIX "</font>
00208                       <font class="stringliteral">"library, or -warnposix "</font>
00209                       <font class="stringliteral">"to suppress this message."</font>,
00210                       cstring_fromChars (matchname)),
00211              tmp);
00212           
00213           <a class="code" href="fileloc_c.html#a8">fileloc_free</a> (tmp);
00214         }
00215     }
00216 
00217   <a class="code" href="general_c.html#a0">sfree</a> (name);
00218   <font class="keywordflow">return</font> FALSE;
00219 }
00220 
00221 <font class="keyword">static</font> <font class="keywordtype">void</font> printDot (<font class="keywordtype">void</font>)<font class="keyword"></font>
00222 <font class="keyword"></font>{
00223   <font class="keywordflow">if</font> (<a class="code" href="context_c.html#a189">context_getFlag</a> (FLG_SHOWSCAN)) 
00224     {
00225       (<font class="keywordtype">void</font>) fflush (g_msgstream);
00226       fprintf (stderr, <font class="stringliteral">"."</font>); 
00227       (<font class="keywordtype">void</font>) fflush (stderr);
00228     }
00229 }
00230 
00231 <font class="keywordtype">void</font>
<a name="l00232"></a><a class="code" href="lcllib_c.html#a9">00232</a> <a class="code" href="lcllib_c.html#a9">dumpState</a> (cstring cfname)<font class="keyword"></font>
00233 <font class="keyword"></font>{
00234   FILE *f;
00235   <font class="keywordtype">char</font> *fname = <a class="code" href="cstring_c.html#a29">cstring_toCharsSafe</a> (cfname);
00236   
00237   fname = <a class="code" href="general_c.html#a15">addExtension</a> (fname, DUMP_SUFFIX);
00238   
00239   f = fopen (fname, <font class="stringliteral">"w"</font>);
00240 
00241   <font class="keywordflow">if</font> (<a class="code" href="context_c.html#a189">context_getFlag</a> (FLG_SHOWSCAN))
00242     {
00243       fprintf (stderr, <font class="stringliteral">"&lt; Dumping to %s "</font>, fname); 
00244     }
00245   
00246   <font class="keywordflow">if</font> (f == NULL)
00247     {
00248       <a class="code" href="llerror_c.html#a50">llgloberror</a> (message (<font class="stringliteral">"Cannot open dump file for writing: %s"</font>, cfname));
00249     }
00250   <font class="keywordflow">else</font>
00251     {
00252       <font class="comment">/*</font>
00253 <font class="comment">      ** sequence is convulted --- must call usymtab_prepareDump before</font>
00254 <font class="comment">      **    dumping ctype table to convert type uid's</font>
00255 <font class="comment">      */</font>
00256 
00257       printDot ();
00258 
00259       <a class="code" href="usymtab_c.html#a79">usymtab_prepareDump</a> ();
00260 
00261       <font class="comment">/*</font>
00262 <font class="comment">      ** Be careful, these lines must match loadStateFile checking.</font>
00263 <font class="comment">      */</font>
00264 
00265       fprintf (f, <font class="stringliteral">";;LCLint Dump: %s\n"</font>, fname);
00266       fprintf (f, <font class="stringliteral">";;%s\n"</font>, LCL_VERSION);
00267       fprintf (f, <font class="stringliteral">";;lib:%d\n"</font>, (<font class="keywordtype">int</font>) <a class="code" href="context_c.html#a55">context_getLibrary</a> ());
00268       fprintf (f, <font class="stringliteral">";;ctTable\n"</font>);
00269 
00270       printDot ();
00271             <a class="code" href="ctype_c.html#a20">ctype_dumpTable</a> (f);
00272       printDot ();
00273 
00274       fprintf (f, <font class="stringliteral">";;tistable\n"</font>);
00275       <a class="code" href="typeIdSet_c.html#a8">typeIdSet_dumpTable</a> (f);
00276       printDot ();
00277 
00278             fprintf (f, <font class="stringliteral">";;symTable\n"</font>);
00279       <a class="code" href="usymtab_c.html#a80">usymtab_dump</a> (f);
00280       printDot ();
00281 
00282       fprintf (f, <font class="stringliteral">";; Modules access\n"</font>);
00283       <a class="code" href="context_c.html#a52">context_dumpModuleAccess</a> (f);
00284       fprintf (f, <font class="stringliteral">";;End\n"</font>);
00285       check (fclose (f) == 0);
00286     }
00287 
00288   <font class="keywordflow">if</font> (<a class="code" href="context_c.html#a189">context_getFlag</a> (FLG_SHOWSCAN))
00289     {
00290       fprintf (g_msgstream, <font class="stringliteral">" &gt;\n"</font>);
00291     }
00292 
00293   <a class="code" href="general_c.html#a0">sfree</a> (fname);
00294 }
00295 
00296 <font class="keywordtype">bool</font>
<a name="l00297"></a><a class="code" href="lcllib_c.html#a10">00297</a> <a class="code" href="lcllib_c.html#a10">loadStandardState</a> ()<font class="keyword"></font>
00298 <font class="keyword"></font>{
00299   <font class="keywordtype">char</font> *fpath;
00300   FILE *stdlib;
00301   <font class="keywordtype">bool</font> result;
00302   <font class="keywordtype">char</font> *libname = <a class="code" href="general_c.html#a15">addExtension</a> (context_selectedLibrary (), DUMP_SUFFIX);
00303   
00304   
00305   <font class="keywordflow">if</font> (<a class="code" href="osd_c.html#a6">osd_findOnLarchPath</a> (libname, &amp;fpath) != OSD_FILEFOUND)
00306     {
00307       <a class="code" href="llerror_c.html#a22">lldiagmsg</a> (message (<font class="stringliteral">"Cannot find %sstandard library: %s"</font>, 
00308                           cstring_makeLiteralTemp 
00309                           (context_getFlag (FLG_STRICTLIB) ? <font class="stringliteral">"strict "</font> 
00310                            : (<a class="code" href="context_c.html#a189">context_getFlag</a> (FLG_UNIXLIB) ? <font class="stringliteral">"unix "</font> : <font class="stringliteral">""</font>)),
00311                           cstring_makeLiteralTemp (libname)));
00312       <a class="code" href="llerror_c.html#a22">lldiagmsg</a> (cstring_makeLiteral (<font class="stringliteral">"     Check LARCH_PATH environment variable."</font>));
00313       result = FALSE;
00314     }
00315   <font class="keywordflow">else</font>
00316     {
00317       stdlib = fopen (fpath, <font class="stringliteral">"r"</font>);
00318 
00319       <font class="keywordflow">if</font> (stdlib == NULL)
00320         {
00321           <a class="code" href="llerror_c.html#a22">lldiagmsg</a> (message (<font class="stringliteral">"Cannot read standard library: %s"</font>,
00322                           cstring_fromChars (fpath)));
00323           <a class="code" href="llerror_c.html#a22">lldiagmsg</a> (cstring_makeLiteral (<font class="stringliteral">"     Check LARCH_PATH environment variable."</font>));
00324 
00325           result = FALSE;
00326         }
00327       <font class="keywordflow">else</font>
00328         {
00329           <font class="keywordflow">if</font> (<a class="code" href="context_c.html#a189">context_getFlag</a> (FLG_WHICHLIB))
00330             {
00331               <font class="keywordtype">char</font> *t = <a class="code" href="general_c.html#a29">mstring_create</a> (MAX_NAME_LENGTH);
00332               <font class="keywordtype">char</font> *ot = t;
00333 
00334               <font class="keywordflow">if</font> (fgets (t, MAX_NAME_LENGTH, stdlib) == NULL)
00335                 {
00336                   <a class="code" href="llerror_c.html#a48">llfatalerror</a> (cstring_makeLiteral (<font class="stringliteral">"Standard library format invalid"</font>));
00337                 }
00338 
00339               <font class="keywordflow">if</font> (fgets (t, MAX_NAME_LENGTH, stdlib) != NULL)
00340                 {
00341                   <font class="keywordflow">if</font> (*t == <font class="charliteral">';'</font> &amp;&amp; *(t + 1) == <font class="charliteral">';'</font>) 
00342                     {
00343                       t += 2;
00344                     }
00345                 }
00346 
00347               <font class="keywordflow">if</font> (t == NULL)
00348                 {
00349                   <a class="code" href="llerror_c.html#a22">lldiagmsg</a> (message (<font class="stringliteral">"Standard library: %s &lt;cannot read creation information&gt;"</font>, 
00350                                   cstring_fromChars (fpath)));
00351                 }
00352               <font class="keywordflow">else</font>
00353                 {
00354                   <font class="keywordtype">char</font> *tt;
00355 
00356                   tt = strrchr (t, <font class="charliteral">'\n'</font>);
00357                   <font class="keywordflow">if</font> (tt != NULL)
00358                     *tt = <font class="charliteral">'\0'</font>;
00359 
00360                   <a class="code" href="llerror_c.html#a22">lldiagmsg</a> (message (<font class="stringliteral">"Standard library: %s"</font>, cstring_fromChars (fpath)));
00361                   <a class="code" href="llerror_c.html#a22">lldiagmsg</a> (message (<font class="stringliteral">"   (created using %s)"</font>, cstring_fromChars (t)));
00362                 }
00363 
00364               <a class="code" href="general_c.html#a0">sfree</a> (ot);
00365               
00366               check (fclose (stdlib) == 0);
00367               stdlib = fopen (fpath, <font class="stringliteral">"r"</font>);
00368             }
00369 
00370           llassert (stdlib != NULL);
00371 
00372           <a class="code" href="fileloc_c.html#a9">fileloc_reallyFree</a> (g_currentloc);
00373           g_currentloc = <a class="code" href="fileloc_c.html#a23">fileloc_createLib</a> (cstring_makeLiteralTemp (libname));
00374 
00375           <font class="keywordflow">if</font> (context_getDebug (FLG_SHOWSCAN))
00376             {
00377               <a class="code" href="context_c.html#a217">context_hideShowscan</a> ();
00378               result = loadStateFile (stdlib, cstring_fromChars (fpath));
00379               <a class="code" href="context_c.html#a218">context_unhideShowscan</a> ();
00380             }
00381           <font class="keywordflow">else</font>
00382             {
00383               result = loadStateFile (stdlib, cstring_fromChars (fpath));
00384             }
00385 
00386           check (fclose (stdlib) == 0);
00387         }
00388     }
00389 
00390   <a class="code" href="general_c.html#a0">sfree</a> (libname);
00391   <font class="keywordflow">return</font> result;
00392 }
00393 
00394 <font class="comment">/*@constant int BUFLEN;@*/</font>
<a name="l00395"></a><a class="code" href="lcllib_c.html#a2">00395</a> <font class="preprocessor"># define BUFLEN 128</font>
00396 <font class="preprocessor"></font>
00397 <font class="keyword">static</font> <font class="keywordtype">bool</font>
00398 loadStateFile (FILE *f, cstring name)<font class="keyword"></font>
00399 <font class="keyword"></font>{
00400   <font class="keywordtype">char</font> buf[BUFLEN];
00401   
00402   <font class="comment">/*</font>
00403 <font class="comment">  ** Check version.  Should be &gt;= LCL_MIN_VERSION</font>
00404 <font class="comment">  */</font>
00405 
00406   <font class="keywordflow">if</font> ((fgets (buf, BUFLEN, f) == NULL)
00407       || !<a class="code" href="general_c.html#a39">mstring_equalPrefix</a> (buf, <font class="stringliteral">";;LCLint Dump:"</font>))
00408     {
00409       <a class="code" href="llerror_c.html#a63">loadllmsg</a> (message (<font class="stringliteral">"Load library %s is not in LCLint library format.  Attempting "</font>
00410                       <font class="stringliteral">"to continue without library."</font>, name));
00411       <font class="keywordflow">return</font> FALSE;
00412     }
00413   
00414   <font class="keywordflow">if</font> (fgets (buf, BUFLEN, f) != NULL)
00415     {
00416       <font class="keywordflow">if</font> (!<a class="code" href="general_c.html#a39">mstring_equalPrefix</a> (buf, <font class="stringliteral">";;"</font>))
00417         {
00418           <a class="code" href="llerror_c.html#a63">loadllmsg</a> (message (<font class="stringliteral">"Load library %s is not in LCLint library format.  Attempting "</font>
00419                           <font class="stringliteral">"to continue without library."</font>, name));
00420           <font class="keywordflow">return</font> FALSE;
00421         }
00422       <font class="keywordflow">else</font> <font class="keywordflow">if</font> (<a class="code" href="general_c.html#a39">mstring_equalPrefix</a> (buf, <font class="stringliteral">";;ctTable"</font>))
00423         {
00424           <a class="code" href="llerror_c.html#a63">loadllmsg</a> (message (<font class="stringliteral">"Load library %s is in obsolete LCLint library format.  Attempting "</font>
00425                           <font class="stringliteral">"to continue anyway, but results may be incorrect.  Rebuild "</font>
00426                           <font class="stringliteral">"the library with this version of lclint."</font>, 
00427                           name));
00428         }
00429       <font class="keywordflow">else</font> 
00430         {
00431           <font class="keywordtype">float</font> version = 0.0;
00432 
00433           <font class="keywordflow">if</font> (sscanf (buf, <font class="stringliteral">";;LCLint %f"</font>, &amp;version) != 1)
00434             {
00435               <a class="code" href="llerror_c.html#a63">loadllmsg</a> (message (<font class="stringliteral">"Load library %s is not in LCLint library format (missing version "</font>
00436                               <font class="stringliteral">"number).  Attempting "</font>
00437                               <font class="stringliteral">"to continue without library."</font>, name));
00438               <font class="keywordflow">return</font> FALSE;
00439             }
00440           <font class="keywordflow">else</font>
00441             {
00442               <font class="keywordflow">if</font> ((LCL_MIN_VERSION - version) &gt;= FLT_EPSILON)
00443                 {
00444                   cstring vname;
00445                   <font class="keywordtype">char</font> *nl = strchr (buf, <font class="charliteral">'\n'</font>);
00446 
00447                   *nl = <font class="charliteral">'\0'</font>;
00448 
00449                   vname = <a class="code" href="cstring_c.html#a28">cstring_fromChars</a> (buf + 9);
00450 
00451                   <a class="code" href="llerror_c.html#a63">loadllmsg</a> (message (<font class="stringliteral">"Load library %s is in obsolete LCLint library "</font>
00452                                       <font class="stringliteral">"format (version %s).  Attempting "</font>
00453                                       <font class="stringliteral">"to continue anyway, but results may be incorrect.  Rebuild "</font>
00454                                       <font class="stringliteral">"the library with this version of lclint."</font>, 
00455                                       name, vname));
00456                 }
00457               <font class="keywordflow">else</font>
00458                 {
00459                   <font class="keywordflow">if</font> ((fgets (buf, BUFLEN, f) == NULL))
00460                     {
00461                       <a class="code" href="llerror_c.html#a63">loadllmsg</a> (message (<font class="stringliteral">"Load library %s is not in LCLint library "</font>
00462                                           <font class="stringliteral">"format (missing library code). Attempting "</font>
00463                                           <font class="stringliteral">"to continue without library."</font>, name));
00464                       <font class="keywordflow">return</font> FALSE;
00465                     }
00466                   <font class="keywordflow">else</font> 
00467                     {
00468                       <font class="keywordtype">int</font> lib;
00469                       
00470                       <font class="keywordflow">if</font> (sscanf (buf, <font class="stringliteral">";;lib:%d"</font>, &amp;lib) != 1)
00471                         {
00472                           <a class="code" href="llerror_c.html#a63">loadllmsg</a> (message (<font class="stringliteral">"Load library %s is not in LCLint library "</font>
00473                                               <font class="stringliteral">"format (missing library code). Attempting "</font>
00474                                               <font class="stringliteral">"to continue without library."</font>, name));
00475                           <font class="keywordflow">return</font> FALSE;
00476                         }
00477                       <font class="keywordflow">else</font>
00478                         {
00479                           flagcode code = (flagcode) lib;
00480 
00481                           <font class="keywordflow">if</font> (flagcode_isLibraryFlag (code))
00482                             {
00483                               <font class="keywordflow">if</font> (<a class="code" href="context_c.html#a228">context_doMerge</a> ()) 
00484                                 {
00485                                   <a class="code" href="context_c.html#a56">context_setLibrary</a> (code);
00486                                 }
00487                             }
00488                           <font class="keywordflow">else</font>
00489                             {
00490                               <a class="code" href="llerror_c.html#a63">loadllmsg</a> (message (<font class="stringliteral">"Load library %s has invalid library code.  "</font>
00491                                                   <font class="stringliteral">"Attempting to continue without library."</font>,
00492                                                   name));
00493                               
00494                               <font class="keywordflow">return</font> FALSE;
00495                             }
00496                         }
00497                     }
00498                 }
00499             }
00500         }
00501     }
00502   <font class="keywordflow">else</font>
00503     {
00504       <a class="code" href="llerror_c.html#a63">loadllmsg</a> (message (<font class="stringliteral">"Load library %s is not in LCLint library format (missing lines).  "</font>
00505                           <font class="stringliteral">"Attempting to continue without library."</font>, name));
00506       <font class="keywordflow">return</font> FALSE;
00507     }
00508   
00509   <a class="code" href="ctype_c.html#a19">ctype_loadTable</a> (f);
00510   printDot ();
00511   
00512   <a class="code" href="typeIdSet_c.html#a10">typeIdSet_loadTable</a> (f);
00513   printDot ();
00514   
00515   <a class="code" href="usymtab_c.html#a81">usymtab_load</a> (f);
00516   printDot ();
00517   
00518   <a class="code" href="context_c.html#a58">context_loadModuleAccess</a> (f);
00519   printDot ();
00520   
00521   <font class="keywordflow">return</font> TRUE;
00522 }
00523 
00524 <font class="comment">/*</font>
00525 <font class="comment">** load state from file created by dumpState</font>
00526 <font class="comment">*/</font>
00527 
00528 <font class="keywordtype">void</font>
<a name="l00529"></a><a class="code" href="lcllib_c.html#a11">00529</a> <a class="code" href="lcllib_c.html#a11">loadState</a> (cstring cfname)<font class="keyword"></font>
00530 <font class="keyword"></font>{
00531   FILE *f;
00532   <font class="keywordtype">char</font> *fname = <a class="code" href="cstring_c.html#a29">cstring_toCharsSafe</a> (cfname);
00533   cstring ofname = <a class="code" href="cstring_c.html#a9">cstring_copy</a> (cfname);
00534 
00535   fname = <a class="code" href="general_c.html#a15">addExtension</a> (fname, DUMP_SUFFIX);
00536 
00537   f = fopen (fname, <font class="stringliteral">"r"</font>);
00538 
00539   <font class="keywordflow">if</font> (f == NULL)
00540     {
00541       <font class="keywordflow">if</font> (context_getDebug (FLG_SHOWSCAN))
00542         fprintf (g_msgstream, <font class="stringliteral">" &gt;\n"</font>);
00543 
00544       <a class="code" href="llerror_c.html#a48">llfatalerror</a> (message (<font class="stringliteral">"Cannot open dump file for loading: %s"</font>, cfname));
00545     }
00546   <font class="keywordflow">else</font>
00547     {
00548       <a class="code" href="fileloc_c.html#a9">fileloc_reallyFree</a> (g_currentloc);
00549       g_currentloc = <a class="code" href="fileloc_c.html#a23">fileloc_createLib</a> (ofname);
00550 
00551       <font class="keywordflow">if</font> (!loadStateFile (f, ofname)) 
00552         {
00553           <font class="keywordflow">if</font> (!<a class="code" href="lcllib_c.html#a10">loadStandardState</a> ()) 
00554             {
00555               <a class="code" href="ctype_c.html#a17">ctype_initTable</a> ();
00556             }
00557         }
00558       
00559       check (fclose (f) == 0);
00560     }
00561 
00562   <a class="code" href="cstring_c.html#a27">cstring_free</a> (ofname);
00563   <a class="code" href="general_c.html#a0">sfree</a> (fname);
00564 }
00565 
</div></pre><hr><address><small>Generated at Fri Nov 3 18:57:42 2000 for LCLint by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.3 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2000</small></address>
</body>
</html>
