<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>cppexp.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.3 on Fri Nov 3 18:57:39 2000 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>cppexp.c</h1><a href="cppexp_c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">** LCLint - annotation-assisted static program checker</font>
00003 <font class="comment">** Copyright (C) 1994-2000 University of Virginia,</font>
00004 <font class="comment">**         Massachusetts Institute of Technology</font>
00005 <font class="comment">**</font>
00006 <font class="comment">** This program is free software; you can redistribute it and/or modify it</font>
00007 <font class="comment">** under the terms of the GNU General Public License as published by the</font>
00008 <font class="comment">** Free Software Foundation; either version 2 of the License, or (at your</font>
00009 <font class="comment">** option) any later version.</font>
00010 <font class="comment">** </font>
00011 <font class="comment">** This program is distributed in the hope that it will be useful, but</font>
00012 <font class="comment">** WITHOUT ANY WARRANTY; without even the implied warranty of</font>
00013 <font class="comment">** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</font>
00014 <font class="comment">** General Public License for more details.</font>
00015 <font class="comment">** </font>
00016 <font class="comment">** The GNU General Public License is available from http://www.gnu.org/ or</font>
00017 <font class="comment">** the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston,</font>
00018 <font class="comment">** MA 02111-1307, USA.</font>
00019 <font class="comment">**</font>
00020 <font class="comment">** For information on lclint: lclint-request@cs.virginia.edu</font>
00021 <font class="comment">** To report a bug: lclint-bug@cs.virginia.edu</font>
00022 <font class="comment">** For more information: http://lclint.cs.virginia.edu</font>
00023 <font class="comment">*/</font>
00024 <font class="comment">/*</font>
00025 <font class="comment">** cppexp.c</font>
00026 <font class="comment">*/</font>
00027 <font class="comment">/* Parse C expressions for CCCP.</font>
00028 <font class="comment">   Copyright (C) 1987, 1992, 1994, 1995, 1997 Free Software Foundation.</font>
00029 <font class="comment"></font>
00030 <font class="comment">This program is free software; you can redistribute it and/or modify it</font>
00031 <font class="comment">under the terms of the GNU General Public License as published by the</font>
00032 <font class="comment">Free Software Foundation; either version 2, or (at your option) any</font>
00033 <font class="comment">later version.</font>
00034 <font class="comment"></font>
00035 <font class="comment">This program is distributed in the hope that it will be useful,</font>
00036 <font class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</font>
00037 <font class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</font>
00038 <font class="comment">GNU General Public License for more details.</font>
00039 <font class="comment"></font>
00040 <font class="comment">You should have received a copy of the GNU General Public License</font>
00041 <font class="comment">along with this program; if not, write to the Free Software</font>
00042 <font class="comment">Foundation, 59 Temple Place - Suite 330,</font>
00043 <font class="comment">Boston, MA 02111-1307, USA.</font>
00044 <font class="comment"></font>
00045 <font class="comment"> In other words, you are welcome to use, share and improve this program.</font>
00046 <font class="comment"> You are forbidden to forbid anyone else to use, share and improve</font>
00047 <font class="comment"> what you give them.   Help stamp out software-hoarding!</font>
00048 <font class="comment"></font>
00049 <font class="comment">Written by Per Bothner 1994.  */</font>
00050 
00051 <font class="comment">/* Parse a C expression from text in a string  */</font>
00052 
00053 <font class="comment">/*@+charint@*/</font>
00054 <font class="comment">/*@+ignorequals@*/</font>
00055 <font class="comment">/*@+ignoresigns@*/</font>
00056 <font class="comment">/*@+matchanyintegral@*/</font>
00057 <font class="comment">/*@-shiftsigned@*/</font>
00058 
00059 <font class="preprocessor"># include &lt;string.h&gt;</font> 
00060 <font class="preprocessor"># include "lclintMacros.nf"</font>
00061 <font class="preprocessor"># include "llbasic.h"</font>
00062 <font class="preprocessor"># include "cpp.h"</font>
00063 <font class="preprocessor"># include "cpplib.h"</font>
00064 <font class="preprocessor"># include "cpphash.h"</font>
00065 <font class="preprocessor"># include "cppexp.h"</font>
00066 <font class="preprocessor"># include "cpperror.h"</font>
00067 
00068 <font class="comment">/* Yield nonzero if adding two numbers with A's and B's signs can yield a</font>
00069 <font class="comment">   number with SUM's sign, where A, B, and SUM are all C integers.  */</font>
00070 
00071 <font class="comment">/*@function static bool possibleSumSign (sef int, int, int) </font>
00072 <font class="comment">      modifies nothing ; @*/</font>
00073 
<a name="l00074"></a><a class="code" href="cppexp_c.html#a0">00074</a> <font class="preprocessor">#define possibleSumSign(a, b, sum) ((((a) ^ (b)) | ~ ((a) ^ (sum))) &lt; 0)</font>
00075 <font class="preprocessor"></font>
00076 <font class="comment">/* these are guesses! */</font> 
00077 
00078 <font class="comment">/*@constant int BITS_PER_UNIT@*/</font>
<a name="l00079"></a><a class="code" href="cppexp_c.html#a1">00079</a> <font class="preprocessor"># define BITS_PER_UNIT 8</font>
00080 <font class="preprocessor"></font>
00081 <font class="comment">/*@constant size_t BITS_PER_CHAR@*/</font>
<a name="l00082"></a><a class="code" href="cppexp_c.html#a2">00082</a> <font class="preprocessor"># define BITS_PER_CHAR 8</font>
00083 <font class="preprocessor"></font>
00084 <font class="comment">/*@constant size_t BITS_PER_WORD@*/</font>
<a name="l00085"></a><a class="code" href="cppexp_c.html#a3">00085</a> <font class="preprocessor"># define BITS_PER_WORD 32</font>
00086 <font class="preprocessor"></font>
00087 <font class="comment">/*@constant size_t HOST_BITS_PER_INT@*/</font>
<a name="l00088"></a><a class="code" href="cppexp_c.html#a4">00088</a> <font class="preprocessor"># define HOST_BITS_PER_INT 32</font>
00089 <font class="preprocessor"></font>
00090 <font class="comment">/*@constant size_t HOST_BITS_PER_LONG@*/</font>
<a name="l00091"></a><a class="code" href="cppexp_c.html#a5">00091</a> <font class="preprocessor"># define HOST_BITS_PER_LONG 32</font>
00092 <font class="preprocessor"></font>
00093 <font class="comment">/*@constant char TARGET_BELL@*/</font>
<a name="l00094"></a><a class="code" href="cppexp_c.html#a6">00094</a> <font class="preprocessor"># define TARGET_BELL (char) 6 </font>
00095 <font class="preprocessor"></font>
00096 <font class="comment">/*@constant char TARGET_BS@*/</font>
<a name="l00097"></a><a class="code" href="cppexp_c.html#a7">00097</a> <font class="preprocessor"># define TARGET_BS   (char) 7</font>
00098 <font class="preprocessor"></font>
00099 <font class="comment">/*@constant char TARGET_FF@*/</font>
<a name="l00100"></a><a class="code" href="cppexp_c.html#a8">00100</a> <font class="preprocessor"># define TARGET_FF   (char) 8</font>
00101 <font class="preprocessor"></font>
00102 <font class="comment">/*@constant char TARGET_NEWLINE@*/</font>
<a name="l00103"></a><a class="code" href="cppexp_c.html#a9">00103</a> <font class="preprocessor"># define TARGET_NEWLINE '\n' </font>
00104 <font class="preprocessor"></font>
00105 <font class="comment">/*@constant char TARGET_CR@*/</font>
<a name="l00106"></a><a class="code" href="cppexp_c.html#a10">00106</a> <font class="preprocessor"># define TARGET_CR '\n'</font>
00107 <font class="preprocessor"></font>
00108 <font class="comment">/*@constant char TARGET_TAB@*/</font>
<a name="l00109"></a><a class="code" href="cppexp_c.html#a11">00109</a> <font class="preprocessor"># define TARGET_TAB '\t'</font>
00110 <font class="preprocessor"></font>
00111 <font class="comment">/*@constant char TARGET_VT@*/</font>
<a name="l00112"></a><a class="code" href="cppexp_c.html#a12">00112</a> <font class="preprocessor"># define TARGET_VT '\v'</font>
00113 <font class="preprocessor"></font>
00114 <font class="preprocessor">#ifdef MULTIBYTE_CHARS</font>
00115 <font class="preprocessor"></font><font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00116 <font class="preprocessor">#include &lt;locale.h&gt;</font>
00117 <font class="preprocessor">#endif</font>
00118 <font class="preprocessor"></font>
00119 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00120 
00121 <font class="preprocessor">#ifndef INT_TYPE_SIZE</font>
00122 <font class="preprocessor"></font><font class="comment">/*@constant size_t INT_TYPE_SIZE@*/</font>
<a name="l00123"></a><a class="code" href="cppexp_c.html#a13">00123</a> <font class="preprocessor">#define INT_TYPE_SIZE BITS_PER_WORD</font>
00124 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00125 <font class="preprocessor"></font>
00126 <font class="preprocessor">#ifndef LONG_TYPE_SIZE</font>
00127 <font class="preprocessor"></font><font class="comment">/*@constant size_t LONG_TYPE_SIZE@*/</font>
<a name="l00128"></a><a class="code" href="cppexp_c.html#a14">00128</a> <font class="preprocessor">#define LONG_TYPE_SIZE BITS_PER_WORD</font>
00129 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00130 <font class="preprocessor"></font>
00131 <font class="preprocessor">#ifndef WCHAR_TYPE_SIZE</font>
00132 <font class="preprocessor"></font><font class="comment">/*@constant size_t WCHAR_TYPE_SIZE@*/</font>
<a name="l00133"></a><a class="code" href="cppexp_c.html#a15">00133</a> <font class="preprocessor">#define WCHAR_TYPE_SIZE INT_TYPE_SIZE</font>
00134 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00135 <font class="preprocessor"></font>
00136 <font class="preprocessor"># ifndef CHAR_TYPE_SIZE</font>
00137 <font class="preprocessor"></font><font class="comment">/*@constant size_t CHAR_TYPE_SIZE@*/</font>
<a name="l00138"></a><a class="code" href="cppexp_c.html#a16">00138</a> <font class="preprocessor"># define CHAR_TYPE_SIZE BITS_PER_CHAR</font>
00139 <font class="preprocessor"></font><font class="preprocessor"># endif</font>
00140 <font class="preprocessor"></font>
00141 <font class="preprocessor">#ifndef MAX_CHAR_TYPE_SIZE</font>
00142 <font class="preprocessor"></font><font class="comment">/*@constant size_t MAX_CHAR_TYPE_SIZE@*/</font>
<a name="l00143"></a><a class="code" href="cppexp_c.html#a17">00143</a> <font class="preprocessor">#define MAX_CHAR_TYPE_SIZE CHAR_TYPE_SIZE</font>
00144 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00145 <font class="preprocessor"></font>
00146 <font class="preprocessor">#ifndef MAX_LONG_TYPE_SIZE</font>
00147 <font class="preprocessor"></font><font class="comment">/*@constant size_t MAX_LONG_TYPE_SIZE@*/</font>
<a name="l00148"></a><a class="code" href="cppexp_c.html#a18">00148</a> <font class="preprocessor">#define MAX_LONG_TYPE_SIZE LONG_TYPE_SIZE</font>
00149 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00150 <font class="preprocessor"></font>
00151 <font class="preprocessor">#ifndef MAX_WCHAR_TYPE_SIZE</font>
00152 <font class="preprocessor"></font><font class="comment">/*@constant size_t MAX_WCHAR_TYPE_SIZE@*/</font>
<a name="l00153"></a><a class="code" href="cppexp_c.html#a19">00153</a> <font class="preprocessor">#define MAX_WCHAR_TYPE_SIZE WCHAR_TYPE_SIZE</font>
00154 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00155 <font class="preprocessor"></font>
00156 <font class="keyword">static</font> <font class="keyword">struct </font><a class="code" href="struct_operation.html">operation</a> cppReader_lex (cppReader *);
00157 <font class="keyword">static</font> <font class="keywordtype">void</font> integer_overflow (cppReader *);
00158 <font class="keyword">static</font> <font class="keywordtype">long</font> left_shift (cppReader *, <font class="keywordtype">long</font>, <font class="keywordtype">bool</font> p_unsignedp, size_t);
00159 <font class="keyword">static</font> <font class="keywordtype">long</font> right_shift (<font class="keywordtype">long</font>, <font class="keywordtype">bool</font> p_unsignedp, <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font>);
00160 
00161 <font class="comment">/*@constant short CPPREADER_ERRORTOK@*/</font>
<a name="l00162"></a><a class="code" href="cppexp_c.html#a20">00162</a> <font class="preprocessor">#define CPPREADER_ERRORTOK 299</font>
00163 <font class="preprocessor"></font>
00164 <font class="comment">/*@constant int OROR@*/</font>
<a name="l00165"></a><a class="code" href="cppexp_c.html#a21">00165</a> <font class="preprocessor">#define OROR 300</font>
00166 <font class="preprocessor"></font>
00167 <font class="comment">/*@constant int ANDAND@*/</font>
<a name="l00168"></a><a class="code" href="cppexp_c.html#a22">00168</a> <font class="preprocessor">#define ANDAND 301</font>
00169 <font class="preprocessor"></font>
00170 <font class="comment">/*@constant int CPP_EQUALTOK@*/</font>
<a name="l00171"></a><a class="code" href="cppexp_c.html#a23">00171</a> <font class="preprocessor">#define CPP_EQUALTOK 302</font>
00172 <font class="preprocessor"></font>
00173 <font class="comment">/*@constant int NOTEQUAL@*/</font>
<a name="l00174"></a><a class="code" href="cppexp_c.html#a24">00174</a> <font class="preprocessor">#define NOTEQUAL 303</font>
00175 <font class="preprocessor"></font>
00176 <font class="comment">/*@constant int LEQ@*/</font>
<a name="l00177"></a><a class="code" href="cppexp_c.html#a25">00177</a> <font class="preprocessor">#define LEQ 304</font>
00178 <font class="preprocessor"></font>
00179 <font class="comment">/*@constant int GEQ@*/</font>
<a name="l00180"></a><a class="code" href="cppexp_c.html#a26">00180</a> <font class="preprocessor">#define GEQ 305</font>
00181 <font class="preprocessor"></font>
00182 <font class="comment">/*@constant int LSH@*/</font>
<a name="l00183"></a><a class="code" href="cppexp_c.html#a27">00183</a> <font class="preprocessor">#define LSH 306</font>
00184 <font class="preprocessor"></font>
00185 <font class="comment">/*@constant int RSH@*/</font>
<a name="l00186"></a><a class="code" href="cppexp_c.html#a28">00186</a> <font class="preprocessor">#define RSH 307</font>
00187 <font class="preprocessor"></font>
00188 <font class="comment">/*@constant int NAME@*/</font>
<a name="l00189"></a><a class="code" href="cppexp_c.html#a29">00189</a> <font class="preprocessor">#define NAME 308</font>
00190 <font class="preprocessor"></font>
00191 <font class="comment">/*@constant short CPPEXP_INT@*/</font>
<a name="l00192"></a><a class="code" href="cppexp_c.html#a30">00192</a> <font class="preprocessor">#define CPPEXP_INT 309</font>
00193 <font class="preprocessor"></font>
00194 <font class="comment">/*@constant short CPPEXP_CHAR@*/</font>
<a name="l00195"></a><a class="code" href="cppexp_c.html#a31">00195</a> <font class="preprocessor">#define CPPEXP_CHAR 310</font>
00196 <font class="preprocessor"></font>
00197 <font class="comment">/*@constant int LEFT_OPERAND_REQUIRED@*/</font>
<a name="l00198"></a><a class="code" href="cppexp_c.html#a32">00198</a> <font class="preprocessor">#define LEFT_OPERAND_REQUIRED 1</font>
00199 <font class="preprocessor"></font>
00200 <font class="comment">/*@constant int RIGHT_OPERAND_REQUIRED@*/</font>
<a name="l00201"></a><a class="code" href="cppexp_c.html#a33">00201</a> <font class="preprocessor">#define RIGHT_OPERAND_REQUIRED 2</font>
00202 <font class="preprocessor"></font>
00203 <font class="comment">/*@constant int HAVE_VALUE@*/</font>
<a name="l00204"></a><a class="code" href="cppexp_c.html#a34">00204</a> <font class="preprocessor">#define HAVE_VALUE 4</font>
00205 <font class="preprocessor"></font>
00206 <font class="preprocessor">#ifndef HOST_BITS_PER_WIDE_INT</font>
00207 <font class="preprocessor"></font>
00208 <font class="preprocessor">#if HOST_BITS_PER_LONG &gt; HOST_BITS_PER_INT</font>
00209 <font class="preprocessor"></font><font class="comment">/*@constant int HOST_BITS_PER_WIDE_INT@*/</font>
00210 <font class="preprocessor">#define HOST_BITS_PER_WIDE_INT HOST_BITS_PER_LONG</font>
00211 <font class="preprocessor"></font><font class="comment">/*@notfunction@*/</font>
00212 <font class="preprocessor">#define HOST_WIDE_INT long</font>
00213 <font class="preprocessor"></font><font class="preprocessor">#else</font>
00214 <font class="preprocessor"></font><font class="comment">/*@constant int HOST_BITS_PER_WIDE_INT@*/</font>
<a name="l00215"></a><a class="code" href="cppexp_c.html#a35">00215</a> <font class="preprocessor">#define HOST_BITS_PER_WIDE_INT HOST_BITS_PER_INT</font>
00216 <font class="preprocessor"></font><font class="comment">/*@notfunction@*/</font>
<a name="l00217"></a><a class="code" href="cppexp_c.html#a36">00217</a> <font class="preprocessor">#define HOST_WIDE_INT long</font>
00218 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00219 <font class="preprocessor"></font>
00220 <font class="preprocessor">#endif</font>
00221 <font class="preprocessor"></font>
<a name="l00222"></a><a class="code" href="struct_operation.html">00222</a> <font class="keyword">struct </font><a class="code" href="struct_operation.html">operation</a> {
<a name="l00223"></a><a class="code" href="struct_operation.html#m0">00223</a>   <font class="keywordtype">short</font> op;
00224 
00225   <font class="comment">/* Priority of op (relative to it right operand).  */</font>
<a name="l00226"></a><a class="code" href="struct_operation.html#m1">00226</a>   <font class="comment">/*@reldef@*/</font> <font class="keywordtype">char</font> rprio;
00227 
<a name="l00228"></a><a class="code" href="struct_operation.html#m2">00228</a>   <font class="comment">/*@reldef@*/</font> <font class="keywordtype">char</font> flags;
00229 
00230   <font class="comment">/* true if value should be treated as unsigned */</font>
<a name="l00231"></a><a class="code" href="struct_operation.html#m3">00231</a>   <font class="comment">/*@reldef@*/</font> <font class="keywordtype">bool</font> unsignedp;
00232 
00233   <font class="comment">/* The value logically "right" of op.  */</font>
<a name="l00234"></a><a class="code" href="struct_operation.html#m4">00234</a>   <font class="comment">/*@reldef@*/</font> HOST_WIDE_INT value;
00235 } ;
00236 
00237 <font class="comment">/* Take care of parsing a number (anything that starts with a digit).</font>
00238 <font class="comment">   LEN is the number of characters in it.  */</font>
00239 
00240 <font class="comment">/* maybe needs to actually deal with floating point numbers */</font>
00241 
00242 <font class="keyword">struct </font><a class="code" href="struct_operation.html">operation</a>
<a name="l00243"></a><a class="code" href="cppexp_c.html#a60">00243</a> cppReader_parseNumber (cppReader *pfile, char *start, int olen)
00244 {
00245   <font class="keyword">struct </font><a class="code" href="struct_operation.html">operation</a> op;
00246   <font class="keywordtype">char</font> *p = start;
00247   <font class="keywordtype">char</font> c;
00248   <font class="keywordtype">int</font> i;
00249   <font class="keywordtype">long</font> n = 0;
00250   <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> nd, ULONG_MAX_over_base;
00251   <font class="keywordtype">int</font> base = 10;
00252   <font class="keywordtype">int</font> len = olen;
00253   <font class="keywordtype">bool</font> overflow = FALSE;
00254   <font class="keywordtype">int</font> digit, largest_digit = 0;
00255   <font class="keywordtype">bool</font> spec_long = FALSE;
00256 
00257   op.unsignedp = FALSE;
00258 
00259   <font class="keywordflow">for</font> (i = 0; i &lt; len; i++)
00260     {
00261       <font class="keywordflow">if</font> (p[i] == <font class="charliteral">'.'</font>) {
00262         <font class="comment">/* It's a float since it contains a point.  */</font>
00263         cppReader_errorLit
00264           (pfile,
00265            cstring_makeLiteralTemp
00266            (<font class="stringliteral">"Floating point numbers not allowed in #if expressions"</font>));
00267         op.op = CPPREADER_ERRORTOK;
00268         <font class="keywordflow">return</font> op;
00269       }
00270     }
00271       
00272   <font class="keywordflow">if</font> (len &gt;= 3 &amp;&amp; (<a class="code" href="general_c.html#a39">mstring_equalPrefix</a> (p, <font class="stringliteral">"0x"</font>) 
00273                    || <a class="code" href="general_c.html#a39">mstring_equalPrefix</a> (p, <font class="stringliteral">"0X"</font>)))
00274     {
00275       p += 2;
00276       base = 16;
00277       len -= 2;
00278     }
00279   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (*p == <font class="charliteral">'0'</font>)
00280     {
00281       base = 8;
00282     }
00283   <font class="keywordflow">else</font>
00284     {
00285       ;
00286     }
00287 
00288   <font class="comment">/* Some buggy compilers (e.g. MPW C) seem to need both casts.  */</font>
00289   ULONG_MAX_over_base = ((<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font>) -1) / ((<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font>) base);
00290 
00291   <font class="keywordflow">for</font> (; len &gt; 0; len--) {
00292     c = *p++;
00293 
00294     <font class="keywordflow">if</font> (c &gt;= <font class="charliteral">'0'</font> &amp;&amp; c &lt;= <font class="charliteral">'9'</font>)
00295       {
00296         digit = (<font class="keywordtype">int</font>) (c - <font class="charliteral">'0'</font>);
00297       }
00298     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (base == 16 &amp;&amp; c &gt;= <font class="charliteral">'a'</font> &amp;&amp; c &lt;= <font class="charliteral">'f'</font>)
00299       {
00300         digit = (<font class="keywordtype">int</font>) (c - <font class="charliteral">'a'</font>) + 10;
00301       }
00302     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (base == 16 &amp;&amp; c &gt;= <font class="charliteral">'A'</font> &amp;&amp; c &lt;= <font class="charliteral">'F'</font>)
00303       {
00304         digit = (<font class="keywordtype">int</font>) (c - <font class="charliteral">'A'</font>) + 10;
00305       }
00306     <font class="keywordflow">else</font> 
00307       {
00308         <font class="comment">/* `l' means long, and `u' means unsigned.  */</font>
00309         <font class="keywordflow">while</font> (TRUE)
00310           {
00311             <font class="keywordflow">if</font> (c == <font class="charliteral">'l'</font> || c == <font class="charliteral">'L'</font>)
00312               {
00313                 <font class="keywordflow">if</font> (spec_long)
00314                   <a class="code" href="cpperror_c.html#a8">cppReader_errorLit</a> (pfile,
00315                                       cstring_makeLiteralTemp (<font class="stringliteral">"two `l's in integer constant"</font>));
00316                 spec_long = TRUE;
00317               }
00318             <font class="keywordflow">else</font> <font class="keywordflow">if</font> (c == <font class="charliteral">'u'</font> || c == <font class="charliteral">'U'</font>)
00319               {
00320                 <font class="keywordflow">if</font> (op.unsignedp)
00321                   <a class="code" href="cpperror_c.html#a8">cppReader_errorLit</a> (pfile, 
00322                                       cstring_makeLiteralTemp (<font class="stringliteral">"two `u's in integer constant"</font>));
00323                 op.unsignedp = TRUE;
00324               }
00325             <font class="keywordflow">else</font>
00326               {
00327                 <font class="comment">/*@innerbreak@*/</font> <font class="keywordflow">break</font>;
00328               }
00329             
00330             <font class="keywordflow">if</font> (--len == 0)
00331               {
00332                 <font class="comment">/*@innerbreak@*/</font> <font class="keywordflow">break</font>;
00333               }
00334 
00335             c = *p++;
00336           }
00337         <font class="comment">/* Don't look for any more digits after the suffixes.  */</font>
00338         <font class="keywordflow">break</font>;
00339       }
00340     
00341     <font class="keywordflow">if</font> (largest_digit &lt; digit)
00342       {
00343         largest_digit = digit;
00344       }
00345     
00346     nd = (<font class="keywordtype">long</font> <font class="keywordtype">unsigned</font>) (n * base + digit);
00347     overflow |= (ULONG_MAX_over_base &lt; (<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font>) n) 
00348       | (nd &lt; (<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font>) n);
00349     n = (<font class="keywordtype">long</font>) nd;
00350   }
00351 
00352   <font class="keywordflow">if</font> (len != 0)
00353     {
00354       cppReader_errorLit 
00355         (pfile, 
00356          cstring_makeLiteralTemp (<font class="stringliteral">"Invalid number in #if expression"</font>));
00357       op.op = CPPREADER_ERRORTOK;
00358       <font class="keywordflow">return</font> op;
00359     }
00360   
00361   <font class="keywordflow">if</font> (base &lt;= largest_digit)
00362     {
00363       cppReader_pedwarnLit 
00364         (pfile, 
00365          cstring_makeLiteralTemp 
00366          (<font class="stringliteral">"Integer constant contains digits beyond the radix"</font>));
00367     }
00368   
00369   <font class="keywordflow">if</font> (overflow)
00370     {
00371       cppReader_pedwarnLit
00372         (pfile, 
00373          cstring_makeLiteralTemp (<font class="stringliteral">"Integer constant out of range"</font>));
00374     }
00375 
00376   <font class="comment">/* If too big to be signed, consider it unsigned.  */</font>
00377   <font class="keywordflow">if</font> ((<font class="keywordtype">long</font>) n &lt; 0 &amp;&amp; ! op.unsignedp)
00378     {
00379       <font class="keywordflow">if</font> (base == 10)
00380         {
00381           cppReader_warningLit
00382             (pfile,
00383              cstring_makeLiteralTemp (<font class="stringliteral">"Integer constant is so large that it is unsigned"</font>));
00384         }
00385          
00386       op.unsignedp = TRUE;
00387     }
00388   
00389   op.value = n;
00390   op.op = CPPEXP_INT;
00391   <font class="keywordflow">return</font> op;
00392 }
00393 
<a name="l00394"></a><a class="code" href="struct_token.html">00394</a> <font class="keyword">struct </font><a class="code" href="struct_token.html">token</a> {
00395   <font class="comment">/*@null@*/</font> <font class="comment">/*@observer@*/</font> <font class="keywordtype">char</font> *<font class="keyword">operator</font>;
00396   <font class="keywordtype">int</font> <a class="code" href="struct_token.html">token</a>;
00397 };
00398 
00399 <font class="keyword">static</font> <font class="keyword">struct </font><a class="code" href="struct_token.html">token</a> tokentab2[] = {
00400   { <font class="stringliteral">"&amp;&amp;"</font>, ANDAND },
00401   { <font class="stringliteral">"||"</font>, OROR },
00402   { <font class="stringliteral">"&lt;&lt;"</font>, LSH },
00403   { <font class="stringliteral">"&gt;&gt;"</font>, RSH },
00404   { <font class="stringliteral">"=="</font>, CPP_EQUALTOK },
00405   { <font class="stringliteral">"!="</font>, NOTEQUAL },
00406   { <font class="stringliteral">"&lt;="</font>, LEQ },
00407   { <font class="stringliteral">"&gt;="</font>, GEQ },
00408   { <font class="stringliteral">"++"</font>, CPPREADER_ERRORTOK },
00409   { <font class="stringliteral">"--"</font>, CPPREADER_ERRORTOK },
00410   { NULL, CPPREADER_ERRORTOK }
00411 } ;
00412 
00413 <font class="comment">/* Read one token.  */</font>
00414 
00415 <font class="keyword">struct </font><a class="code" href="struct_operation.html">operation</a> cppReader_lex (cppReader *pfile)
00416 {
00417   <font class="keywordtype">int</font> ic;
00418   <font class="keywordtype">char</font> c;
00419   <font class="keyword">register</font> <font class="keyword">struct </font><a class="code" href="struct_token.html">token</a> *toktab;
00420   <font class="keyword">enum</font> cpp_token <a class="code" href="struct_token.html">token</a>;
00421   <font class="keyword">struct </font><a class="code" href="struct_operation.html">operation</a> op;
00422   <font class="keywordtype">char</font> *tok_start, *tok_end;
00423   <font class="keywordtype">int</font> old_written;
00424 
00425  retry:
00426 
00427   old_written = <a class="code" href="general_c.html#a34">size_toInt</a> (cppReader_getWritten (pfile));
00428   <a class="code" href="cpplib_c.html#a114">cppSkipHspace</a> (pfile);
00429   ic = <a class="code" href="cpplib_c.html#a148">cppBufPeek</a> (cppReader_getBufferSafe (pfile));
00430 
00431   c = (<font class="keywordtype">char</font>) ic;
00432   llassert (c != <font class="charliteral">'#'</font>);
00433   
00434   <font class="keywordflow">if</font> (c == <font class="charliteral">'\n'</font>)
00435     {
00436       op.op = 0;
00437       <font class="keywordflow">return</font> op;
00438     }
00439 
00440   <a class="code" href="struct_token.html">token</a> = <a class="code" href="cpplib_c.html#a141">cppGetToken</a> (pfile);
00441   tok_start = pfile-&gt;token_buffer + old_written;
00442   tok_end = cppReader_getPWritten (pfile);
00443   pfile-&gt;limit = tok_start;
00444 
00445   <font class="keywordflow">switch</font> (<a class="code" href="struct_token.html">token</a>)
00446   {
00447     <font class="keywordflow">case</font> CPP_EOF: <font class="comment">/* Should not happen ...  */</font>
00448     <font class="keywordflow">case</font> CPP_VSPACE:
00449       op.op = 0;
00450       <font class="keywordflow">return</font> op;
00451     <font class="keywordflow">case</font> CPP_POP:
00452       <font class="keywordflow">if</font> (cstring_isDefined (cppReader_getBufferSafe (pfile)-&gt;fname))
00453         {
00454           op.op = 0;
00455           <font class="keywordflow">return</font> op;
00456         }
00457       (<font class="keywordtype">void</font>) <a class="code" href="cpplib_c.html#a122">cppReader_popBuffer</a> (pfile);
00458       <font class="keywordflow">goto</font> retry;
00459     <font class="keywordflow">case</font> CPP_HSPACE:   <font class="keywordflow">case</font> CPP_COMMENT: 
00460       <font class="keywordflow">goto</font> retry;
00461     <font class="keywordflow">case</font> CPP_NUMBER:
00462       <font class="keywordflow">return</font> <a class="code" href="cppexp_c.html#a60">cppReader_parseNumber</a> (pfile, tok_start, tok_end - tok_start);
00463     <font class="keywordflow">case</font> CPP_STRING:
00464       <a class="code" href="cpperror_c.html#a8">cppReader_errorLit</a> (pfile, 
00465                     cstring_makeLiteralTemp (<font class="stringliteral">"string constants not allowed in #if expressions"</font>));
00466       op.op = CPPREADER_ERRORTOK;
00467       <font class="keywordflow">return</font> op;
00468     <font class="keywordflow">case</font> CPP_CHAR:
00469       <font class="comment">/* This code for reading a character constant</font>
00470 <font class="comment">         handles multicharacter constants and wide characters.</font>
00471 <font class="comment">         It is mostly copied from c-lex.c.  */</font>
00472       {
00473         <font class="keywordtype">int</font> result = 0;
00474         <font class="keywordtype">int</font> num_chars = 0;
00475         size_t width = MAX_CHAR_TYPE_SIZE;
00476         <font class="keywordtype">int</font> wide_flag = 0;
00477         <font class="keywordtype">int</font> max_chars;
00478         <font class="keywordtype">char</font> *ptr = tok_start;
00479 <font class="preprocessor">#ifdef MULTIBYTE_CHARS</font>
00480 <font class="preprocessor"></font>        <font class="keywordtype">char</font> token_buffer[MAX_LONG_TYPE_SIZE/MAX_CHAR_TYPE_SIZE + MB_CUR_MAX];
00481 <font class="preprocessor">#else</font>
00482 <font class="preprocessor"></font>        <font class="keywordtype">char</font> token_buffer[MAX_LONG_TYPE_SIZE/MAX_CHAR_TYPE_SIZE + 1];
00483 <font class="preprocessor">#endif</font>
00484 <font class="preprocessor"></font>
00485         <font class="keywordflow">if</font> (*ptr == <font class="charliteral">'L'</font>)
00486           {
00487             ptr++;
00488             wide_flag = 1;
00489             width = MAX_WCHAR_TYPE_SIZE;
00490 <font class="preprocessor">#ifdef MULTIBYTE_CHARS</font>
00491 <font class="preprocessor"></font>            max_chars = MB_CUR_MAX;
00492 <font class="preprocessor">#else</font>
00493 <font class="preprocessor"></font>            max_chars = 1;
00494 <font class="preprocessor">#endif</font>
00495 <font class="preprocessor"></font>          }
00496         <font class="keywordflow">else</font>
00497           {
00498             max_chars = <a class="code" href="general_c.html#a34">size_toInt</a> (MAX_LONG_TYPE_SIZE / width);
00499           }
00500 
00501         ++ptr;
00502         <font class="keywordflow">while</font> (ptr &lt; tok_end &amp;&amp; ((c = *ptr++) != <font class="charliteral">'\''</font>))
00503           {
00504             <font class="keywordflow">if</font> (c == <font class="charliteral">'\\'</font>)
00505               {
00506                 c = <a class="code" href="cppexp_c.html#a61">cppReader_parseEscape</a> (pfile, &amp;ptr);
00507                 <font class="keywordflow">if</font> (width &lt; HOST_BITS_PER_INT &amp;&amp; c &gt;= (1 &lt;&lt; width))
00508                   {
00509                     cppReader_pedwarnLit 
00510                       (pfile,
00511                        cstring_makeLiteralTemp (<font class="stringliteral">"Escape sequence out of range for character"</font>));
00512                   }
00513               }
00514                 
00515             num_chars++;
00516             
00517             <font class="comment">/* Merge character into result; ignore excess chars.  */</font>
00518             <font class="keywordflow">if</font> (num_chars &lt; max_chars + 1)
00519               {
00520                 <font class="keywordflow">if</font> (width &lt; HOST_BITS_PER_INT)
00521                   {
00522                     result = (<font class="keywordtype">int</font>) ((<font class="keywordtype">unsigned</font>) result &lt;&lt; width) | (c &amp; ((1 &lt;&lt; width) - 1));
00523                   }
00524                 <font class="keywordflow">else</font>
00525                   {
00526                     result = c;
00527                   }
00528 
00529                 token_buffer[num_chars - 1] = c;
00530               }
00531           }
00532 
00533         token_buffer[num_chars] = 0;
00534 
00535         <font class="keywordflow">if</font> (c != <font class="charliteral">'\''</font>)
00536           <a class="code" href="cpperror_c.html#a8">cppReader_errorLit</a> (pfile,
00537                         cstring_makeLiteralTemp (<font class="stringliteral">"malformatted character constant"</font>));
00538         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (num_chars == 0)
00539           <a class="code" href="cpperror_c.html#a8">cppReader_errorLit</a> (pfile, 
00540                         cstring_makeLiteralTemp (<font class="stringliteral">"empty character constant"</font>));
00541         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (num_chars &gt; max_chars)
00542           {
00543             num_chars = max_chars;
00544             <a class="code" href="cpperror_c.html#a8">cppReader_errorLit</a> (pfile, 
00545                           cstring_makeLiteralTemp (<font class="stringliteral">"character constant too long"</font>));
00546           }
00547         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (num_chars != 1 &amp;&amp; ! cppReader_isTraditional (pfile))
00548           {
00549             <a class="code" href="cpperror_c.html#a10">cppReader_warningLit</a> (pfile, 
00550                             cstring_makeLiteralTemp (<font class="stringliteral">"multi-character character constant"</font>));
00551           }
00552         <font class="keywordflow">else</font>
00553           {
00554             ;
00555           }
00556 
00557         <font class="comment">/* If char type is signed, sign-extend the constant.  */</font>
00558         <font class="keywordflow">if</font> (wide_flag == 0)
00559           {
00560             <font class="keywordtype">int</font> num_bits = num_chars * width;
00561 
00562             <font class="keywordflow">if</font> ((<a class="code" href="cpphash_c.html#a10">cppReader_lookup</a> (<font class="stringliteral">"__CHAR_UNSIGNED__"</font>,
00563                              <font class="keyword">sizeof</font> (<font class="stringliteral">"__CHAR_UNSIGNED__"</font>) - 1, -1) != NULL)
00564                 || (((<font class="keywordtype">unsigned</font>) result &gt;&gt; (num_bits - 1)) &amp; 1) == 0)
00565               {
00566                 op.value
00567                   = result &amp; ((<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font>) ~0 &gt;&gt; (HOST_BITS_PER_LONG - num_bits));
00568               }
00569             <font class="keywordflow">else</font>
00570               {
00571                 op.value
00572                   = result | ~((<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font>) ~0 &gt;&gt; (HOST_BITS_PER_LONG - num_bits));
00573               }
00574           }
00575         <font class="keywordflow">else</font>
00576           {
00577 <font class="preprocessor">#ifdef MULTIBYTE_CHARS</font>
00578 <font class="preprocessor"></font>            <font class="comment">/* Set the initial shift state and convert the next sequence.  */</font>
00579               result = 0;
00580               <font class="comment">/* In all locales L'\0' is zero and mbtowc will return zero,</font>
00581 <font class="comment">                 so don't use it.  */</font>
00582               <font class="keywordflow">if</font> (num_chars &gt; 1
00583                   || (num_chars == 1 &amp;&amp; token_buffer[0] != <font class="charliteral">'\0'</font>))
00584                 {
00585                   <font class="keywordtype">wchar_t</font> wc;
00586                   (<font class="keywordtype">void</font>) mbtowc (NULL, NULL, 0);
00587                   <font class="keywordflow">if</font> (mbtowc (&amp; wc, token_buffer, num_chars) == num_chars)
00588                     result = wc;
00589                   <font class="keywordflow">else</font>
00590                     <a class="code" href="cpperror_c.html#a13">cppReader_pedwarn</a> (pfile,<font class="stringliteral">"Ignoring invalid multibyte character"</font>);
00591                 }
00592 <font class="preprocessor">#endif</font>
00593 <font class="preprocessor"></font>              op.value = result;
00594             }
00595         }
00596 
00597       <font class="comment">/* This is always a signed type.  */</font>
00598       op.unsignedp = FALSE;
00599       op.op = CPPEXP_CHAR;
00600     
00601       <font class="keywordflow">return</font> op;
00602 
00603     <font class="keywordflow">case</font> CPP_NAME:
00604       <font class="keywordflow">return</font> <a class="code" href="cppexp_c.html#a60">cppReader_parseNumber</a> (pfile, <font class="stringliteral">"0"</font>, 0);
00605 
00606     <font class="keywordflow">case</font> CPP_OTHER:
00607       <font class="comment">/* See if it is a special token of length 2.  */</font>
00608       <font class="keywordflow">if</font> (tok_start + 2 == tok_end)
00609         {
00610           <font class="keywordflow">for</font> (toktab = tokentab2; toktab-&gt;operator != NULL; toktab++)
00611             {
00612               <font class="keywordflow">if</font> (tok_start[0] == toktab-&gt;operator[0]
00613                   &amp;&amp; tok_start[1] == toktab-&gt;operator[1])
00614                 {
00615                   <font class="comment">/*@loopbreak@*/</font> <font class="keywordflow">break</font>;
00616                 }
00617             }
00618 
00619           <font class="keywordflow">if</font> (toktab-&gt;token == CPPREADER_ERRORTOK)
00620             {
00621               <a class="code" href="cpperror_c.html#a9">cppReader_error</a> (pfile, message (<font class="stringliteral">"`%s' not allowed in operand of `#if'"</font>, cstring_fromChars (tok_start)));
00622             }
00623 
00624           op.op = toktab-&gt;token; 
00625           <font class="keywordflow">return</font> op;
00626         }
00627       <font class="comment">/*@fallthrough@*/</font> 
00628     <font class="keywordflow">default</font>:
00629       op.op = *tok_start;
00630       <font class="keywordflow">return</font> op;
00631   }
00632 
00633   BADEXIT;
00634   <font class="comment">/*@notreached@*/</font> 
00635 }
00636 
00637 
00638 <font class="comment">/* Parse a C escape sequence.  STRING_PTR points to a variable</font>
00639 <font class="comment">   containing a pointer to the string to parse.  That pointer</font>
00640 <font class="comment">   is updated past the characters we use.  The value of the</font>
00641 <font class="comment">   escape sequence is returned.</font>
00642 <font class="comment"></font>
00643 <font class="comment">   A negative value means the sequence \ newline was seen,</font>
00644 <font class="comment">   which is supposed to be equivalent to nothing at all.</font>
00645 <font class="comment"></font>
00646 <font class="comment">   If \ is followed by a null character, we return a negative</font>
00647 <font class="comment">   value and leave the string pointer pointing at the null character.</font>
00648 <font class="comment"></font>
00649 <font class="comment">   If \ is followed by 000, we return 0 and leave the string pointer</font>
00650 <font class="comment">   after the zeros.  A value of 0 does not mean end of string.  */</font>
00651 
00652 <font class="keywordtype">int</font>
<a name="l00653"></a><a class="code" href="cppexp_c.html#a61">00653</a> <a class="code" href="cppexp_c.html#a61">cppReader_parseEscape</a> (cppReader *pfile, <font class="keywordtype">char</font> **string_ptr)<font class="keyword"></font>
00654 <font class="keyword"></font>{
00655   <font class="keywordtype">char</font> c = *(*string_ptr)++;
00656 
00657   <font class="keywordflow">switch</font> (c)
00658     {
00659     <font class="keywordflow">case</font> <font class="charliteral">'a'</font>:
00660       <font class="keywordflow">return</font> TARGET_BELL;
00661     <font class="keywordflow">case</font> <font class="charliteral">'b'</font>:
00662       <font class="keywordflow">return</font> TARGET_BS;
00663     <font class="keywordflow">case</font> <font class="charliteral">'e'</font>:
00664     <font class="keywordflow">case</font> <font class="charliteral">'E'</font>:
00665       <font class="keywordflow">if</font> (cppReader_isPedantic (pfile))
00666         {
00667           <a class="code" href="cpperror_c.html#a13">cppReader_pedwarn</a> (pfile, 
00668                        message (<font class="stringliteral">"non-ANSI-standard escape sequence, `\\%c'"</font>, c));
00669         }
00670       <font class="keywordflow">return</font> (<font class="keywordtype">char</font>) 033;
00671     <font class="keywordflow">case</font> <font class="charliteral">'f'</font>:
00672       <font class="keywordflow">return</font> TARGET_FF;
00673     <font class="keywordflow">case</font> <font class="charliteral">'n'</font>:
00674       <font class="keywordflow">return</font> TARGET_NEWLINE;
00675     <font class="keywordflow">case</font> <font class="charliteral">'r'</font>:
00676       <font class="keywordflow">return</font> TARGET_CR;
00677     <font class="keywordflow">case</font> <font class="charliteral">'t'</font>:
00678       <font class="keywordflow">return</font> TARGET_TAB;
00679     <font class="keywordflow">case</font> <font class="charliteral">'v'</font>:
00680       <font class="keywordflow">return</font> TARGET_VT;
00681     <font class="keywordflow">case</font> <font class="charliteral">'\n'</font>:
00682       <font class="keywordflow">return</font> -2;
00683     <font class="keywordflow">case</font> 0:
00684       (*string_ptr)--;
00685       <font class="keywordflow">return</font> 0;
00686       
00687     <font class="keywordflow">case</font> <font class="charliteral">'0'</font>:
00688     <font class="keywordflow">case</font> <font class="charliteral">'1'</font>:
00689     <font class="keywordflow">case</font> <font class="charliteral">'2'</font>:
00690     <font class="keywordflow">case</font> <font class="charliteral">'3'</font>:
00691     <font class="keywordflow">case</font> <font class="charliteral">'4'</font>:
00692     <font class="keywordflow">case</font> <font class="charliteral">'5'</font>:
00693     <font class="keywordflow">case</font> <font class="charliteral">'6'</font>:
00694     <font class="keywordflow">case</font> <font class="charliteral">'7'</font>:
00695       {
00696         <font class="keywordtype">int</font> i = (<font class="keywordtype">int</font>) c - <font class="charliteral">'0'</font>;
00697         <font class="keywordtype">int</font> count = 0;
00698 
00699         <font class="keywordflow">while</font> (++count &lt; 3)
00700           {
00701             c = *(*string_ptr)++;
00702             <font class="keywordflow">if</font> (c &gt;= <font class="charliteral">'0'</font> &amp;&amp; c &lt;= <font class="charliteral">'7'</font>)
00703               {
00704                 i = ((<font class="keywordtype">unsigned</font>) i &lt;&lt; 3) + c - <font class="charliteral">'0'</font>;
00705               }
00706 
00707             <font class="keywordflow">else</font>
00708               {
00709                 (*string_ptr)--;
00710                 <font class="comment">/*@loopbreak@*/</font> <font class="keywordflow">break</font>;
00711               }
00712           }
00713         <font class="keywordflow">if</font> ((i &amp; ~((1 &lt;&lt; MAX_CHAR_TYPE_SIZE) - 1)) != 0)
00714           {
00715             i &amp;= (1 &lt;&lt; MAX_CHAR_TYPE_SIZE) - 1;
00716             <a class="code" href="cpperror_c.html#a12">cppReader_pedwarnLit</a> (pfile,
00717                             cstring_makeLiteralTemp (<font class="stringliteral">"octal character constant does not fit in a byte"</font>));
00718           }
00719         <font class="keywordflow">return</font> i;
00720       }
00721     <font class="keywordflow">case</font> <font class="charliteral">'x'</font>:
00722       {
00723         <font class="keyword">register</font> <font class="keywordtype">unsigned</font> i = 0, overflow = 0, digits_found = 0, digit;
00724         <font class="keywordflow">for</font> (;;)
00725           {
00726             c = *(*string_ptr)++;
00727 
00728             <font class="keywordflow">if</font> (c &gt;= <font class="charliteral">'0'</font> &amp;&amp; c &lt;= <font class="charliteral">'9'</font>)
00729               {
00730                 digit = (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>) (c - <font class="charliteral">'0'</font>);
00731               }
00732             <font class="keywordflow">else</font> <font class="keywordflow">if</font> (c &gt;= <font class="charliteral">'a'</font> &amp;&amp; c &lt;= <font class="charliteral">'f'</font>)
00733               {
00734                 digit = (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>) (c - <font class="charliteral">'a'</font>) + 10;
00735               }
00736             <font class="keywordflow">else</font> <font class="keywordflow">if</font> (c &gt;= <font class="charliteral">'A'</font> &amp;&amp; c &lt;= <font class="charliteral">'F'</font>)
00737               {
00738                 digit = (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>) (c - <font class="charliteral">'A'</font>) + 10;
00739               }
00740             <font class="keywordflow">else</font>
00741               {
00742                 (*string_ptr)--;
00743                 <font class="comment">/*@loopbreak@*/</font> <font class="keywordflow">break</font>;
00744               }
00745             overflow |= i ^ (i &lt;&lt; 4 &gt;&gt; 4);
00746             i = (i &lt;&lt; 4) + digit;
00747             digits_found = 1;
00748           }
00749         
00750         <font class="keywordflow">if</font> (digits_found == 0)
00751           {
00752             <a class="code" href="cpperror_c.html#a8">cppReader_errorLit</a> (pfile,
00753                                 cstring_makeLiteralTemp (<font class="stringliteral">"\\x used with no following hex digits"</font>));
00754           }
00755 
00756         <font class="keywordflow">if</font> ((overflow | (i &amp; ~((1 &lt;&lt; BITS_PER_UNIT) - 1))) != 0)
00757           {
00758             i &amp;= (1 &lt;&lt; BITS_PER_UNIT) - 1;
00759             <a class="code" href="cpperror_c.html#a12">cppReader_pedwarnLit</a> (pfile,
00760                             cstring_makeLiteralTemp (<font class="stringliteral">"hex character constant does not fit in a byte"</font>));
00761           }
00762 
00763         <font class="keywordflow">return</font> i;
00764       }
00765     <font class="keywordflow">default</font>:
00766       <font class="keywordflow">return</font> c;
00767     }
00768 }
00769 
00770 <font class="keyword">static</font> <font class="keywordtype">void</font>
00771 integer_overflow (cppReader *pfile)<font class="keyword"></font>
00772 <font class="keyword"></font>{
00773   <font class="keywordflow">if</font> (cppReader_isPedantic (pfile))
00774     <a class="code" href="cpperror_c.html#a12">cppReader_pedwarnLit</a> (pfile, 
00775                     cstring_makeLiteralTemp (<font class="stringliteral">"integer overflow in preprocessor expression"</font>));
00776 }
00777 
00778 <font class="keyword">static</font> <font class="keywordtype">long</font>
00779 left_shift (cppReader *pfile, <font class="keywordtype">long</font> a, <font class="keywordtype">bool</font> unsignedp, size_t b)<font class="keyword"></font>
00780 <font class="keyword"></font>{
00781   <font class="keywordflow">if</font> (b &gt;= HOST_BITS_PER_LONG)
00782     {
00783       <font class="keywordflow">if</font> (!unsignedp &amp;&amp; a != 0)
00784         {
00785           integer_overflow (pfile);
00786         }
00787 
00788       <font class="keywordflow">return</font> 0;
00789     }
00790   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (unsignedp)
00791     {
00792       <font class="keywordflow">return</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font>) a &lt;&lt; b;
00793     }
00794   <font class="keywordflow">else</font>
00795     {
00796       <font class="keywordtype">long</font> l = a &lt;&lt; b;
00797       
00798       <font class="keywordflow">if</font> (l &gt;&gt; b != a)
00799         {
00800           integer_overflow (pfile);
00801         }
00802 
00803       <font class="keywordflow">return</font> l;
00804     }
00805 }
00806 
00807 <font class="keyword">static</font> <font class="keywordtype">long</font>
00808 right_shift (<font class="keywordtype">long</font> a, <font class="keywordtype">bool</font> unsignedp, <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> b)<font class="keyword"></font>
00809 <font class="keyword"></font>{
00810   <font class="keywordflow">if</font> (b &gt;= HOST_BITS_PER_LONG)
00811     <font class="keywordflow">return</font> (unsignedp ? 0 : a &gt;&gt; (HOST_BITS_PER_LONG - 1));
00812   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (unsignedp)
00813     <font class="keywordflow">return</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font>) a &gt;&gt; b;
00814   <font class="keywordflow">else</font>
00815     <font class="keywordflow">return</font> a &gt;&gt; b;
00816 }
00817 
00818 <font class="comment">/* These priorities are all even, so we can handle associatively.  */</font>
00819 
00820 <font class="comment">/*@constant int PAREN_INNER_PRIO@*/</font>
<a name="l00821"></a><a class="code" href="cppexp_c.html#a37">00821</a> <font class="preprocessor">#define PAREN_INNER_PRIO 0</font>
00822 <font class="preprocessor"></font>
00823 <font class="comment">/*@constant int COMMA_PRIO@*/</font>
<a name="l00824"></a><a class="code" href="cppexp_c.html#a38">00824</a> <font class="preprocessor">#define COMMA_PRIO 4</font>
00825 <font class="preprocessor"></font>
00826 <font class="comment">/*@constant int COND_PRIO@*/</font>
<a name="l00827"></a><a class="code" href="cppexp_c.html#a39">00827</a> <font class="preprocessor">#define COND_PRIO (COMMA_PRIO+2)</font>
00828 <font class="preprocessor"></font>
00829 <font class="comment">/*@constant int OROR_PRIO@*/</font>
<a name="l00830"></a><a class="code" href="cppexp_c.html#a40">00830</a> <font class="preprocessor">#define OROR_PRIO (COND_PRIO+2)</font>
00831 <font class="preprocessor"></font>
00832 <font class="comment">/*@constant int ANDAND_PRIO@*/</font>
<a name="l00833"></a><a class="code" href="cppexp_c.html#a41">00833</a> <font class="preprocessor">#define ANDAND_PRIO (OROR_PRIO+2)</font>
00834 <font class="preprocessor"></font>
00835 <font class="comment">/*@constant int OR_PRIO@*/</font>
<a name="l00836"></a><a class="code" href="cppexp_c.html#a42">00836</a> <font class="preprocessor">#define OR_PRIO (ANDAND_PRIO+2)</font>
00837 <font class="preprocessor"></font>
00838 <font class="comment">/*@constant int XOR_PRIO@*/</font>
<a name="l00839"></a><a class="code" href="cppexp_c.html#a43">00839</a> <font class="preprocessor">#define XOR_PRIO (OR_PRIO+2)</font>
00840 <font class="preprocessor"></font>
00841 <font class="comment">/*@constant int AND_PRIO@*/</font>
<a name="l00842"></a><a class="code" href="cppexp_c.html#a44">00842</a> <font class="preprocessor">#define AND_PRIO (XOR_PRIO+2)</font>
00843 <font class="preprocessor"></font>
00844 <font class="comment">/*@constant int CPP_EQUAL_PRIO@*/</font>
<a name="l00845"></a><a class="code" href="cppexp_c.html#a45">00845</a> <font class="preprocessor">#define CPP_EQUAL_PRIO (AND_PRIO+2)</font>
00846 <font class="preprocessor"></font>
00847 <font class="comment">/*@constant int LESS_PRIO@*/</font>
<a name="l00848"></a><a class="code" href="cppexp_c.html#a46">00848</a> <font class="preprocessor">#define LESS_PRIO (CPP_EQUAL_PRIO+2)</font>
00849 <font class="preprocessor"></font>
00850 <font class="comment">/*@constant int SHIFT_PRIO@*/</font>
<a name="l00851"></a><a class="code" href="cppexp_c.html#a47">00851</a> <font class="preprocessor">#define SHIFT_PRIO (LESS_PRIO+2)</font>
00852 <font class="preprocessor"></font>
00853 <font class="comment">/*@constant int PLUS_PRIO@*/</font>
<a name="l00854"></a><a class="code" href="cppexp_c.html#a48">00854</a> <font class="preprocessor">#define PLUS_PRIO (SHIFT_PRIO+2)</font>
00855 <font class="preprocessor"></font>
00856 <font class="comment">/*@constant int MUL_PRIO@*/</font>
<a name="l00857"></a><a class="code" href="cppexp_c.html#a49">00857</a> <font class="preprocessor">#define MUL_PRIO (PLUS_PRIO+2)</font>
00858 <font class="preprocessor"></font>
00859 <font class="comment">/*@constant int UNARY_PRIO@*/</font>
<a name="l00860"></a><a class="code" href="cppexp_c.html#a50">00860</a> <font class="preprocessor">#define UNARY_PRIO (MUL_PRIO+2)</font>
00861 <font class="preprocessor"></font>
00862 <font class="comment">/*@constant int PAREN_OUTER_PRIO@*/</font>
<a name="l00863"></a><a class="code" href="cppexp_c.html#a51">00863</a> <font class="preprocessor">#define PAREN_OUTER_PRIO (UNARY_PRIO+2)</font>
00864 <font class="preprocessor"></font>
00865 <font class="comment">/*@notfunction@*/</font>
<a name="l00866"></a><a class="code" href="cppexp_c.html#a52">00866</a> <font class="preprocessor">#define COMPARE(OP) \</font>
00867 <font class="preprocessor">  top-&gt;unsignedp = FALSE;\</font>
00868 <font class="preprocessor">  top-&gt;value = ((unsigned1 || unsigned2) \</font>
00869 <font class="preprocessor">                 ? (unsigned long) v1 OP (unsigned long) v2 \</font>
00870 <font class="preprocessor">                 : ((long) v1 OP (long) v2)) ? 1 : 0</font>
00871 <font class="preprocessor"></font>
00872 <font class="comment">/* Parse and evaluate a C expression, reading from PFILE.</font>
00873 <font class="comment">   Returns the value of the expression.  */</font>
00874 
00875 <font class="comment">/*@constant int INIT_STACK_SIZE@*/</font>
<a name="l00876"></a><a class="code" href="cppexp_c.html#a53">00876</a> <font class="preprocessor"># define INIT_STACK_SIZE 20</font>
00877 <font class="preprocessor"></font>
00878 HOST_WIDE_INT
<a name="l00879"></a><a class="code" href="cppexp_c.html#a62">00879</a> <a class="code" href="cppexp_c.html#a62">cppReader_parseExpression</a> (cppReader *pfile)<font class="keyword"></font>
00880 <font class="keyword"></font>{
00881   <font class="comment">/* The implementation is an operator precedence parser,</font>
00882 <font class="comment">     i.e. a bottom-up parser, using a stack for not-yet-reduced tokens.</font>
00883 <font class="comment"></font>
00884 <font class="comment">     The stack base is 'stack', and the current stack pointer is 'top'.</font>
00885 <font class="comment">     There is a stack element for each operator (only),</font>
00886 <font class="comment">     and the most recently pushed operator is 'top-&gt;op'.</font>
00887 <font class="comment">     An operand (value) is stored in the 'value' field of the stack</font>
00888 <font class="comment">     element of the operator that precedes it.</font>
00889 <font class="comment">     In that case the 'flags' field has the HAVE_VALUE flag set.  */</font>
00890 
00891   <font class="keyword">struct </font><a class="code" href="struct_operation.html">operation</a> init_stack[INIT_STACK_SIZE];
00892   <font class="keyword">struct </font><a class="code" href="struct_operation.html">operation</a> *stack = init_stack;
00893   <font class="keyword">struct </font><a class="code" href="struct_operation.html">operation</a> *limit = stack + INIT_STACK_SIZE;
00894   <font class="keyword">register</font> <font class="keyword">struct </font><a class="code" href="struct_operation.html">operation</a> *top = stack;
00895   <font class="keywordtype">int</font> lprio, rprio = 0;
00896   <font class="keywordtype">int</font> skip_evaluation = 0;
00897 
00898   top-&gt;rprio = 0;
00899   top-&gt;flags = 0;
00900 
00901   <font class="keywordflow">for</font> (;;)
00902     {
00903       <font class="keyword">struct </font><a class="code" href="struct_operation.html">operation</a> op;
00904       <font class="keywordtype">int</font> flags = 0;
00905 
00906       <font class="comment">/* Read a token */</font>
00907       op =  cppReader_lex (pfile);
00908 
00909       <font class="comment">/* See if the token is an operand, in which case go to set_value.</font>
00910 <font class="comment">         If the token is an operator, figure out its left and right</font>
00911 <font class="comment">         priorities, and then goto maybe_reduce.  */</font>
00912 
00913       <font class="keywordflow">switch</font> (op.op)
00914         {
00915         <font class="keywordflow">case</font> NAME:
00916           top-&gt;value = 0, top-&gt;unsignedp = FALSE;
00917           <font class="keywordflow">goto</font> set_value;
00918         <font class="keywordflow">case</font> CPPEXP_INT:
00919         <font class="keywordflow">case</font> CPPEXP_CHAR:
00920           top-&gt;value = op.value;
00921           top-&gt;unsignedp = op.unsignedp;
00922           <font class="keywordflow">goto</font> set_value;
00923         <font class="keywordflow">case</font> 0:
00924           lprio = 0;  <font class="keywordflow">goto</font> maybe_reduce;
00925         <font class="keywordflow">case</font> <font class="charliteral">'+'</font>:  <font class="keywordflow">case</font> <font class="charliteral">'-'</font>:
00926           <font class="comment">/* Is this correct if unary ? FIXME */</font>
00927           flags = RIGHT_OPERAND_REQUIRED;
00928           lprio = PLUS_PRIO;  rprio = lprio + 1;  <font class="keywordflow">goto</font> maybe_reduce;
00929         <font class="keywordflow">case</font> <font class="charliteral">'!'</font>:  <font class="keywordflow">case</font> <font class="charliteral">'~'</font>:
00930           flags = RIGHT_OPERAND_REQUIRED;
00931           rprio = UNARY_PRIO;  lprio = rprio + 1;  <font class="keywordflow">goto</font> maybe_reduce;
00932         <font class="keywordflow">case</font> <font class="charliteral">'*'</font>:  <font class="keywordflow">case</font> <font class="charliteral">'/'</font>:  <font class="keywordflow">case</font> <font class="charliteral">'%'</font>:
00933           lprio = MUL_PRIO;  <font class="keywordflow">goto</font> binop;
00934         <font class="keywordflow">case</font> <font class="charliteral">'&lt;'</font>:  <font class="keywordflow">case</font> <font class="charliteral">'&gt;'</font>:  <font class="keywordflow">case</font> LEQ:  <font class="keywordflow">case</font> GEQ:
00935           lprio = LESS_PRIO;  <font class="keywordflow">goto</font> binop;
00936         <font class="keywordflow">case</font> CPP_EQUALTOK:  <font class="keywordflow">case</font> NOTEQUAL:
00937           lprio = CPP_EQUAL_PRIO;  <font class="keywordflow">goto</font> binop;
00938         <font class="keywordflow">case</font> LSH:  <font class="keywordflow">case</font> RSH:
00939           lprio = SHIFT_PRIO;  <font class="keywordflow">goto</font> binop;
00940         <font class="keywordflow">case</font> <font class="charliteral">'&amp;'</font>:  lprio = AND_PRIO;  <font class="keywordflow">goto</font> binop;
00941         <font class="keywordflow">case</font> <font class="charliteral">'^'</font>:  lprio = XOR_PRIO;  <font class="keywordflow">goto</font> binop;
00942         <font class="keywordflow">case</font> <font class="charliteral">'|'</font>:  lprio = OR_PRIO;  <font class="keywordflow">goto</font> binop;
00943         <font class="keywordflow">case</font> ANDAND:  lprio = ANDAND_PRIO;  <font class="keywordflow">goto</font> binop;
00944         <font class="keywordflow">case</font> OROR:  lprio = OROR_PRIO;  <font class="keywordflow">goto</font> binop;
00945         <font class="keywordflow">case</font> <font class="charliteral">','</font>:
00946           lprio = COMMA_PRIO;  <font class="keywordflow">goto</font> binop;
00947         <font class="keywordflow">case</font> <font class="charliteral">'('</font>:
00948           lprio = PAREN_OUTER_PRIO;  rprio = PAREN_INNER_PRIO;
00949           <font class="keywordflow">goto</font> maybe_reduce;
00950         <font class="keywordflow">case</font> <font class="charliteral">')'</font>:
00951           lprio = PAREN_INNER_PRIO;  rprio = PAREN_OUTER_PRIO;
00952           <font class="keywordflow">goto</font> maybe_reduce;
00953         <font class="keywordflow">case</font> <font class="charliteral">':'</font>:
00954           lprio = COND_PRIO;  rprio = COND_PRIO;
00955           <font class="keywordflow">goto</font> maybe_reduce;
00956         <font class="keywordflow">case</font> <font class="charliteral">'?'</font>:
00957           lprio = COND_PRIO + 1;  rprio = COND_PRIO;
00958           <font class="keywordflow">goto</font> maybe_reduce;
00959         binop:
00960           flags = LEFT_OPERAND_REQUIRED | RIGHT_OPERAND_REQUIRED;
00961           rprio = lprio + 1;
00962           <font class="keywordflow">goto</font> maybe_reduce;
00963         <font class="keywordflow">default</font>:
00964           cppReader_error 
00965             (pfile, 
00966              <a class="code" href="message_c.html#a18">message</a> (<font class="stringliteral">"Invalid character in #if: %c"</font>, 
00967                       (<font class="keywordtype">char</font>) op.op));
00968           <font class="keywordflow">goto</font> syntax_error;
00969         }
00970 
00971     set_value:
00972       <font class="comment">/* Push a value onto the stack.  */</font>
00973       <font class="keywordflow">if</font> ((top-&gt;flags &amp; HAVE_VALUE) != 0)
00974         {
00975           <a class="code" href="cpperror_c.html#a8">cppReader_errorLit</a> (pfile, 
00976                         cstring_makeLiteralTemp (<font class="stringliteral">"syntax error in #if"</font>));
00977           <font class="keywordflow">goto</font> syntax_error;
00978         }
00979       top-&gt;flags |= HAVE_VALUE;
00980       <font class="keywordflow">continue</font>;
00981 
00982     maybe_reduce:
00983       <font class="comment">/* Push an operator, and check if we can reduce now.  */</font>
00984       <font class="keywordflow">while</font> (top-&gt;rprio &gt; lprio)
00985         {
00986           <font class="comment">/*@-usedef@*/</font>
00987           <font class="keywordtype">long</font> v1 = top[-1].value, v2 = top[0].value;
00988           <font class="keywordtype">bool</font> unsigned1 = top[-1].unsignedp;
00989           <font class="keywordtype">bool</font> unsigned2 = top[0].unsignedp;
00990 
00991           top--;
00992 
00993           <font class="keywordflow">if</font> (((top[1].flags &amp; LEFT_OPERAND_REQUIRED) != 0)
00994               &amp;&amp; ((top[0].flags &amp; HAVE_VALUE) == 0))
00995             {
00996               <a class="code" href="cpperror_c.html#a8">cppReader_errorLit</a> (pfile, 
00997                             cstring_makeLiteralTemp (<font class="stringliteral">"syntax error - missing left operand"</font>));
00998               <font class="keywordflow">goto</font> syntax_error;
00999             }
01000           <font class="keywordflow">if</font> (((top[1].flags &amp; RIGHT_OPERAND_REQUIRED) != 0)
01001               &amp;&amp; ((top[1].flags &amp; HAVE_VALUE) == 0))
01002             {
01003               <a class="code" href="cpperror_c.html#a8">cppReader_errorLit</a> (pfile, 
01004                             cstring_makeLiteralTemp (<font class="stringliteral">"syntax error - missing right operand"</font>));
01005               <font class="keywordflow">goto</font> syntax_error;
01006             }
01007           <font class="comment">/* top[0].value = (top[1].op)(v1, v2);*/</font>
01008           <font class="keywordflow">switch</font> (top[1].op)
01009             {
01010             <font class="keywordflow">case</font> <font class="charliteral">'+'</font>:
01011               <font class="keywordflow">if</font> ((top-&gt;flags &amp; HAVE_VALUE) == 0)
01012                 { <font class="comment">/* Unary '+' */</font>
01013                   top-&gt;value = v2;
01014                   top-&gt;unsignedp = unsigned2;
01015                   top-&gt;flags |= HAVE_VALUE;
01016                 }
01017               <font class="keywordflow">else</font>
01018                 {
01019                   top-&gt;value = v1 + v2;
01020                   top-&gt;unsignedp = unsigned1 || unsigned2;
01021                   <font class="keywordflow">if</font> (!top-&gt;unsignedp &amp;&amp; (skip_evaluation == 0)
01022                       &amp;&amp; ! <a class="code" href="cppexp_c.html#a0">possibleSumSign</a> (v1, v2, top-&gt;value))
01023                     integer_overflow (pfile);
01024                 }
01025               <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01026             <font class="keywordflow">case</font> <font class="charliteral">'-'</font>:
01027               <font class="keywordflow">if</font> ((top-&gt;flags &amp; HAVE_VALUE) == 0)
01028                 { <font class="comment">/* Unary '-' */</font>
01029                   top-&gt;value = - v2;
01030                   <font class="keywordflow">if</font> ((skip_evaluation == 0) 
01031                       &amp;&amp; (top-&gt;value &amp; v2) &lt; 0 &amp;&amp; !unsigned2)
01032                     integer_overflow (pfile);
01033                   top-&gt;unsignedp = unsigned2;
01034                   top-&gt;flags |= HAVE_VALUE;
01035                 }
01036               <font class="keywordflow">else</font>
01037                 { <font class="comment">/* Binary '-' */</font>
01038                   top-&gt;value = v1 - v2;
01039                   top-&gt;unsignedp = unsigned1 || unsigned2;
01040                   <font class="keywordflow">if</font> (!top-&gt;unsignedp &amp;&amp; (skip_evaluation == 0)
01041                       &amp;&amp; !<a class="code" href="cppexp_c.html#a0">possibleSumSign</a> (top-&gt;value, v2, v1))
01042                     {
01043                       integer_overflow (pfile);
01044                     }
01045                 }
01046               <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01047             <font class="keywordflow">case</font> <font class="charliteral">'*'</font>:
01048               top-&gt;unsignedp = unsigned1 || unsigned2;
01049 
01050               <font class="keywordflow">if</font> (top-&gt;unsignedp)
01051                 {
01052                   top-&gt;value = (<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font>) v1 * v2;
01053                 }
01054               <font class="keywordflow">else</font> <font class="keywordflow">if</font> (skip_evaluation == 0)
01055                 {
01056                   top-&gt;value = v1 * v2;
01057                   <font class="keywordflow">if</font> ((v1 != 0)
01058                       &amp;&amp; (top-&gt;value / v1 != v2
01059                           || (top-&gt;value &amp; v1 &amp; v2) &lt; 0))
01060                     {
01061                       integer_overflow (pfile);
01062                     }
01063                 }
01064               <font class="keywordflow">else</font>
01065                 {
01066                   ;
01067                 }
01068 
01069               <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01070             <font class="keywordflow">case</font> <font class="charliteral">'/'</font>:
01071               <font class="keywordflow">if</font> (skip_evaluation != 0)
01072                 <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01073               <font class="keywordflow">if</font> (v2 == 0)
01074                 {
01075                   <a class="code" href="cpperror_c.html#a8">cppReader_errorLit</a> (pfile, 
01076                                 cstring_makeLiteralTemp (<font class="stringliteral">"Division by zero in #if"</font>));
01077                   v2 = 1;
01078                 }
01079               top-&gt;unsignedp = unsigned1 || unsigned2;
01080               <font class="keywordflow">if</font> (top-&gt;unsignedp)
01081                 top-&gt;value = (<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font>) v1 / v2;
01082               <font class="keywordflow">else</font>
01083                 {
01084                   top-&gt;value = v1 / v2;
01085                   <font class="keywordflow">if</font> ((top-&gt;value &amp; v1 &amp; v2) &lt; 0)
01086                     integer_overflow (pfile);
01087                 }
01088               <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01089             <font class="keywordflow">case</font> <font class="charliteral">'%'</font>:
01090               <font class="keywordflow">if</font> (skip_evaluation != 0)
01091                 <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01092               <font class="keywordflow">if</font> (v2 == 0)
01093                 {
01094                   <a class="code" href="cpperror_c.html#a8">cppReader_errorLit</a> (pfile, 
01095                                 cstring_makeLiteralTemp (<font class="stringliteral">"Division by zero in #if"</font>));
01096                   v2 = 1;
01097                 }
01098               top-&gt;unsignedp = unsigned1 || unsigned2;
01099               <font class="keywordflow">if</font> (top-&gt;unsignedp)
01100                 top-&gt;value = (<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font>) v1 % v2;
01101               <font class="keywordflow">else</font>
01102                 top-&gt;value = v1 % v2;
01103               <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01104             <font class="keywordflow">case</font> <font class="charliteral">'!'</font>:
01105               <font class="keywordflow">if</font> ((top-&gt;flags &amp; HAVE_VALUE) != 0)
01106                 {
01107                   <a class="code" href="cpperror_c.html#a8">cppReader_errorLit</a> (pfile, 
01108                                       cstring_makeLiteralTemp (<font class="stringliteral">"Syntax error"</font>));
01109                   <font class="keywordflow">goto</font> syntax_error;
01110                 }
01111 
01112               top-&gt;value = (v2 == 0) ? 1 : 0;
01113               top-&gt;unsignedp = FALSE;
01114               top-&gt;flags |= HAVE_VALUE;
01115               <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01116             <font class="keywordflow">case</font> <font class="charliteral">'~'</font>:
01117               <font class="keywordflow">if</font> ((top-&gt;flags &amp; HAVE_VALUE) != 0)
01118                 {
01119                   <a class="code" href="cpperror_c.html#a8">cppReader_errorLit</a> (pfile, 
01120                                 cstring_makeLiteralTemp (<font class="stringliteral">"syntax error"</font>));
01121                   <font class="keywordflow">goto</font> syntax_error;
01122                 }
01123               top-&gt;value = ~ v2;
01124               top-&gt;unsignedp = unsigned2;
01125               top-&gt;flags |= HAVE_VALUE;
01126               <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01127             <font class="keywordflow">case</font> <font class="charliteral">'&lt;'</font>:  <a class="code" href="cppexp_c.html#a52">COMPARE</a>(&lt;);  <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01128             <font class="keywordflow">case</font> <font class="charliteral">'&gt;'</font>:  <a class="code" href="cppexp_c.html#a52">COMPARE</a>(&gt;);  <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01129             <font class="keywordflow">case</font> LEQ:  <a class="code" href="cppexp_c.html#a52">COMPARE</a>(&lt;=); <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01130             <font class="keywordflow">case</font> GEQ:  <a class="code" href="cppexp_c.html#a52">COMPARE</a>(&gt;=); <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01131             <font class="keywordflow">case</font> CPP_EQUALTOK:
01132               top-&gt;value = (v1 == v2) ? 1 : 0;
01133               top-&gt;unsignedp = FALSE;
01134               <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01135             <font class="keywordflow">case</font> NOTEQUAL:
01136               top-&gt;value = (v1 != v2) ? 1 : 0;
01137               top-&gt;unsignedp = FALSE;
01138               <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01139             <font class="keywordflow">case</font> LSH:
01140               <font class="keywordflow">if</font> (skip_evaluation != 0)
01141                 {
01142                   <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01143                 }
01144 
01145               top-&gt;unsignedp = unsigned1;
01146               <font class="keywordflow">if</font> (v2 &lt; 0 &amp;&amp; ! unsigned2)
01147                 top-&gt;value = right_shift (v1, unsigned1, -v2);
01148               <font class="keywordflow">else</font>
01149                 top-&gt;value = left_shift (pfile, v1, unsigned1, v2);
01150               <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01151             <font class="keywordflow">case</font> RSH:
01152               <font class="keywordflow">if</font> (skip_evaluation != 0)
01153                 {
01154                   <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01155                 }
01156               top-&gt;unsignedp = unsigned1;
01157               <font class="keywordflow">if</font> (v2 &lt; 0 &amp;&amp; ! unsigned2)
01158                 top-&gt;value = left_shift (pfile, v1, unsigned1, -v2);
01159               <font class="keywordflow">else</font>
01160                 top-&gt;value = right_shift (v1, unsigned1, v2);
01161               <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01162 
01163 <font class="comment">/*@notfunction@*/</font>
01164 <font class="preprocessor">#define LOGICAL(OP) \</font>
01165 <font class="preprocessor">              top-&gt;value = v1 OP v2;\</font>
01166 <font class="preprocessor">              top-&gt;unsignedp = unsigned1 || unsigned2;</font>
01167 <font class="preprocessor"></font>
01168             <font class="keywordflow">case</font> <font class="charliteral">'&amp;'</font>:  <a class="code" href="cppexp_c.html#a54">LOGICAL</a>(&amp;); <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01169             <font class="keywordflow">case</font> <font class="charliteral">'^'</font>:  <a class="code" href="cppexp_c.html#a54">LOGICAL</a>(^); <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01170             <font class="keywordflow">case</font> <font class="charliteral">'|'</font>:  <a class="code" href="cppexp_c.html#a54">LOGICAL</a>(|); <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01171             <font class="keywordflow">case</font> ANDAND:
01172               top-&gt;value = ((v1 != 0) &amp;&amp; (v2 != 0)) ? 1 : 0;
01173               top-&gt;unsignedp = FALSE;
01174 
01175               <font class="keywordflow">if</font> (v1 == 0)
01176                 {
01177                   skip_evaluation--;
01178                 }
01179               <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01180             <font class="keywordflow">case</font> OROR:
01181               top-&gt;value = ((v1 != 0) || (v2 != 0)) ? 1 : 0;
01182               top-&gt;unsignedp = FALSE;
01183               <font class="keywordflow">if</font> (v1 != 0)
01184                 {
01185                   skip_evaluation--;
01186                 }
01187               <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01188             <font class="keywordflow">case</font> <font class="charliteral">','</font>:
01189               <font class="keywordflow">if</font> (cppReader_isPedantic (pfile))
01190                 <a class="code" href="cpperror_c.html#a12">cppReader_pedwarnLit</a> (pfile, 
01191                                 cstring_makeLiteralTemp (<font class="stringliteral">"comma operator in operand of `#if'"</font>));
01192               top-&gt;value = v2;
01193               top-&gt;unsignedp = unsigned2;
01194               <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01195             <font class="keywordflow">case</font> <font class="charliteral">'('</font>:  <font class="keywordflow">case</font> <font class="charliteral">'?'</font>:
01196               <a class="code" href="cpperror_c.html#a8">cppReader_errorLit</a> (pfile, 
01197                             cstring_makeLiteralTemp (<font class="stringliteral">"syntax error in #if"</font>));
01198               <font class="keywordflow">goto</font> syntax_error;
01199             <font class="keywordflow">case</font> <font class="charliteral">':'</font>:
01200               <font class="keywordflow">if</font> (top[0].op != <font class="charliteral">'?'</font>)
01201                 {
01202                   <a class="code" href="cpperror_c.html#a8">cppReader_errorLit</a> (pfile,
01203                                 cstring_makeLiteralTemp (<font class="stringliteral">"syntax error ':' without preceding '?'"</font>));
01204                   <font class="keywordflow">goto</font> syntax_error;
01205                 }
01206               <font class="keywordflow">else</font> <font class="keywordflow">if</font> (((top[1].flags &amp; HAVE_VALUE) == 0)
01207                        || ((top[-1].flags &amp; HAVE_VALUE) == 0)
01208                        || ((top[0].flags &amp; HAVE_VALUE) == 0))
01209                 {
01210                   <a class="code" href="cpperror_c.html#a8">cppReader_errorLit</a> (pfile, 
01211                                 cstring_makeLiteralTemp (<font class="stringliteral">"bad syntax for ?: operator"</font>));
01212                   <font class="keywordflow">goto</font> syntax_error;
01213                 }
01214               <font class="keywordflow">else</font>
01215                 {
01216                   top--;
01217                   <font class="keywordflow">if</font> (top-&gt;value != 0)
01218                     {
01219                       skip_evaluation--;
01220                     }
01221 
01222                   top-&gt;value = (top-&gt;value != 0) ? v1 : v2;
01223                   top-&gt;unsignedp = unsigned1 || unsigned2;
01224                 }
01225               <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01226             <font class="keywordflow">case</font> <font class="charliteral">')'</font>:
01227               <font class="keywordflow">if</font> (((top[1].flags &amp; HAVE_VALUE) != 0)
01228                   || ((top[0].flags &amp; HAVE_VALUE) == 0)
01229                   || top[0].op != <font class="charliteral">'('</font>
01230                   || ((top[-1].flags &amp; HAVE_VALUE) != 0))
01231                 {
01232                   <a class="code" href="cpperror_c.html#a8">cppReader_errorLit</a> (pfile, 
01233                                 cstring_makeLiteralTemp (<font class="stringliteral">"mismatched parentheses in #if"</font>));
01234                   <font class="keywordflow">goto</font> syntax_error;
01235                 }
01236               <font class="keywordflow">else</font>
01237                 {
01238                   top--;
01239                   top-&gt;value = v1;
01240                   top-&gt;unsignedp = unsigned1;
01241                   top-&gt;flags |= HAVE_VALUE;
01242                 }
01243               <font class="comment">/*@switchbreak@*/</font> <font class="keywordflow">break</font>;
01244             <font class="keywordflow">default</font>:
01245               fprintf (stderr,
01246                        top[1].op &gt;= <font class="charliteral">' '</font> &amp;&amp; top[1].op &lt;= <font class="charliteral">'~'</font>
01247                        ? <font class="stringliteral">"unimplemented operator '%c'\n"</font>
01248                        : <font class="stringliteral">"unimplemented operator '\\%03o'\n"</font>,
01249                        top[1].op);
01250             }
01251         }
01252       <font class="keywordflow">if</font> (op.op == 0)
01253         {
01254           <font class="keywordtype">long</font> val;
01255 
01256           <font class="keywordflow">if</font> (top != stack)
01257             {
01258               <a class="code" href="cpperror_c.html#a8">cppReader_errorLit</a> (pfile, 
01259                             cstring_makeLiteralTemp (<font class="stringliteral">"internal error in #if expression"</font>));
01260             }
01261 
01262           val = top-&gt;value;
01263 
01264           <font class="keywordflow">if</font> (stack != init_stack)
01265             {
01266               <a class="code" href="general_c.html#a0">sfree</a> (stack);
01267               <font class="comment">/*@-branchstate@*/</font>
01268             } <font class="comment">/*@=branchstate@*/</font>
01269 
01270           <font class="keywordflow">return</font> val;
01271         }
01272       top++;
01273       
01274       <font class="comment">/* Check for and handle stack overflow.  */</font>
01275       <font class="keywordflow">if</font> (top == limit)
01276         {
01277           <font class="keyword">struct </font><a class="code" href="struct_operation.html">operation</a> *new_stack;
01278           <font class="keywordtype">int</font> old_size = (<font class="keywordtype">char</font> *) limit - (<font class="keywordtype">char</font> *) stack;
01279           size_t new_size = <a class="code" href="general_c.html#a33">size_fromInt</a> (2 * old_size);
01280 
01281           <font class="keywordflow">if</font> (stack != init_stack)
01282             {
01283               new_stack = (<font class="keyword">struct </font><a class="code" href="struct_operation.html">operation</a> *) drealloc ((char *) stack,
01284                                                          new_size);
01285             }
01286           <font class="keywordflow">else</font>
01287             {
01288               new_stack = (<font class="keyword">struct </font><a class="code" href="struct_operation.html">operation</a> *) dmalloc (new_size);
01289 
01290               <font class="comment">/* Bug: the parameters were in the wrong order! */</font>
01291               memcpy ((<font class="keywordtype">char</font> *) new_stack, (<font class="keywordtype">char</font> *) stack, old_size);
01292               <font class="comment">/*@-branchstate@*/</font>
01293             } <font class="comment">/*@=branchstate@*/</font>
01294 
01295           stack = new_stack;
01296           top = (<font class="keyword">struct </font><a class="code" href="struct_operation.html">operation</a> *) ((char *) new_stack + old_size);
01297           limit = (<font class="keyword">struct </font><a class="code" href="struct_operation.html">operation</a> *) ((char *) new_stack + new_size);
01298           <font class="comment">/*@-branchstate@*/</font> 
01299         } <font class="comment">/*@=branchstate@*/</font> 
01300       
01301       top-&gt;flags = flags;
01302       top-&gt;rprio = rprio;
01303       top-&gt;op = op.op;
01304       <font class="keywordflow">if</font> ((op.op == OROR &amp;&amp; (top[-1].value != 0))
01305           || (op.op == ANDAND &amp;&amp; (top[-1].value == 0))
01306           || (op.op == <font class="charliteral">'?'</font> &amp;&amp; (top[-1].value == 0)))
01307         {
01308           skip_evaluation++;
01309         }
01310       <font class="keywordflow">else</font> <font class="keywordflow">if</font> (op.op == <font class="charliteral">':'</font>)
01311         {
01312           <font class="keywordflow">if</font> (top[-2].value != 0) <font class="comment">/* Was condition true? */</font>
01313             {
01314               skip_evaluation++;
01315             }
01316           <font class="keywordflow">else</font>
01317             {
01318               skip_evaluation--;
01319             }
01320         }
01321       <font class="keywordflow">else</font>
01322         {
01323           ;
01324         }
01325     }
01326  syntax_error:
01327   <font class="comment">/*@-usereleased@*/</font>
01328   <font class="keywordflow">if</font> (stack != init_stack)
01329     {
01330       <a class="code" href="general_c.html#a0">sfree</a> (stack);
01331       <font class="comment">/*@-branchstate@*/</font>
01332     } <font class="comment">/*@=branchstate@*/</font>
01333   <font class="comment">/*@=usereleased@*/</font>
01334 
01335   <a class="code" href="cpplib_c.html#a116">cppReader_skipRestOfLine</a> (pfile);
01336   <font class="keywordflow">return</font> 0;
01337 }
</div></pre><hr><address><small>Generated at Fri Nov 3 18:57:39 2000 for LCLint by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.3 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2000</small></address>
</body>
</html>
