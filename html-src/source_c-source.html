<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>source.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.3 on Fri Nov 3 18:57:43 2000 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>source.c</h1><a href="source_c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">** LCLint - annotation-assisted static program checker</font>
00003 <font class="comment">** Copyright (C) 1994-2000 University of Virginia,</font>
00004 <font class="comment">**         Massachusetts Institute of Technology</font>
00005 <font class="comment">**</font>
00006 <font class="comment">** This program is free software; you can redistribute it and/or modify it</font>
00007 <font class="comment">** under the terms of the GNU General Public License as published by the</font>
00008 <font class="comment">** Free Software Foundation; either version 2 of the License, or (at your</font>
00009 <font class="comment">** option) any later version.</font>
00010 <font class="comment">** </font>
00011 <font class="comment">** This program is distributed in the hope that it will be useful, but</font>
00012 <font class="comment">** WITHOUT ANY WARRANTY; without even the implied warranty of</font>
00013 <font class="comment">** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</font>
00014 <font class="comment">** General Public License for more details.</font>
00015 <font class="comment">** </font>
00016 <font class="comment">** The GNU General Public License is available from http://www.gnu.org/ or</font>
00017 <font class="comment">** the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston,</font>
00018 <font class="comment">** MA 02111-1307, USA.</font>
00019 <font class="comment">**</font>
00020 <font class="comment">** For information on lclint: lclint-request@cs.virginia.edu</font>
00021 <font class="comment">** To report a bug: lclint-bug@cs.virginia.edu</font>
00022 <font class="comment">** For more information: http://lclint.cs.virginia.edu</font>
00023 <font class="comment">*/</font>
00024 <font class="comment">/*</font>
00025 <font class="comment">** source.c</font>
00026 <font class="comment">**</font>
00027 <font class="comment">** Interface to source file abstraction</font>
00028 <font class="comment">**</font>
00029 <font class="comment">**      NOTE:       This module is almost identical to the one for LCL.  The</font>
00030 <font class="comment">**                  only difference is that a couple of source lines have been</font>
00031 <font class="comment">**                  commented out.</font>
00032 <font class="comment">**</font>
00033 <font class="comment">**                  This module has too many dependencies to be in the common</font>
00034 <font class="comment">**                  source area.  Any of the solutions that would allow this</font>
00035 <font class="comment">**                  module to be common had its own set of compromises.  It</font>
00036 <font class="comment">**                  seemed best and most straightforward to just keep separte</font>
00037 <font class="comment">**                  copies for LSL and LCL.  We should examine this again if we</font>
00038 <font class="comment">**                  ever reorganize the module structure.</font>
00039 <font class="comment">**</font>
00040 <font class="comment">**  AUTHORS:</font>
00041 <font class="comment">**</font>
00042 <font class="comment">**     Steve Garland,</font>
00043 <font class="comment">**         Massachusetts Institute of Technology</font>
00044 <font class="comment">**     Joe Wild, Technical Languages and Environments, DECspec project</font>
00045 <font class="comment">*/</font>
00046 
00047 <font class="preprocessor"># include "lclintMacros.nf"</font>
00048 <font class="preprocessor"># include "llbasic.h"</font>
00049 <font class="preprocessor"># include "osd.h"</font>
00050 <font class="preprocessor"># include "portab.h"</font>
00051 
00052 <font class="keyword">extern</font> <font class="keywordtype">bool</font>
<a name="l00053"></a><a class="code" href="source_c.html#a0">00053</a> <a class="code" href="source_c.html#a0">tsource_close</a> (tsource *s)<font class="keyword"></font>
00054 <font class="keyword"></font>{
00055   <font class="keywordflow">if</font> (s-&gt;file != NULL)
00056     {
00057       check (fclose (s-&gt;file) == 0);
00058       s-&gt;file = NULL;
00059       <font class="keywordflow">return</font> TRUE;
00060     }
00061 
00062   <font class="keywordflow">return</font> FALSE;
00063 }
00064 
00065 <font class="keyword">extern</font> <font class="keywordtype">void</font>
<a name="l00066"></a><a class="code" href="source_c.html#a1">00066</a> <a class="code" href="source_c.html#a1">tsource_free</a> (<font class="comment">/*@null@*/</font> <font class="comment">/*@only@*/</font> tsource *s)<font class="keyword"></font>
00067 <font class="keyword"></font>{
00068   <font class="keywordflow">if</font> (s != NULL)
00069     {
00070       <a class="code" href="general_c.html#a0">sfree</a> (s-&gt;name);
00071       <a class="code" href="general_c.html#a0">sfree</a> (s-&gt;stringSource);
00072       <a class="code" href="general_c.html#a0">sfree</a> (s);
00073     }
00074 }
00075 
00076 <font class="keyword">extern</font> <font class="comment">/*@only@*/</font> tsource *
<a name="l00077"></a><a class="code" href="source_c.html#a2">00077</a>   <a class="code" href="source_c.html#a2">tsource_create</a> (<font class="keywordtype">char</font> *name, <font class="keywordtype">char</font> *suffix, <font class="keywordtype">bool</font> echo)<font class="keyword"></font>
00078 <font class="keyword"></font>{
00079   <font class="keywordtype">char</font> *ps;
00080   tsource *s = (tsource *) dmalloc (<font class="keyword">sizeof</font> (*s));
00081   
00082   s-&gt;name = (<font class="keywordtype">char</font> *) dmalloc (strlen (name) + strlen (suffix) + 1);
00083   s-&gt;file = 0;
00084   strcpy (s-&gt;name, name);
00085 
00086   ps = strrchr (s-&gt;name, CONNECTCHAR);
00087 
00088   <font class="keywordflow">if</font> (ps == (<font class="keywordtype">char</font> *) 0)
00089     {
00090       ps = s-&gt;name;
00091     }
00092 
00093   <font class="keywordflow">if</font> (strchr (ps, <font class="charliteral">'.'</font>) == NULL)
00094     {
00095       strcat (s-&gt;name, suffix);
00096     }
00097 
00098   
00099 
00100   s-&gt;lineNo = 0;
00101   s-&gt;echo = echo;
00102   s-&gt;fromString = FALSE;
00103   s-&gt;stringSource = NULL;
00104   s-&gt;stringSourceTail = NULL;
00105   
00106 
00107   <font class="keywordflow">return</font> s;
00108 }
00109 
00110 <font class="keyword">extern</font> <font class="comment">/*@only@*/</font> tsource *
<a name="l00111"></a><a class="code" href="source_c.html#a3">00111</a> <a class="code" href="source_c.html#a3">tsource_fromString</a> (<font class="keywordtype">char</font> *name, <font class="keywordtype">char</font> *str)<font class="keyword"></font>
00112 <font class="keyword"></font>{
00113   tsource *s = (tsource *) dmalloc (<font class="keyword">sizeof</font> (*s));
00114 
00115   s-&gt;name = <a class="code" href="general_c.html#a27">mstring_copy</a> (name);
00116   s-&gt;stringSource = <a class="code" href="general_c.html#a27">mstring_copy</a> (str);
00117   s-&gt;stringSourceTail = s-&gt;stringSource;
00118   s-&gt;file = 0;
00119   s-&gt;echo = FALSE;
00120   s-&gt;fromString = TRUE;
00121   s-&gt;lineNo = 0;
00122 
00123     <font class="keywordflow">return</font> s;
00124 }
00125 
00126 <font class="keyword">extern</font> <font class="comment">/*@dependent@*/</font> <font class="comment">/*@null@*/</font> 
<a name="l00127"></a><a class="code" href="source_c.html#a4">00127</a> <font class="keywordtype">char</font> *<a class="code" href="source_c.html#a4">tsource_nextLine</a> (tsource *s)<font class="keyword"></font>
00128 <font class="keyword"></font>{
00129   <font class="keywordtype">char</font> *currentLine;
00130   <font class="keywordtype">int</font> len;
00131 
00132   <font class="keywordflow">if</font> (s-&gt;fromString)
00133     {
00134       <font class="keywordflow">if</font> (s-&gt;stringSourceTail == NULL || (strlen (s-&gt;stringSourceTail) == 0))
00135         {
00136           currentLine = 0;
00137         }
00138       <font class="keywordflow">else</font>
00139         {
00140           <font class="keywordtype">char</font> *c = strchr (s-&gt;stringSourceTail, <font class="charliteral">'\n'</font>);
00141           
00142           
00143           <font class="comment">/* in case line is terminated not by newline */</font> 
00144           <font class="keywordflow">if</font> (c == 0)
00145             {
00146               c = strchr (s-&gt;stringSourceTail, <font class="charliteral">'\0'</font>);
00147             }
00148 
00149           len = c - s-&gt;stringSourceTail + 1;
00150 
00151           <font class="keywordflow">if</font> (len &gt; STUBMAXRECORDSIZE - 2)
00152             {
00153               len = (STUBMAXRECORDSIZE - 2);
00154             }
00155 
00156           currentLine = &amp;(s-&gt;buffer)[0];
00157           strncpy (currentLine, s-&gt;stringSourceTail, size_fromInt (len));
00158           currentLine[len] = <font class="charliteral">'\0'</font>;
00159           s-&gt;stringSourceTail += len;
00160         }
00161       
00162     }
00163   <font class="keywordflow">else</font>
00164     {
00165       llassert (s-&gt;file != NULL);
00166       currentLine = fgets (&amp;(s-&gt;buffer)[0], STUBMAXRECORDSIZE, s-&gt;file);
00167     }
00168   <font class="keywordflow">if</font> (currentLine == 0)
00169     {
00170       strcpy (s-&gt;buffer, "*** End of File ***");
00171     }
00172   <font class="keywordflow">else</font>
00173     {
00174       s-&gt;lineNo++;
00175       len = strlen (currentLine) - 1;
00176       <font class="keywordflow">if</font> (s-&gt;buffer[len] == <font class="charliteral">'\n'</font>)
00177         {
00178           s-&gt;buffer[len] = <font class="charliteral">'\0'</font>;
00179         }
00180       <font class="keywordflow">else</font> 
00181         {
00182           <font class="keywordflow">if</font> (len &gt;= STUBMAXRECORDSIZE - 2)
00183             {
00184               <a class="code" href="llerror_c.html#a22">lldiagmsg</a> (message (<font class="stringliteral">"Input line too long: %s"</font>,
00185                                   cstring_fromChars (currentLine)));
00186             }
00187         }
00188     }
00189   <font class="comment">/* if (s-&gt;echo) slo_echoLine (currentLine);           only needed in LCL */</font>
00190     <font class="keywordflow">return</font> currentLine;
00191 }
00192 
00193 <font class="keyword">extern</font> <font class="keywordtype">bool</font>
<a name="l00194"></a><a class="code" href="source_c.html#a5">00194</a> <a class="code" href="source_c.html#a5">tsource_open</a> (tsource *s)<font class="keyword"></font>
00195 <font class="keyword"></font>{
00196   <font class="keywordflow">if</font> (s-&gt;fromString)
00197     {
00198       <font class="comment">/* not an error: tail is dependent */</font>
00199       s-&gt;stringSourceTail = s-&gt;stringSource; 
00200       <font class="keywordflow">return</font> TRUE;
00201     }
00202 
00203   DPRINTF ((<font class="stringliteral">"Open: %s"</font>, s-&gt;name));
00204   s-&gt;file = fopen (s-&gt;name, "r");
00205   <font class="keywordflow">return</font> (s-&gt;file != 0 || s-&gt;fromString);
00206 }
00207 
00208 <font class="comment">/*</font>
00209 <font class="comment">** requires</font>
00210 <font class="comment">**  path != NULL \and</font>
00211 <font class="comment">**  s != NULL \and</font>
00212 <font class="comment">**  *s.name == filename (*s.name) || filetype (*s.name)</font>
00213 <font class="comment">**      *s.name consists of a file name and type only ("&lt;filename&gt;.&lt;type&gt;)</font>
00214 <font class="comment">**      No path name is included</font>
00215 <font class="comment">**</font>
00216 <font class="comment">** ensures</font>
00217 <font class="comment">**  if filefound (*path, *s) then</font>
00218 <font class="comment">**      result = true \and *s.name = filespec_where_file_found (*path, *s)</font>
00219 <font class="comment">**  else</font>
00220 <font class="comment">**      result = false</font>
00221 <font class="comment">*/</font>
00222 
<a name="l00223"></a><a class="code" href="source_c.html#a6">00223</a> <font class="keyword">extern</font> <font class="keywordtype">bool</font> <a class="code" href="source_c.html#a6">tsource_getPath</a> (<font class="keywordtype">char</font> *path, tsource *s)<font class="keyword"></font>
00224 <font class="keyword"></font>{
00225   <font class="keywordtype">char</font> *returnPath;
00226   filestatus status;            <font class="comment">/* return status of osd_getEnvPath.*/</font>
00227   <font class="keywordtype">bool</font> rVal;                    <font class="comment">/* return value of this procedure. */</font>
00228 
00229  <font class="comment">/* Check if requires met. */</font>
00230   <font class="keywordflow">if</font> (path == NULL || s == NULL || s-&gt;name == NULL)
00231     {
00232       llbugexitlit (<font class="stringliteral">"tsource_getPath: invalid parameter"</font>);
00233     }
00234 
00235   status = <a class="code" href="osd_c.html#a7">osd_getPath</a> (path, s-&gt;name, &amp;returnPath);
00236 
00237   <font class="keywordflow">if</font> (status == OSD_FILEFOUND)
00238     {                           <font class="comment">/* Should be majority of cases. */</font>
00239       rVal = TRUE;
00240       
00241       <a class="code" href="general_c.html#a0">sfree</a> (s-&gt;name);
00242       s-&gt;name = returnPath;
00243     }
00244   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (status == OSD_FILENOTFOUND)
00245     {
00246       rVal = FALSE;
00247     }
00248   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (status == OSD_PATHTOOLONG)
00249     {
00250       rVal = FALSE;
00251      <font class="comment">/* Directory and filename are too long.  Report error. */</font>
00252      llbuglit (<font class="stringliteral">"soure_getPath: Filename plus directory from search path too long"</font>);
00253  }
00254   <font class="keywordflow">else</font>
00255     {
00256       rVal = FALSE;
00257       llbuglit (<font class="stringliteral">"tsource_getPath: invalid return status"</font>);
00258     }
00259   <font class="keywordflow">return</font> rVal;
00260 }
00261 
00262 <font class="preprocessor"># ifndef NOLCL</font>
<a name="l00263"></a><a class="code" href="source_c.html#a7">00263</a> <font class="preprocessor"></font><font class="keywordtype">char</font> *<a class="code" href="source_c.html#a7">specFullName</a> (<font class="keywordtype">char</font> *specfile, <font class="comment">/*@out@*/</font> <font class="keywordtype">char</font> **inpath)<font class="keyword"></font>
00264 <font class="keyword"></font>{
00265   <font class="comment">/* extract the path and the specname associated with the given file */</font>
00266   <font class="keywordtype">char</font> *specname = (<font class="keywordtype">char</font> *) dmalloc (<font class="keyword">sizeof</font> (*specname) 
00267                                      * (strlen (specfile) + 9));
00268   <font class="keywordtype">char</font> *ospecname = specname;
00269   <font class="keywordtype">char</font> *path = (<font class="keywordtype">char</font> *) dmalloc (<font class="keyword">sizeof</font> (*path) * (strlen (specfile)));
00270   size_t size;
00271   <font class="keywordtype">long</font> <font class="keywordtype">int</font> i, j;
00272   
00273   <font class="comment">/* initialized path to empty string or may have accidental garbage */</font>
00274   *path = <font class="charliteral">'\0'</font>;
00275 
00276   <font class="comment">/*@-mayaliasunique@*/</font> 
00277   strcpy (specname, specfile);
00278   <font class="comment">/*@=mayaliasunique@*/</font> 
00279 
00280   <font class="comment">/* trim off pathnames in specfile */</font>
00281   size = strlen (specname);
00282 
00283   <font class="keywordflow">for</font> (i = <a class="code" href="general_c.html#a34">size_toInt</a> (size) - 1; i &gt;= 0; i--)
00284     {
00285       <font class="keywordflow">if</font> (specname[i] == CONNECTCHAR)
00286         {
00287           <font class="comment">/* strcpy (specname, (char *)specname+i+1); */</font>
00288           <font class="keywordflow">for</font> (j = 0; j &lt;= i; j++)      <font class="comment">/* include '/'  */</font>
00289             {
00290               path[j] = specname[j];
00291             }
00292 
00293           path[i + 1] = <font class="charliteral">'\0'</font>;
00294           specname += i + 1;
00295           <font class="keywordflow">break</font>;
00296         }
00297     }
00298 
00299   <font class="comment">/* </font>
00300 <font class="comment">  ** also remove .lcl file extension, assume it's the last extension</font>
00301 <font class="comment">  ** of the file name </font>
00302 <font class="comment">  */</font>
00303 
00304   size = strlen (specname);
00305 
00306   <font class="keywordflow">for</font> (i = <a class="code" href="general_c.html#a34">size_toInt</a> (size) - 1; i &gt;= 0; i--)
00307     {
00308       <font class="keywordflow">if</font> (specname[i] == <font class="charliteral">'.'</font>)
00309         {
00310           specname[i] = <font class="charliteral">'\0'</font>;
00311           <font class="keywordflow">break</font>;
00312         }
00313     }
00314   
00315   *inpath = path;
00316 
00317   <font class="comment">/*</font>
00318 <font class="comment">  ** If specname no longer points to the original char,</font>
00319 <font class="comment">  ** we need to allocate a new pointer and copy the string.</font>
00320 <font class="comment">  */</font>
00321 
00322   <font class="keywordflow">if</font> (specname != ospecname) {
00323     <font class="keywordtype">char</font> *rspecname = (<font class="keywordtype">char</font> *) dmalloc (<font class="keyword">sizeof</font> (*rspecname) * (strlen (specname) + 1));
00324     strcpy (rspecname, specname); <font class="comment">/* evs 2000-05-16: Bug: was ospecname! */</font>
00325     <a class="code" href="general_c.html#a0">sfree</a> (ospecname);
00326     <font class="keywordflow">return</font> rspecname;
00327   } 
00328 
00329   <font class="keywordflow">return</font> specname;
00330 }
00331 <font class="preprocessor"># endif</font>
00332 <font class="preprocessor"></font>
</div></pre><hr><address><small>Generated at Fri Nov 3 18:57:43 2000 for LCLint by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.3 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2000</small></address>
</body>
</html>
