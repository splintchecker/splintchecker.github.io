<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>message.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.3 on Fri Nov 3 18:57:43 2000 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>message.c</h1><a href="message_c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">** LCLint - annotation-assisted static program checker</font>
00003 <font class="comment">** Copyright (C) 1994-2000 University of Virginia,</font>
00004 <font class="comment">**         Massachusetts Institute of Technology</font>
00005 <font class="comment">**</font>
00006 <font class="comment">** This program is free software; you can redistribute it and/or modify it</font>
00007 <font class="comment">** under the terms of the GNU General Public License as published by the</font>
00008 <font class="comment">** Free Software Foundation; either version 2 of the License, or (at your</font>
00009 <font class="comment">** option) any later version.</font>
00010 <font class="comment">** </font>
00011 <font class="comment">** This program is distributed in the hope that it will be useful, but</font>
00012 <font class="comment">** WITHOUT ANY WARRANTY; without even the implied warranty of</font>
00013 <font class="comment">** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</font>
00014 <font class="comment">** General Public License for more details.</font>
00015 <font class="comment">** </font>
00016 <font class="comment">** The GNU General Public License is available from http://www.gnu.org/ or</font>
00017 <font class="comment">** the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston,</font>
00018 <font class="comment">** MA 02111-1307, USA.</font>
00019 <font class="comment">**</font>
00020 <font class="comment">** For information on lclint: lclint-request@cs.virginia.edu</font>
00021 <font class="comment">** To report a bug: lclint-bug@cs.virginia.edu</font>
00022 <font class="comment">** For more information: http://lclint.cs.virginia.edu</font>
00023 <font class="comment">*/</font>
00024 <font class="comment">/*</font>
00025 <font class="comment">** message.c</font>
00026 <font class="comment">*/</font>
00027 
00028 <font class="preprocessor"># include "lclintMacros.nf"</font>
00029 <font class="preprocessor"># include "basic.h"</font>
00030  
00031 <font class="comment">/* patch for linux? solaris? */</font>
00032 
00033 <font class="keyword">static</font> <font class="keywordtype">char</font> strbuf[64];
00034 <font class="keyword">static</font> <font class="keywordtype">int</font> modcode;
00035 
<a name="l00036"></a><a class="code" href="message_c.html#a19">00036</a> <font class="keyword">typedef</font> <font class="keyword">enum</font>
00037 {
00038   XINVALID, 
00039   XCHAR, XSTRING, XSTRINGFREE, XTSTRINGFREE, XINT, XFLOAT, XBOOL, XUENTRY,
00040   XPERCENT, XCTYPE, XPLURAL, XREPREFIX, XFILELOC
00041 } ccode;
00042 
00043 <font class="comment">/* char *s, anytype v */</font>
00044 <font class="comment">/*@notfunction@*/</font>
<a name="l00045"></a><a class="code" href="message_c.html#a0">00045</a> <font class="preprocessor"># define GETPRINTF(s,v) (sprintf (strbuf, s, v), mstring_copy (strbuf))</font>
00046 <font class="preprocessor"></font>
00047 <font class="comment">/*</font>
00048 <font class="comment">** returns control code indicated by *c, and</font>
00049 <font class="comment">** advances *c to next character.</font>
00050 <font class="comment">*/</font>
00051 
00052 <font class="keyword">static</font> ccode
00053   identify_control (<font class="keywordtype">char</font> **s)<font class="keyword"></font>
00054 <font class="keyword"></font>{
00055   <font class="keywordtype">char</font> c;
00056 
00057   modcode = 0;
00058 
00059   c = **s;
00060   <font class="keywordflow">if</font> (c == <font class="charliteral">'\0'</font>)
00061     {
00062       <font class="keywordflow">return</font> (XINVALID);
00063     }
00064 
00065   <font class="keywordflow">if</font> (c &gt;= <font class="charliteral">'0'</font> &amp;&amp; c &lt;= <font class="charliteral">'9'</font>)
00066     {
00067       modcode = <a class="code" href="general_c.html#a16">getInt</a> (s);
00068     }
00069 
00070   c = **s;
00071 
00072   (*s)++;
00073 
00074  <font class="comment">/*</font>
00075 <font class="comment"> ** handle single-char codes</font>
00076 <font class="comment"> */</font>
00077 
00078   <font class="keywordflow">switch</font> (c)
00079     {
00080     <font class="keywordflow">case</font> <font class="charliteral">'%'</font>:
00081       <font class="keywordflow">return</font> (XPERCENT);
00082     <font class="keywordflow">case</font> <font class="charliteral">'h'</font>:
00083     <font class="keywordflow">case</font> <font class="charliteral">'c'</font>:
00084       <font class="keywordflow">return</font> (XCHAR);
00085     <font class="keywordflow">case</font> <font class="charliteral">'s'</font>:
00086       <font class="keywordflow">return</font> (XSTRING);
00087     <font class="keywordflow">case</font> <font class="charliteral">'q'</font>:
00088       <font class="keywordflow">return</font> (XSTRINGFREE);
00089     <font class="keywordflow">case</font> <font class="charliteral">'x'</font>:
00090       <font class="keywordflow">return</font> (XSTRINGFREE);
00091     <font class="keywordflow">case</font> <font class="charliteral">'d'</font>:
00092       <font class="keywordflow">return</font> (XINT);
00093     <font class="keywordflow">case</font> <font class="charliteral">'u'</font>:
00094       <font class="keywordflow">return</font> (XINT); <font class="comment">/* unsigned */</font>
00095     <font class="keywordflow">case</font> <font class="charliteral">'w'</font>:
00096       <font class="keywordflow">return</font> (XINT); <font class="comment">/* unsigned long */</font>
00097     <font class="keywordflow">case</font> <font class="charliteral">'f'</font>:
00098       <font class="keywordflow">return</font> (XFLOAT);
00099     <font class="keywordflow">case</font> <font class="charliteral">'b'</font>:
00100       <font class="keywordflow">return</font> (XBOOL);
00101     <font class="keywordflow">case</font> <font class="charliteral">'t'</font>:
00102       <font class="keywordflow">return</font> (XCTYPE);
00103     <font class="keywordflow">case</font> <font class="charliteral">'l'</font>:
00104       <font class="keywordflow">return</font> (XFILELOC);
00105     <font class="keywordflow">case</font> <font class="charliteral">'p'</font>:
00106       <font class="keywordflow">return</font> (XPLURAL);
00107     <font class="keywordflow">case</font> <font class="charliteral">'r'</font>:
00108       <font class="keywordflow">return</font> (XREPREFIX);
00109     <font class="keywordflow">default</font>:
00110       llcontbug (message (<font class="stringliteral">"Message: invalid code: %h (%s)"</font>, c, 
00111                           cstring_fromChars (*s)));
00112       <font class="keywordflow">return</font> (XINVALID);
00113     }
00114 }
00115 
00116 <font class="comment">/*</font>
00117 <font class="comment">** message</font>
00118 <font class="comment">**</font>
00119 <font class="comment">** returns a cstring containing the message, as formated by s.</font>
00120 <font class="comment">**</font>
00121 <font class="comment">** the format codes are similar to printf:</font>
00122 <font class="comment">**</font>
00123 <font class="comment">**         %s    cstring (don't free after print)</font>
00124 <font class="comment">**         %q    cstring (free after print)</font>
00125 <font class="comment">**         %d    int</font>
00126 <font class="comment">**         %f    float</font>
00127 <font class="comment">**         %b    bool     (uses bool_unparse)</font>
00128 <font class="comment">**         %u    uentry</font>
00129 <font class="comment">**         %l    fileloc</font>
00130 <font class="comment">**         %t    ctype</font>
00131 <font class="comment">*/</font>
00132 
00133 
00134 <font class="preprocessor"># if USEVARARGS</font>
00135 <font class="preprocessor"></font>cstring
00136 <a class="code" href="message_c.html#a18">message</a> (fmt, va_alist)
00137      <font class="keywordtype">char</font> *fmt;
00138      va_dcl
00139 <font class="preprocessor"># else</font>
00140 <font class="preprocessor"></font><font class="comment">/*@messagelike@*/</font> <font class="comment">/*@only@*/</font> cstring
<a name="l00141"></a><a class="code" href="message_c.html#a18">00141</a> <a class="code" href="message_c.html#a18">message</a> (<font class="comment">/*@temp@*/</font> <font class="keywordtype">char</font> *fmt, ...)
00142 <font class="preprocessor"># endif</font>
00143 <font class="preprocessor"></font>{
00144   <font class="keywordtype">char</font> c;
00145   <font class="keywordtype">int</font> lastint = 0;
00146   <font class="keywordtype">char</font> *ret = mstring_createEmpty ();
00147   <font class="keywordtype">char</font> *ofmt = fmt;
00148   va_list pvar;
00149 
00150 <font class="preprocessor"># if USEVARARGS</font>
00151 <font class="preprocessor"></font>  va_start (pvar);
00152 <font class="preprocessor"># else</font>
00153 <font class="preprocessor"></font>  va_start (pvar, fmt);
00154 <font class="preprocessor"># endif  </font>
00155 <font class="preprocessor"></font>
00156   <font class="keywordflow">while</font> ((c = *fmt++) != <font class="charliteral">'\0'</font>)
00157     {
00158       <font class="keywordflow">if</font> (c == <font class="charliteral">'%'</font>)
00159         {
00160           <font class="comment">/*@-loopswitchbreak@*/</font>
00161 
00162           <font class="keywordflow">switch</font> (identify_control (&amp;fmt))
00163             {
00164             <font class="keywordflow">case</font> XPERCENT:
00165               {
00166                 ret = <a class="code" href="general_c.html#a25">mstring_concatFree1</a> (ret, <font class="stringliteral">"%"</font>);
00167                 <font class="keywordflow">break</font>;
00168               }
00169             <font class="keywordflow">case</font> XCHAR:
00170               {
00171                 <font class="comment">/*</font>
00172 <font class="comment">                ** some systems don't handle char va_arg correctly, so it must be</font>
00173 <font class="comment">                ** passed as an int here</font>
00174 <font class="comment">                */</font>
00175 
00176                 <font class="keywordtype">char</font> lc = (<font class="keywordtype">char</font>) va_arg (pvar, <font class="keywordtype">int</font>);
00177 
00178                 ret = <a class="code" href="general_c.html#a26">mstring_append</a> (ret, lc);
00179                 <font class="keywordflow">break</font>;
00180               }
00181             <font class="keywordflow">case</font> XSTRING:
00182               {
00183                 cstring s = va_arg (pvar, cstring);
00184                 
00185                 <font class="keywordflow">if</font> (modcode != 0)
00186                   {
00187                     ret = <a class="code" href="general_c.html#a24">mstring_concatFree</a> (ret, cstring_toCharsSafe 
00188                                           (cstring_fill (s, modcode)));
00189                   }
00190                 <font class="keywordflow">else</font>
00191                   {
00192                     <font class="keywordflow">if</font> (cstring_isDefined (s))
00193                       {
00194                         ret = <a class="code" href="general_c.html#a25">mstring_concatFree1</a> (ret, cstring_toCharsSafe (s));
00195                       }
00196                   }
00197               }
00198               <font class="keywordflow">break</font>;
00199             <font class="keywordflow">case</font> XSTRINGFREE:
00200             <font class="keywordflow">case</font> XTSTRINGFREE:
00201               {
00202                 cstring s = va_arg (pvar, cstring);
00203                 
00204                 <font class="keywordflow">if</font> (modcode != 0)
00205                   {
00206                     ret = <a class="code" href="general_c.html#a24">mstring_concatFree</a> (ret, cstring_toCharsSafe 
00207                                               (cstring_fill (s, modcode)));
00208                   }
00209                 <font class="keywordflow">else</font>
00210                   {
00211                     <font class="keywordflow">if</font> (cstring_isDefined (s))
00212                       {
00213                         ret = mstring_concatFree 
00214                           (ret, <a class="code" href="cstring_c.html#a29">cstring_toCharsSafe</a> (s));
00215                       }
00216                   }
00217               }
00218               <font class="keywordflow">break</font>;
00219             <font class="keywordflow">case</font> XREPREFIX:
00220               lastint = va_arg (pvar, <font class="keywordtype">int</font>);
00221 
00222               <font class="keywordflow">if</font> (lastint != 0)
00223                 {
00224                   ret = <a class="code" href="general_c.html#a25">mstring_concatFree1</a> (ret, <font class="stringliteral">"re"</font>);
00225                 }
00226               <font class="keywordflow">break</font>;
00227             <font class="keywordflow">case</font> XPLURAL:
00228               <font class="keywordflow">if</font> (lastint != 1)
00229                 {
00230                   ret = <a class="code" href="general_c.html#a25">mstring_concatFree1</a> (ret, <font class="stringliteral">"s"</font>);
00231                 }
00232               <font class="keywordflow">break</font>;
00233             <font class="keywordflow">case</font> XINT:
00234               lastint = va_arg (pvar, <font class="keywordtype">int</font>);
00235               ret = <a class="code" href="general_c.html#a24">mstring_concatFree</a> (ret, GETPRINTF (<font class="stringliteral">"%d"</font>, lastint));
00236               <font class="keywordflow">break</font>;
00237             <font class="keywordflow">case</font> XFLOAT:
00238               ret = <a class="code" href="general_c.html#a24">mstring_concatFree</a> (ret, GETPRINTF (<font class="stringliteral">"%e"</font>, va_arg (pvar, <font class="keywordtype">double</font>)));
00239               <font class="keywordflow">break</font>;
00240             <font class="keywordflow">case</font> XBOOL:
00241               ret = <a class="code" href="general_c.html#a25">mstring_concatFree1</a> (ret, cstring_toCharsSafe 
00242                                     (bool_unparse (va_arg (pvar, <font class="keywordtype">bool</font>))));
00243               <font class="keywordflow">break</font>;
00244             <font class="keywordflow">case</font> XUENTRY:
00245               ret = <a class="code" href="general_c.html#a24">mstring_concatFree</a> (ret, cstring_toCharsSafe 
00246                                    (uentry_unparse (va_arg (pvar, uentry))));
00247               <font class="keywordflow">break</font>;
00248             <font class="keywordflow">case</font> XCTYPE:
00249               <font class="comment">/* cannot free ctype_unparse */</font>
00250               ret = <a class="code" href="general_c.html#a25">mstring_concatFree1</a> (ret, cstring_toCharsSafe 
00251                                    (ctype_unparse (va_arg (pvar, ctype)))); 
00252               <font class="keywordflow">break</font>;
00253             <font class="keywordflow">case</font> XFILELOC:
00254               ret = <a class="code" href="general_c.html#a24">mstring_concatFree</a> (ret, cstring_toCharsSafe 
00255                                    (fileloc_unparse (va_arg (pvar, fileloc))));
00256               <font class="keywordflow">break</font>;
00257             <font class="keywordflow">case</font> XINVALID:
00258             <font class="keywordflow">default</font>:
00259               llcontbug (cstring_makeLiteral (<font class="stringliteral">"message: bad control flag"</font>));
00260               fprintf (stdout, <font class="stringliteral">"\tFormat string: %s"</font>, ofmt);
00261             }
00262           <font class="comment">/*@=loopswitchbreak@*/</font>
00263         }
00264       <font class="keywordflow">else</font>
00265         {
00266           ret = <a class="code" href="general_c.html#a26">mstring_append</a> (ret, c);
00267         }
00268     }
00269 
00270   va_end (pvar);
00271 
00272   <font class="comment">/*</font>
00273 <font class="comment">  ** cstring_fromChars returns the same storage (exposed)</font>
00274 <font class="comment">  */</font>
00275 
00276   <font class="comment">/*@-mustfree@*/</font> <font class="keywordflow">return</font> (<a class="code" href="cstring_c.html#a28">cstring_fromChars</a> (ret)); <font class="comment">/*@=mustfree@*/</font>
00277 }
</div></pre><hr><address><small>Generated at Fri Nov 3 18:57:43 2000 for LCLint by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.3 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2000</small></address>
</body>
</html>
