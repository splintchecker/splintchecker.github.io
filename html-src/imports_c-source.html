<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>imports.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.3 on Fri Nov 3 18:57:41 2000 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>imports.c</h1><a href="imports_c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">** LCLint - annotation-assisted static program checker</font>
00003 <font class="comment">** Copyright (C) 1994-2000 University of Virginia,</font>
00004 <font class="comment">**         Massachusetts Institute of Technology</font>
00005 <font class="comment">**</font>
00006 <font class="comment">** This program is free software; you can redistribute it and/or modify it</font>
00007 <font class="comment">** under the terms of the GNU General Public License as published by the</font>
00008 <font class="comment">** Free Software Foundation; either version 2 of the License, or (at your</font>
00009 <font class="comment">** option) any later version.</font>
00010 <font class="comment">** </font>
00011 <font class="comment">** This program is distributed in the hope that it will be useful, but</font>
00012 <font class="comment">** WITHOUT ANY WARRANTY; without even the implied warranty of</font>
00013 <font class="comment">** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</font>
00014 <font class="comment">** General Public License for more details.</font>
00015 <font class="comment">** </font>
00016 <font class="comment">** The GNU General Public License is available from http://www.gnu.org/ or</font>
00017 <font class="comment">** the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston,</font>
00018 <font class="comment">** MA 02111-1307, USA.</font>
00019 <font class="comment">**</font>
00020 <font class="comment">** For information on lclint: lclint-request@cs.virginia.edu</font>
00021 <font class="comment">** To report a bug: lclint-bug@cs.virginia.edu</font>
00022 <font class="comment">** For more information: http://lclint.cs.virginia.edu</font>
00023 <font class="comment">*/</font>
00024 <font class="comment">/*</font>
00025 <font class="comment">** imports.c</font>
00026 <font class="comment">**</font>
00027 <font class="comment">** module for importing LCL specs.</font>
00028 <font class="comment">**</font>
00029 <font class="comment">**  AUTHOR:</font>
00030 <font class="comment">**      Yang Meng Tan,</font>
00031 <font class="comment">**         Massachusetts Institute of Technology</font>
00032 <font class="comment">*/</font>
00033 
00034 <font class="preprocessor"># include "lclintMacros.nf"</font>
00035 <font class="preprocessor"># include "llbasic.h"</font> 
00036 <font class="preprocessor"># include "osd.h"</font>
00037 <font class="preprocessor"># include "llgrammar.h"</font> <font class="comment">/* need simpleOp, MULOP and logicalOp in makeInfixTermNode */</font>
00038 <font class="preprocessor"># include "lclscan.h"</font>
00039 <font class="preprocessor"># include "checking.h"</font>
00040 <font class="preprocessor"># include "imports.h"</font>
00041 <font class="preprocessor"># include "lslparse.h"</font>
00042 <font class="preprocessor"># include "lh.h"</font>
00043 <font class="preprocessor"># include "llmain.h"</font>
00044 <font class="preprocessor"># include "portab.h"</font>
00045 <font class="preprocessor"># include "herald.h"</font>
00046 
00047 <font class="keywordtype">void</font>
<a name="l00048"></a><a class="code" href="imports_c.html#a0">00048</a> <a class="code" href="imports_c.html#a0">outputLCSFile</a> (<font class="keywordtype">char</font> *path, <font class="keywordtype">char</font> *msg, <font class="keywordtype">char</font> *specname)<font class="keyword"></font>
00049 <font class="keyword"></font>{
00050   <font class="keyword">static</font> <font class="keywordtype">bool</font> haserror = FALSE;
00051   <font class="keywordtype">char</font> *sfile = <a class="code" href="general_c.html#a23">mstring_concat</a> (specname, <font class="stringliteral">".lcs"</font>);
00052   <font class="keywordtype">char</font> *outfile = <a class="code" href="general_c.html#a23">mstring_concat</a> (path, sfile);
00053   <font class="keywordtype">char</font> *s;
00054   FILE *outfptr = fopen (outfile, <font class="stringliteral">"w"</font>);
00055   <a class="code" href="general_c.html#a0">sfree</a> (sfile);
00056 
00057   DPRINTF ((<font class="stringliteral">"Output lcl file: %s / %s / %s"</font>, path, specname, outfile));
00058   
00059   <font class="comment">/* check write permission */</font>
00060   
00061   <font class="keywordflow">if</font> (outfptr == 0)
00062     {                           <font class="comment">/* fopen fails */</font>
00063       <font class="keywordflow">if</font> (!haserror)
00064         {
00065           <a class="code" href="llerror_c.html#a55">lclplainerror</a> (message (<font class="stringliteral">"Cannot write to output file: %s"</font>, 
00066                                   cstring_fromChars (outfile)));
00067           haserror = TRUE;
00068         }
00069       <a class="code" href="general_c.html#a0">sfree</a> (outfile);
00070       <font class="keywordflow">return</font>;
00071     }
00072 
00073   fprintf (outfptr, msg);
00074   fprintf (outfptr, <font class="stringliteral">"%s\n"</font>, LCL_PARSE_VERSION);
00075   
00076   <font class="comment">/* output line %LCLimports foo bar ... */</font>
00077   fprintf (outfptr, <font class="stringliteral">"%%LCLimports "</font>);
00078 
00079   lsymbolSet_elements (g_currentImports, sym)<font class="keyword"></font>
00080 <font class="keyword">    </font>{
00081       s = <a class="code" href="lsymbol_c.html#a17">lsymbol_toChars</a> (sym);
00082 
00083       <font class="keywordflow">if</font> (s != NULL &amp;&amp; !<a class="code" href="general_c.html#a40">mstring_equal</a> (s, specname))
00084         {
00085           fprintf (outfptr, <font class="stringliteral">"%s "</font>, s);
00086         }
00087     } end_lsymbolSet_elements;
00088   
00089   fprintf (outfptr, <font class="stringliteral">"\n"</font>);
00090   
00091   <a class="code" href="sort_c.html#a106">sort_dump</a> (outfptr, TRUE);
00092   <a class="code" href="symtable_c.html#a53">symtable_dump</a> (g_symtab, outfptr, TRUE);
00093 
00094   check (fclose (outfptr) == 0);  
00095   <a class="code" href="general_c.html#a0">sfree</a> (outfile);  
00096 }
00097 
00098 <font class="keywordtype">void</font>
<a name="l00099"></a><a class="code" href="imports_c.html#a1">00099</a> <a class="code" href="imports_c.html#a1">importCTrait</a> (<font class="keywordtype">void</font>)<font class="keyword"></font>
00100 <font class="keyword"></font>{
00101   <font class="keywordtype">char</font> **infile = (<font class="keywordtype">char</font> **) dmalloc (<font class="keyword">sizeof</font> (*infile));
00102   filestatus status = <a class="code" href="osd_c.html#a6">osd_findOnLarchPath</a> (CTRAITSYMSNAME, infile);
00103 
00104   
00105   <font class="keywordflow">switch</font> (status)
00106     {
00107     <font class="keywordflow">case</font> OSD_FILEFOUND:
00108       <font class="comment">/*</font>
00109 <font class="comment">      ** This line was missing before version 2.3f.  Bug fix by Mike Smith.</font>
00110 <font class="comment">      **    This looks like a bug - infile is already fully qualified path  </font>
00111 <font class="comment">      **    parseSignatures() adds another path to the front and fails to   </font>
00112 <font class="comment">      **    open the file.                                                  </font>
00113 <font class="comment">      */</font>
00114            
00115       (<font class="keywordtype">void</font>) <a class="code" href="lslparse_c.html#a3">parseSignatures</a> (cstring_fromChars (CTRAITSYMSNAME));
00116       (<font class="keywordtype">void</font>) <a class="code" href="lslparse_c.html#a3">parseSignatures</a> (cstring_fromChars (*infile));
00117       <font class="keywordflow">break</font>;
00118     <font class="keywordflow">case</font> OSD_FILENOTFOUND:
00119       <font class="comment">/* try spec name */</font>
00120       status = <a class="code" href="osd_c.html#a6">osd_findOnLarchPath</a> (CTRAITSPECNAME, infile);
00121 
00122       <font class="keywordflow">if</font> (status == OSD_FILEFOUND)
00123         {
00124           <a class="code" href="lslparse_c.html#a12">callLSL</a> (CTRAITSPECNAME,
00125                    cstring_toCharsSafe
00126                    (message (<font class="stringliteral">"includes %s (%s for String)"</font>,
00127                              cstring_fromChars (CTRAITFILENAMEN), 
00128                              <a class="code" href="cstring_c.html#a28">cstring_fromChars</a> (sort_getName (sort_cstring)))));
00129           <font class="keywordflow">break</font>;
00130         }
00131       <font class="keywordflow">else</font>
00132         {
00133           lldiagmsg 
00134             (<a class="code" href="message_c.html#a18">message</a> (<font class="stringliteral">"Unable to find %s or %s.  Check LARCH_PATH environment variable."</font>,
00135                       cstring_fromChars (CTRAITSYMSNAME), 
00136                       <a class="code" href="cstring_c.html#a28">cstring_fromChars</a> (CTRAITSPECNAME)));
00137           <a class="code" href="llmain_c.html#a26">llexit</a> (LLFAILURE);
00138         }
00139     <font class="keywordflow">case</font> OSD_PATHTOOLONG:
00140       <a class="code" href="llerror_c.html#a47">lclbug</a> (message (<font class="stringliteral">"importCTrait: the concatenated directory and file "</font>
00141                        <font class="stringliteral">"name are too long: %s: "</font>
00142                        <font class="stringliteral">"continuing without it"</font>, 
00143                        cstring_fromChars (CTRAITSPECNAME)));
00144       <font class="keywordflow">break</font>;
00145     }
00146 
00147   <a class="code" href="general_c.html#a0">sfree</a> (*infile);
00148   <a class="code" href="general_c.html#a0">sfree</a> (infile);
00149 }
00150 
00151 <font class="comment">/*</font>
00152 <font class="comment">** processImport --- load imports from file</font>
00153 <font class="comment">**</font>
00154 <font class="comment">**    impkind: IMPPLAIN  file on SPEC_PATH</font>
00155 <font class="comment">**                       # include "./file.h" if it exists,</font>
00156 <font class="comment">**                       # include "&lt;directory where spec was found&gt;/file.h" if not.</font>
00157 <font class="comment">**                         (warn if neither exists)</font>
00158 <font class="comment">**            IMPBRACKET file in default LCL imports directory</font>
00159 <font class="comment">**                       # include &lt;file.h&gt;</font>
00160 <font class="comment">**            IMPQUOTE   file directly</font>
00161 <font class="comment">**                       # include "file.h"</font>
00162 <font class="comment">*/</font>
00163 
00164 <font class="keywordtype">void</font>
<a name="l00165"></a><a class="code" href="imports_c.html#a2">00165</a> <a class="code" href="imports_c.html#a2">processImport</a> (lsymbol importSymbol, ltoken tok, impkind kind)<font class="keyword"></font>
00166 <font class="keyword"></font>{
00167   <font class="keywordtype">bool</font> readableP, oldexporting;
00168   <font class="keywordtype">bool</font> oldFormat = FALSE;
00169   tsource *imported, *imported2, *lclsource;
00170   <font class="keywordtype">char</font> *bufptr, *tmpbufptr, *cptr;
00171   <font class="keywordtype">char</font> *name;
00172   lsymbol sym;
00173   <font class="keywordtype">char</font> importName[MAX_NAME_LENGTH + 1], *importFileName, *realfname;
00174   <font class="keywordtype">char</font> *path;
00175   <font class="keywordtype">char</font> *fpath, *fpath2;
00176   mapping *map;
00177   filestatus ret;
00178 
00179   importFileName = <a class="code" href="lsymbol_c.html#a16">lsymbol_toCharsSafe</a> (importSymbol);
00180   name = <a class="code" href="general_c.html#a23">mstring_concat</a> (importFileName, IO_SUFFIX);
00181   realfname = name;
00182 
00183   <font class="comment">/*</font>
00184 <font class="comment">  ** find .lcs file</font>
00185 <font class="comment">  */</font>
00186   
00187   <font class="keywordflow">switch</font> (kind)
00188     {
00189     <font class="keywordflow">case</font> IMPPLAIN:
00190       path = cstring_toCharsSafe 
00191         (<a class="code" href="message_c.html#a18">message</a> (<font class="stringliteral">"%s%c%s"</font>, cstring_fromChars (g_localSpecPath), SEPCHAR, <a class="code" href="context_c.html#a249">context_getLarchPath</a> ()));
00192       
00193       <font class="keywordflow">break</font>;
00194     <font class="keywordflow">case</font> IMPBRACKET:
00195       path = <a class="code" href="general_c.html#a27">mstring_copy</a> (cstring_toCharsSafe (context_getLCLImportDir ()));
00196       <font class="keywordflow">break</font>;
00197     <font class="keywordflow">case</font> IMPQUOTE:
00198       path = <a class="code" href="general_c.html#a27">mstring_copy</a> (g_localSpecPath);
00199       <font class="keywordflow">break</font>;
00200     <font class="keywordflow">default</font>:
00201       path = mstring_createEmpty (); <font class="comment">/* suppress gcc error message */</font>
00202       llbuglit (<font class="stringliteral">"bad imports case\n"</font>);
00203     }
00204 
00205   <font class="keywordflow">if</font> ((ret = <a class="code" href="osd_c.html#a7">osd_getPath</a> (path, realfname, &amp;fpath)) != OSD_FILEFOUND)
00206     {
00207       <font class="keywordtype">char</font> *fname2;
00208       
00209       <font class="keywordflow">if</font> (ret == OSD_PATHTOOLONG)
00210         {
00211           <a class="code" href="llerror_c.html#a49">llfatalerrorLoc</a> (cstring_makeLiteral (<font class="stringliteral">"Path too long"</font>));
00212         }
00213       
00214       imported2 = <a class="code" href="source_c.html#a2">tsource_create</a> (importFileName, LCL_SUFFIX, FALSE);
00215       fname2 = tsource_fileName (imported2);
00216       
00217       
00218 
00219       <font class="keywordflow">if</font> (<a class="code" href="osd_c.html#a7">osd_getPath</a> (path, fname2, &amp;fpath2) == OSD_FILEFOUND)
00220         {
00221           llfatalerrorLoc
00222             (<a class="code" href="message_c.html#a18">message</a> (<font class="stringliteral">"Specs must be processed before it can be imported: %s"</font>, 
00223                       cstring_fromChars (fpath2)));
00224         }
00225       <font class="keywordflow">else</font>
00226         {
00227           <font class="keywordflow">if</font> (kind == IMPPLAIN || kind == IMPQUOTE)
00228             <a class="code" href="llerror_c.html#a49">llfatalerrorLoc</a> (message (<font class="stringliteral">"Cannot find file to import: %s"</font>, 
00229                                        cstring_fromChars (realfname)));
00230           <font class="keywordflow">else</font>
00231             <a class="code" href="llerror_c.html#a49">llfatalerrorLoc</a> (message (<font class="stringliteral">"Cannot find standard import file: %s"</font>,
00232                                        cstring_fromChars (realfname)));
00233         }
00234     }
00235 
00236   
00237   imported = <a class="code" href="source_c.html#a2">tsource_create</a> (fpath, IO_SUFFIX, FALSE);
00238   
00239   
00240   readableP = <a class="code" href="source_c.html#a5">tsource_open</a> (imported);
00241     
00242   <font class="keywordflow">if</font> (!readableP)
00243     {                   <font class="comment">/* can't read ? */</font>
00244       <a class="code" href="llerror_c.html#a49">llfatalerrorLoc</a> (message (<font class="stringliteral">"Cannot open import file for reading: %s"</font>,
00245                                  cstring_fromChars (tsource_fileName (imported))));
00246     }
00247 
00248   bufptr = <a class="code" href="source_c.html#a4">tsource_nextLine</a> (imported);
00249 
00250   <font class="keywordflow">if</font> (bufptr == 0)
00251     {
00252       llerror (FLG_SYNTAX, message (<font class="stringliteral">"Import file is empty: %s"</font>, 
00253                                     cstring_fromChars (tsource_fileName (imported))));
00254       <a class="code" href="general_c.html#a0">sfree</a> (name);
00255       (<font class="keywordtype">void</font>) <a class="code" href="source_c.html#a0">tsource_close</a> (imported);
00256       <a class="code" href="source_c.html#a1">tsource_free</a> (imported);
00257 
00258       <a class="code" href="general_c.html#a0">sfree</a> (path);
00259       <font class="keywordflow">return</font>;
00260     }
00261 
00262   <font class="comment">/* was it processed successfully ? */</font>
00263   <font class="keywordflow">if</font> (<a class="code" href="general_c.html#a10">firstWord</a> (bufptr, <font class="stringliteral">"%FAILED"</font>))
00264     {
00265       llfatalerrorLoc
00266         (<a class="code" href="message_c.html#a18">message</a> (<font class="stringliteral">"Imported file was not checked successfully: %s."</font>, 
00267                   cstring_fromChars (name)));
00268     }
00269   
00276   <font class="keywordflow">if</font> (<a class="code" href="general_c.html#a10">firstWord</a> (bufptr, <font class="stringliteral">"%PASSED"</font>))
00277     {
00278       <font class="comment">/* %PASSED Output from LCP Version 2.* and 3.* */</font>
00279       <font class="comment">/*                     1234567890123*/</font>
00280       <font class="comment">/*                                 +*/</font>
00281 
00282       cptr = strstr (bufptr, <font class="stringliteral">"LCP Version"</font>);
00283       
00284       <font class="keywordflow">if</font> (cptr != NULL)
00285         {
00286           cptr += 12;
00287           <font class="keywordflow">if</font> (*cptr != <font class="charliteral">'2'</font> &amp;&amp; *cptr != <font class="charliteral">'3'</font>)
00288             {
00289               <a class="code" href="llerror_c.html#a49">llfatalerrorLoc</a> (message (<font class="stringliteral">"Imported file is obsolete: %s."</font>,
00290                                          cstring_fromChars (bufptr)));
00291             }
00292         }
00293       oldFormat = TRUE;
00294     }
00295   <font class="keywordflow">else</font> 
00296     {
00297       <font class="keywordflow">if</font> (!<a class="code" href="general_c.html#a10">firstWord</a> (bufptr, <font class="stringliteral">"%LCS"</font>))
00298         {
00299           <a class="code" href="llerror_c.html#a49">llfatalerrorLoc</a> (message (<font class="stringliteral">"Imported file is not in correct format: %s."</font>,
00300                                     cstring_fromChars (bufptr)));
00301         }
00302     }
00303   
00304   <font class="comment">/* push the imported LCL spec onto g_currentImports */</font>
00305 
00306   <a class="code" href="context_c.html#a233">context_enterImport</a> ();
00307   
00308   bufptr = <a class="code" href="source_c.html#a4">tsource_nextLine</a> (imported);
00309   llassert (bufptr != NULL);
00310 
00311   tmpbufptr = bufptr;
00312 
00313     <font class="comment">/* expect %LCLimports foo bar ... */</font>
00314   <font class="keywordflow">if</font> (<a class="code" href="general_c.html#a10">firstWord</a> (bufptr, <font class="stringliteral">"%LCLimports "</font>))
00315     {
00316       bufptr = bufptr + strlen (<font class="stringliteral">"%LCLimports "</font>);
00317       <font class="keywordflow">while</font> (sscanf (bufptr, <font class="stringliteral">"%s"</font>, importName) == 1)
00318         {
00319           bufptr = bufptr + strlen (importName) + 1;    <font class="comment">/* 1 for space */</font>
00320           sym = <a class="code" href="lsymbol_c.html#a14">lsymbol_fromChars</a> (importName);
00321           <font class="keywordflow">if</font> (sym == importSymbol || 
00322               <a class="code" href="lsymbolSet_c.html#a3">lsymbolSet_member</a> (g_currentImports, sym))
00323             {
00324               <font class="comment">/* ensure that the import list does not contain itself: an</font>
00325 <font class="comment">                 invariant useful for checking imports cycles. */</font>
00326               lclsource = <a class="code" href="lclscan_c.html#a12">LCLScanSource</a> ();
00327               <a class="code" href="llerror_c.html#a56">lclfatalerror</a> (tok, 
00328                              message (<font class="stringliteral">"Imports cycle: %s.lcl imports %s"</font>,
00329                                       cstring_fromChars (importFileName),
00330                                       <a class="code" href="cstring_c.html#a28">cstring_fromChars</a> (importName)));
00331             }     
00332           <font class="comment">/* push them onto g_currentImports */</font>
00333           <font class="comment">/* evs - 94 Apr 3:  I don't think it should do this! */</font>
00334           <font class="comment">/* (void) lsymbolSet_insert (g_currentImports, sym); */</font>
00335         }
00336     }
00337   <font class="keywordflow">else</font>
00338     {
00339       lclsource = <a class="code" href="lclscan_c.html#a12">LCLScanSource</a> ();
00340       <a class="code" href="llerror_c.html#a56">lclfatalerror</a> (tok, message (<font class="stringliteral">"Unexpected line in imported file %s: %s"</font>, 
00341                                    cstring_fromChars (name), 
00342                                    <a class="code" href="cstring_c.html#a28">cstring_fromChars</a> (bufptr)));
00343     }
00344           
00345   <font class="comment">/* read in the imported info */</font>
00346   oldexporting = <a class="code" href="sort_c.html#a104">sort_setExporting</a> (TRUE);
00347 
00348   map = <a class="code" href="mapping_c.html#a4">mapping_create</a> ();
00349 
00350   <font class="comment">/* tok for error line numbering */</font>
00351 
00352   <font class="keywordflow">if</font> (oldFormat)
00353     {
00354             <a class="code" href="sort_c.html#a109">sort_import</a> (imported, tok, map);   
00355     }
00356 
00357   (<font class="keywordtype">void</font>) <a class="code" href="sort_c.html#a104">sort_setExporting</a> (oldexporting);
00358 
00359   <font class="comment">/* sort_import updates a mapping of old anonymous sorts to new</font>
00360 <font class="comment">     anonymous sort that is needed in symtable_import */</font>
00361   <font class="comment">/* mapping_print (map); */</font>
00362   
00363   <font class="keywordflow">if</font> (oldFormat)
00364     {
00365       <a class="code" href="symtable_c.html#a59">symtable_import</a> (imported, tok, map);
00366     }
00367   <font class="keywordflow">else</font>
00368     {
00369       <font class="comment">/* symtable_loadImport (imported, tok, map); */</font>
00370     }
00371   
00372   check (tsource_close (imported));
00373   <a class="code" href="source_c.html#a1">tsource_free</a> (imported);
00374 
00375   <a class="code" href="general_c.html#a0">sfree</a> (map);
00376   <a class="code" href="general_c.html#a0">sfree</a> (name);
00377   <a class="code" href="general_c.html#a0">sfree</a> (path);
00378 
00379   <a class="code" href="context_c.html#a234">context_leaveImport</a> ();  
00380 }
00381 
00382 
00383 
</div></pre><hr><address><small>Generated at Fri Nov 3 18:57:41 2000 for LCLint by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.3 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2000</small></address>
</body>
</html>
