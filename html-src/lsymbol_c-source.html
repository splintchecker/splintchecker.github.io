<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>lsymbol.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.3 on Fri Nov 3 18:57:43 2000 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>lsymbol.c</h1><a href="lsymbol_c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">** LCLint - annotation-assisted static program checker</font>
00003 <font class="comment">** Copyright (C) 1994-2000 University of Virginia,</font>
00004 <font class="comment">**         Massachusetts Institute of Technology</font>
00005 <font class="comment">**</font>
00006 <font class="comment">** This program is free software; you can redistribute it and/or modify it</font>
00007 <font class="comment">** under the terms of the GNU General Public License as published by the</font>
00008 <font class="comment">** Free Software Foundation; either version 2 of the License, or (at your</font>
00009 <font class="comment">** option) any later version.</font>
00010 <font class="comment">** </font>
00011 <font class="comment">** This program is distributed in the hope that it will be useful, but</font>
00012 <font class="comment">** WITHOUT ANY WARRANTY; without even the implied warranty of</font>
00013 <font class="comment">** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</font>
00014 <font class="comment">** General Public License for more details.</font>
00015 <font class="comment">** </font>
00016 <font class="comment">** The GNU General Public License is available from http://www.gnu.org/ or</font>
00017 <font class="comment">** the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston,</font>
00018 <font class="comment">** MA 02111-1307, USA.</font>
00019 <font class="comment">**</font>
00020 <font class="comment">** For information on lclint: lclint-request@cs.virginia.edu</font>
00021 <font class="comment">** To report a bug: lclint-bug@cs.virginia.edu</font>
00022 <font class="comment">** For more information: http://lclint.cs.virginia.edu</font>
00023 <font class="comment">*/</font>
00024 <font class="comment">/*</font>
00025 <font class="comment">** lsymbol.c</font>
00026 <font class="comment">**</font>
00027 <font class="comment">** String manager</font>
00028 <font class="comment">**</font>
00029 <font class="comment">**      This module implements an abstraction for efficiently managing</font>
00030 <font class="comment">**      string comparisons.  It alloctes and manages a string context,</font>
00031 <font class="comment">**      which consists of three major data structures:</font>
00032 <font class="comment">**       - a StringEntry table</font>
00033 <font class="comment">**       - a character-string table</font>
00034 <font class="comment">**       - a hash table</font>
00035 <font class="comment">**</font>
00036 <font class="comment">**      A StringEntry table is made of of StringEntries. StringEntries</font>
00037 <font class="comment">**      are linked in hash-chains to support fast lookup. Every</font>
00038 <font class="comment">**      allocated StringEntry corresponds to a unique character-string</font>
00039 <font class="comment">**      in the character-string table. StringEntries can be referenced</font>
00040 <font class="comment">**      via Symbol values.</font>
00041 <font class="comment">**</font>
00042 <font class="comment">**      A character-string table is composed of character-strings. A</font>
00043 <font class="comment">**      character-string is a variable length byte array that is always</font>
00044 <font class="comment">**      null-terminated ('\0').</font>
00045 <font class="comment">**</font>
00046 <font class="comment">**      A hash table manages the start of each hash-list of StringEntries.</font>
00047 <font class="comment">**      StringEntries are entered into the hash-list by hashing on its</font>
00048 <font class="comment">**      character-string representation.</font>
00049 <font class="comment">**</font>
00050 <font class="comment">**      This module provides routines for retrieving a unique Symbol for a</font>
00051 <font class="comment">**      given character-string, and returning the character-string given its</font>
00052 <font class="comment">**      corresponding Symbol. An item is allocated in both tables whenever a</font>
00053 <font class="comment">**      new character-string is encountered, otherwise the Symbol for the</font>
00054 <font class="comment">**      character-string is found and returned.</font>
00055 <font class="comment">**</font>
00056 <font class="comment">**  AUTHORS:</font>
00057 <font class="comment">**</font>
00058 <font class="comment">**      Shota Aki</font>
00059 <font class="comment">**</font>
00060 <font class="comment">**  MODIFICATION HISTORY:</font>
00061 <font class="comment">**</font>
00062 <font class="comment">**      {0} Aki      at Digital -- 89.08.07 -- original</font>
00063 <font class="comment">**      {1} Aki      at Digital -- 89.11.13 -- context switchable</font>
00064 <font class="comment">**      {2} Aki      at Digital -- 89.11.28 -- removed use of TABLES interface</font>
00065 <font class="comment">**      {3} Aki      at Digital -- 89.11.29 -- moved to RC</font>
00066 <font class="comment">**      {4} Aki      at Digital -- 90.04.10 -- support primary-context</font>
00067 <font class="comment">**      {5} McKeeman at Digital -- 90.05.08 -- C to Larch SL</font>
00068 <font class="comment">**      {6} Wild     at Digital -- 91.06.26 -- Update copyright notice.</font>
00069 <font class="comment">**      {n} Who      at Where   -- yy.mm.dd -- what</font>
00070 <font class="comment">*/</font>
00071 
00072 <font class="preprocessor"># include "lclintMacros.nf"</font>
00073 <font class="preprocessor"># include "basic.h"</font>
00074 
00075 <font class="comment">/*@+ignorequals@*/</font>
00076 
00077 <font class="comment">/*@constant int NULLFACTOR; @*/</font>
<a name="l00078"></a><a class="code" href="lsymbol_c.html#a0">00078</a> <font class="preprocessor"># define NULLFACTOR 1</font>
00079 <font class="preprocessor"></font>
<a name="l00080"></a><a class="code" href="lsymbol_c.html#a1">00080</a> <font class="keyword">typedef</font> Handle CharIndex;     
00081 
<a name="l00082"></a><a class="code" href="struct_StringEntry.html">00082</a> <font class="keyword">typedef</font> <font class="keyword">struct</font>
00083 <font class="keyword"></font>{
<a name="l00084"></a><a class="code" href="struct_StringEntry.html#m0">00084</a>   lsymbol HashNext;     
<a name="l00085"></a><a class="code" href="struct_StringEntry.html#m1">00085</a>   CharIndex i;                  
00086 } <a class="code" href="struct_StringEntry.html">StringEntry</a>;
00087 
00088 <font class="keyword">static</font> <font class="keywordtype">void</font> AllocCharSpace (<font class="keywordtype">unsigned</font> p_newSize) <font class="comment">/*@modifies internalState@*/</font> ;
00089 <font class="keyword">static</font> CharIndex AllocChar (<font class="comment">/*@unique@*/</font> <font class="keywordtype">char</font> *p_name) <font class="comment">/*@modifies internalState@*/</font> ;
00090 <font class="keyword">static</font> <font class="keywordtype">void</font> AllocEntrySpace (<font class="keywordtype">unsigned</font> p_newSize) <font class="comment">/*@modifies internalState@*/</font> ;
00091 <font class="keyword">static</font> lsymbol AllocEntry (<font class="keywordtype">char</font> *p_name, <font class="keywordtype">long</font> <font class="keywordtype">unsigned</font> p_hashValue)
00092    <font class="comment">/*@modifies internalState@*/</font> ;
00093 
00094 <font class="keyword">static</font> <font class="comment">/*@only@*/</font> <font class="comment">/*@null@*/</font> lsymbol *hashArray = NULL; 
00095 
00096 <font class="keyword">static</font> <font class="keywordtype">long</font> <font class="keywordtype">unsigned</font> MaxChar;   
00097 <font class="keyword">static</font> CharIndex FreeChar;      
00098 <font class="keyword">static</font> <font class="comment">/*@only@*/</font> <font class="comment">/*@null@*/</font> <font class="keywordtype">char</font> *CharString;
00099 
00100 <font class="keyword">static</font> <font class="keywordtype">long</font> <font class="keywordtype">unsigned</font> MaxEntry;  
00101 <font class="keyword">static</font> lsymbol FreeEntry;       
00102 <font class="keyword">static</font> <font class="comment">/*@only@*/</font> <font class="comment">/*@null@*/</font> <a class="code" href="struct_StringEntry.html">StringEntry</a> *Entry;        
00103 
00104 lsymbol
<a name="l00105"></a><a class="code" href="lsymbol_c.html#a13">00105</a> <a class="code" href="lsymbol_c.html#a13">lsymbol_fromString</a> (cstring s)<font class="keyword"></font>
00106 <font class="keyword"></font>{
00107   <font class="keywordflow">if</font> (cstring_isUndefined (s))
00108     {
00109       <font class="keywordflow">return</font> lsymbol_undefined;
00110     }
00111   <font class="keywordflow">else</font>
00112     {
00113       <font class="keywordflow">return</font> (<a class="code" href="lsymbol_c.html#a14">lsymbol_fromChars</a> (cstring_toCharsSafe (s)));
00114     }
00115 }
00116 
00117 lsymbol
<a name="l00118"></a><a class="code" href="lsymbol_c.html#a14">00118</a> <a class="code" href="lsymbol_c.html#a14">lsymbol_fromChars</a> (<font class="comment">/*@temp@*/</font> <font class="keywordtype">char</font> *name)<font class="keyword"></font>
00119 <font class="keyword"></font>{
00120   lsymbol ss;
00121   <font class="keywordtype">long</font> <font class="keywordtype">unsigned</font> hashValue;      
00122   <font class="keywordtype">unsigned</font> h = 0;            
00123   <font class="keywordtype">char</font> *p = name;
00124 
00125   <font class="keywordflow">while</font> (*p != <font class="charliteral">'\0'</font>)
00126     { 
00127       h = (h &lt;&lt; 1) + (<font class="keywordtype">unsigned</font>) (*p++); 
00128     } 
00129   
00130   hashValue = h &amp; HASHMASK;         
00131 
00132   <font class="keywordflow">if</font> (hashArray == NULL) <font class="comment">/* evs - was MaxIndex == 0 */</font>
00133     {
00134       <font class="comment">/* nothing initialized */</font>
00135       ss = AllocEntry (name, hashValue);        
00136     }
00137   <font class="keywordflow">else</font>
00138     {
00139       ss = hashArray[hashValue]; <font class="comment">/* start of hash chain */</font>
00140 
00141       <font class="keywordflow">if</font> (ss == lsymbol_undefined)
00142         {
00143           <font class="comment">/* hash not initialized */</font>
00144           ss = AllocEntry (name, hashValue);
00145         }
00146       <font class="keywordflow">else</font>
00147         {
00148          <font class="comment">/*</font>
00149 <font class="comment">          * Traverse hash-chain. Loop terminates when</font>
00150 <font class="comment">          * a match is found or end of chain is encountered.</font>
00151 <font class="comment">          */</font>
00152 
00153           llassert (Entry != NULL);
00154           llassert (CharString != NULL);
00155 
00156           <font class="keywordflow">while</font> (strcmp (&amp;CharString[Entry[ss].i], name) != 0)
00157             {
00158               <font class="keywordflow">if</font> (lsymbol_undefined == (ss = Entry[ss].HashNext))
00159                 {
00160                   ss = AllocEntry (name, hashValue);
00161                   <font class="keywordflow">break</font>;
00162                 }
00163             }
00164         }
00165     }
00166 
00167   <font class="keywordflow">return</font> ss;
00168 }
00169 
<a name="l00170"></a><a class="code" href="lsymbol_c.html#a15">00170</a> cstring <a class="code" href="lsymbol_c.html#a15">lsymbol_toString</a> (lsymbol ss)<font class="keyword"></font>
00171 <font class="keyword"></font>{
00172   <font class="keywordflow">return</font> (<a class="code" href="cstring_c.html#a28">cstring_fromChars</a> (lsymbol_toChars (ss)));
00173 }
00174 
00175 <font class="keywordtype">char</font> *
<a name="l00176"></a><a class="code" href="lsymbol_c.html#a16">00176</a> <a class="code" href="lsymbol_c.html#a16">lsymbol_toCharsSafe</a> (lsymbol ss)<font class="keyword"></font>
00177 <font class="keyword"></font>{
00178   <font class="keywordtype">char</font> *ret = <a class="code" href="lsymbol_c.html#a17">lsymbol_toChars</a> (ss);
00179 
00180   <font class="keywordflow">if</font> (ret == NULL) 
00181     {
00182       ret = <a class="code" href="general_c.html#a29">mstring_create</a> (0);
00183     } 
00184 
00185   <font class="keywordflow">return</font> ret;
00186 }
00187 
<a name="l00188"></a><a class="code" href="lsymbol_c.html#a17">00188</a> <font class="keywordtype">char</font> *<a class="code" href="lsymbol_c.html#a17">lsymbol_toChars</a> (lsymbol ss)<font class="keyword"></font>
00189 <font class="keyword"></font>{
00190   <font class="keywordflow">if</font> (lsymbol_isDefined (ss))
00191     {
00192       <font class="keywordflow">if</font> (ss &gt;= FreeEntry)
00193         {
00194           llcontbug (message (<font class="stringliteral">"lsymbol_toChars: invalid lsymbol: %d"</font>, ss));
00195           <font class="keywordflow">return</font> NULL;
00196         }
00197       
00198       llassert (Entry != NULL);
00199       llassert (CharString != NULL);
00200       
00201       <font class="keywordflow">return</font> &amp;CharString[Entry[ss].i];
00202     }
00203   <font class="keywordflow">else</font>
00204     {
00205       <font class="keywordflow">return</font> NULL;
00206     }
00207 }
00208 
00209 <font class="keyword">static</font> <font class="keywordtype">void</font>
00210 AllocCharSpace (<font class="keywordtype">unsigned</font> newSize)<font class="keyword"></font>
00211 <font class="keyword"></font>{
00212   llassert (newSize &gt; MaxChar);
00213   
00214   CharString = (<font class="keywordtype">char</font> *) drealloc ((<font class="keywordtype">void</font> *) CharString, newSize * <font class="keyword">sizeof</font> (*CharString));
00215   MaxChar = newSize;
00216 <font class="comment">/*@-compdef@*/</font>
00217 } <font class="comment">/*@=compdef@*/</font>
00218 
00219 <font class="keyword">static</font> CharIndex
00220 AllocChar (<font class="comment">/*@unique@*/</font> <font class="keywordtype">char</font> *name)<font class="keyword"></font>
00221 <font class="keyword"></font>{
00222   <font class="keywordtype">int</font> namelength;
00223   CharIndex retVal;
00224   <font class="keywordtype">long</font> <font class="keywordtype">unsigned</font> size;
00225   CharIndex unused;
00226 
00227   namelength = <a class="code" href="general_c.html#a34">size_toInt</a> (strlen (name));
00228   unused = FreeChar;
00229   size = MaxChar;
00230 
00231   <font class="keywordflow">if</font> ((unused + namelength + NULLFACTOR) &gt; size)
00232     {
00233       <font class="keywordflow">if</font> (size == 0)
00234         size = INITCHARSTRING;
00235       <font class="keywordflow">else</font>
00236         size = (<font class="keywordtype">unsigned</font>) (DELTACHARSTRING * size);
00237 
00238       AllocCharSpace (size);
00239     }
00240 
00241   llassert (CharString != NULL);
00242 
00243   retVal = unused;              
00244   strcpy (&amp;CharString[unused], name);   
00245   unused += namelength;
00246   CharString[unused] = <font class="charliteral">'\0'</font>;    
00247   unused += 1;
00248 
00249   FreeChar = unused;
00250   <font class="keywordflow">return</font> retVal;
00251 }
00252 
00253 <font class="keyword">static</font> <font class="keywordtype">void</font>
00254 AllocEntrySpace (<font class="keywordtype">unsigned</font> newSize)<font class="keyword"></font>
00255 <font class="keyword"></font>{
00256   llassert (newSize &gt; MaxEntry);
00257 
00258   <font class="comment">/* Casts mess up checking here. */</font>
00259   <font class="comment">/*@-mustfree@*/</font>
00260   Entry = (<a class="code" href="struct_StringEntry.html">StringEntry</a> *) drealloc ((<font class="keywordtype">void</font> *) Entry, newSize * <font class="keyword">sizeof</font> (*Entry));
00261   <font class="comment">/*@=mustfree@*/</font>
00262 
00263   <font class="keywordflow">if</font> (MaxEntry == 0) MaxEntry = 1;
00264 
00265   FreeEntry = MaxEntry;
00266   MaxEntry = newSize;
00267 <font class="comment">/*@-compdef@*/</font>
00268 } <font class="comment">/*@=compdef@*/</font>
00269 
00270 <font class="keyword">static</font> lsymbol AllocEntry (<font class="keywordtype">char</font> *name, <font class="keywordtype">long</font> <font class="keywordtype">unsigned</font> hashValue)<font class="keyword"></font>
00271 <font class="keyword"></font>{
00272   lsymbol retVal;
00273   <font class="keywordtype">long</font> <font class="keywordtype">unsigned</font> size;
00274 
00275   size = MaxEntry;
00276 
00277   <font class="keywordflow">if</font> ((retVal = FreeEntry) == size)
00278     {
00279       <font class="keywordflow">if</font> (size == 0)
00280         {
00281           size = INITSTRINGENTRY;
00282         }
00283       <font class="keywordflow">else</font>
00284         {
00285           size = (<font class="keywordtype">unsigned</font>) (DELTASTRINGENTRY * size);
00286         }
00287 
00288       AllocEntrySpace (size);
00289       retVal = FreeEntry;
00290     }
00291   
00292   FreeEntry = retVal + 1;
00293 
00294   llassert (hashArray != NULL);
00295   llassert (Entry != NULL);
00296   
00297   Entry[retVal].HashNext = hashArray[hashValue];
00298   hashArray[hashValue] = retVal;
00299   Entry[retVal].i = AllocChar (name);
00300   
00301   <font class="keywordflow">return</font> retVal;
00302 }
00303 
00304 <font class="keywordtype">void</font>
<a name="l00305"></a><a class="code" href="lsymbol_c.html#a18">00305</a> <a class="code" href="lsymbol_c.html#a18">lsymbol_initMod</a> (<font class="keywordtype">void</font>)
00306    <font class="comment">/*@globals undef CharString, undef Entry; @*/</font>
00307 {
00308   <font class="keywordtype">int</font> i;
00309 
00310   <font class="keywordflow">if</font> (hashArray != NULL)
00311     {
00312       <a class="code" href="general_c.html#a0">sfree</a> (hashArray); 
00313     }
00314   
00315   hashArray = (lsymbol *) dmalloc (HASHSIZE * <font class="keyword">sizeof</font> (*hashArray));
00316 
00317   <font class="keywordflow">for</font> (i = 0; i &lt; HASHSIZE; i++)
00318     {
00319       hashArray[i] = lsymbol_undefined;
00320     } 
00321 
00322   MaxChar = 0;
00323   MaxEntry = 0;
00324 
00325   FreeChar = 0;
00326   FreeEntry = 0; 
00327 
00328   CharString = (<font class="keywordtype">char</font> *) 0;
00329   Entry = (<a class="code" href="struct_StringEntry.html">StringEntry</a> *) 0;
00330 <font class="comment">/*@-compdef@*/</font> 
00331 } 
00332 <font class="comment">/*@=compdef@*/</font> 
00333 
00334 <font class="keywordtype">void</font>
<a name="l00335"></a><a class="code" href="lsymbol_c.html#a19">00335</a> <a class="code" href="lsymbol_c.html#a19">lsymbol_destroyMod</a> (<font class="keywordtype">void</font>)
00336    <font class="comment">/*@globals killed Entry, killed CharString, killed hashArray@*/</font>
00337 {
00338    <a class="code" href="general_c.html#a0">sfree</a> (Entry);      
00339    <a class="code" href="general_c.html#a0">sfree</a> (CharString); 
00340    <a class="code" href="general_c.html#a0">sfree</a> (hashArray); 
00341 }
00342 
00343 <font class="keywordtype">void</font>
<a name="l00344"></a><a class="code" href="lsymbol_c.html#a20">00344</a> <a class="code" href="lsymbol_c.html#a20">lsymbol_printStats</a> (<font class="keywordtype">void</font>)<font class="keyword"></font>
00345 <font class="keyword"></font>{
00346   <font class="comment">/* only for debugging */</font>
00347   printf (<font class="stringliteral">"Number of lsymbols generated = %d\n"</font>, (<font class="keywordtype">int</font>) FreeEntry);
00348 }
00349 
00350 <font class="comment">/*</font>
00351 <font class="comment">** note lsymbol_setbool, etc. defined in abstract.c</font>
00352 <font class="comment">*/</font>
00353 
00354 
00355 
00356 
00357 
00358 
00359 
00360 
</div></pre><hr><address><small>Generated at Fri Nov 3 18:57:43 2000 for LCLint by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.3 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2000</small></address>
</body>
</html>
