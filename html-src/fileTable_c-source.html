<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>fileTable.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.3 on Fri Nov 3 18:57:41 2000 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>fileTable.c</h1><a href="fileTable_c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">** LCLint - annotation-assisted static program checker</font>
00003 <font class="comment">** Copyright (C) 1994-2000 University of Virginia,</font>
00004 <font class="comment">**         Massachusetts Institute of Technology</font>
00005 <font class="comment">**</font>
00006 <font class="comment">** This program is free software; you can redistribute it and/or modify it</font>
00007 <font class="comment">** under the terms of the GNU General Public License as published by the</font>
00008 <font class="comment">** Free Software Foundation; either version 2 of the License, or (at your</font>
00009 <font class="comment">** option) any later version.</font>
00010 <font class="comment">** </font>
00011 <font class="comment">** This program is distributed in the hope that it will be useful, but</font>
00012 <font class="comment">** WITHOUT ANY WARRANTY; without even the implied warranty of</font>
00013 <font class="comment">** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</font>
00014 <font class="comment">** General Public License for more details.</font>
00015 <font class="comment">** </font>
00016 <font class="comment">** The GNU General Public License is available from http://www.gnu.org/ or</font>
00017 <font class="comment">** the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston,</font>
00018 <font class="comment">** MA 02111-1307, USA.</font>
00019 <font class="comment">**</font>
00020 <font class="comment">** For information on lclint: lclint-request@cs.virginia.edu</font>
00021 <font class="comment">** To report a bug: lclint-bug@cs.virginia.edu</font>
00022 <font class="comment">** For more information: http://lclint.cs.virginia.edu</font>
00023 <font class="comment">*/</font>
00024 <font class="comment">/*</font>
00025 <font class="comment">** fileTable.c</font>
00026 <font class="comment">**</font>
00027 <font class="comment">** replaces filenamemap.c</font>
00028 <font class="comment">** based (loosely) on typeTable.c</font>
00029 <font class="comment">**</font>
00030 <font class="comment">** entries in the fileTable are:</font>
00031 <font class="comment">**</font>
00032 <font class="comment">**        name - name of the file</font>
00033 <font class="comment">**        type - kind of file (a temp file to be deleted?)</font>
00034 <font class="comment">**        link - derived from this file</font>
00035 <font class="comment">**</font>
00036 <font class="comment">*/</font>
00037 <font class="comment">/*</font>
00038 <font class="comment"> * Herbert 04/1997:</font>
00039 <font class="comment"> * - Added conditional stuff (macros OS2 and MSDOS) to make names of temporary </font>
00040 <font class="comment"> *   files under Windows or OS/2 not larger than 8+3 characters to avoid </font>
00041 <font class="comment"> *   trouble with FAT file systems or Novell Netware volumes.</font>
00042 <font class="comment"> * - Added include of new header file portab.h containing OS dependent stuff.</font>
00043 <font class="comment"> * - Changed occurance of '/' as path delimiter to a macro.</font>
00044 <font class="comment"> * - Added conditional stuff (#define and #include) for IBM's compiler.</font>
00045 <font class="comment"> */</font>
00046 
00047 <font class="preprocessor"># include "lclintMacros.nf"</font>
00048 <font class="preprocessor"># include "llbasic.h"</font>
00049 <font class="preprocessor"># include "osd.h"</font>
00050 <font class="preprocessor"># include "llmain.h"</font>
00051 <font class="preprocessor"># include "portab.h"</font>
00052 <font class="preprocessor"># if defined(__IBMC__) &amp;&amp; defined(OS2)</font>
00053 <font class="preprocessor"></font><font class="preprocessor"># include &lt;process.h&gt;</font>
00054 <font class="preprocessor"># define getpid _getpid</font>
00055 <font class="preprocessor"></font><font class="preprocessor"># endif</font>
00056 <font class="preprocessor"></font>
00057 <font class="comment">/*@access fileId*/</font>
00058 
00059 <font class="keyword">static</font> <font class="keywordtype">bool</font> fileTable_inRange (fileTable ft, fileId fid) <font class="comment">/*@*/</font> 
00060 {
00061   <font class="keywordflow">return</font> (fileTable_isDefined (ft) &amp;&amp; (fid &gt;= 0) &amp;&amp; (fid &lt; ft-&gt;nentries));
00062 }
00063 
00064 <font class="keyword">static</font> fileId fileTable_internAddEntry (fileTable p_ft, <font class="comment">/*@only@*/</font> ftentry p_e) 
00065    <font class="comment">/*@modifies p_ft@*/</font> ;
00066 <font class="keyword">static</font> <font class="comment">/*@only@*/</font> <font class="keywordtype">char</font> *makeTempName (<font class="keywordtype">char</font> *p_dir, <font class="keywordtype">char</font> *p_pre, <font class="keywordtype">char</font> *p_suf);
00067 
00068 <font class="keyword">static</font> <font class="comment">/*@only@*/</font> cstring
00069 fileType_unparse (fileType ft)<font class="keyword"></font>
00070 <font class="keyword"></font>{
00071   <font class="keywordflow">switch</font> (ft)
00072     {
00073     <font class="keywordflow">case</font> FILE_NORMAL:  <font class="keywordflow">return</font> cstring_makeLiteral (<font class="stringliteral">"normal"</font>);
00074     <font class="keywordflow">case</font> FILE_NODELETE:  <font class="keywordflow">return</font> cstring_makeLiteral (<font class="stringliteral">"normal"</font>);
00075     <font class="keywordflow">case</font> FILE_LSLTEMP: <font class="keywordflow">return</font> cstring_makeLiteral (<font class="stringliteral">"ltemp"</font>);
00076     <font class="keywordflow">case</font> FILE_HEADER:  <font class="keywordflow">return</font> cstring_makeLiteral (<font class="stringliteral">"header"</font>);
00077     <font class="keywordflow">case</font> FILE_MACROS:  <font class="keywordflow">return</font> cstring_makeLiteral (<font class="stringliteral">"macros"</font>);
00078     }
00079 
00080   BADEXIT;
00081 }
00082 
00083 <font class="keyword">static</font> <font class="keywordtype">int</font>
00084 fileTable_getIndex (fileTable ft, cstring s)<font class="keyword"></font>
00085 <font class="keyword"></font>{
00086   <font class="keywordflow">if</font> (ft == NULL) <font class="keywordflow">return</font> NOT_FOUND;
00087   <font class="keywordflow">return</font> (<a class="code" href="hashTable_c.html#a22">hashTable_lookup</a> (ft-&gt;htable, s));
00088 }
00089 
00090 <font class="comment">/*@only@*/</font> cstring
<a name="l00091"></a><a class="code" href="fileTable_c.html#a6">00091</a> <a class="code" href="fileTable_c.html#a6">fileTable_unparse</a> (fileTable ft)<font class="keyword"></font>
00092 <font class="keyword"></font>{
00093   cstring s = cstring_undefined;
00094   <font class="keywordtype">int</font> i;
00095 
00096   <font class="keywordflow">if</font> (fileTable_isUndefined (ft))
00097     {
00098       <font class="keywordflow">return</font> (cstring_makeLiteral (<font class="stringliteral">"&lt;fileTable undefined&gt;"</font>));
00099     }
00100 
00101   <font class="keywordflow">for</font> (i = 0; i &lt; ft-&gt;nentries; i++)
00102     {
00103       <font class="keywordflow">if</font> (fileId_isValid (ft-&gt;elements[i]-&gt;fder))
00104         {
00105           s = <a class="code" href="message_c.html#a18">message</a> (<font class="stringliteral">"%s\n[%d] %s %q %d (%s)"</font>, 
00106                        s, i, 
00107                        ft-&gt;elements[i]-&gt;fname, 
00108                        fileType_unparse (ft-&gt;elements[i]-&gt;ftype),
00109                        ft-&gt;elements[i]-&gt;fder,
00110                        ft-&gt;elements[ft-&gt;elements[i]-&gt;fder]-&gt;fname);
00111         }
00112       <font class="keywordflow">else</font>
00113         {
00114           s = <a class="code" href="message_c.html#a18">message</a> (<font class="stringliteral">"%s\n[%d] %s %q"</font>, s, i, ft-&gt;elements[i]-&gt;fname,
00115                        fileType_unparse (ft-&gt;elements[i]-&gt;ftype));
00116         }
00117           }
00118 
00119   <font class="keywordflow">return</font> s;
00120 }
00121 
<a name="l00122"></a><a class="code" href="fileTable_c.html#a7">00122</a> <font class="keywordtype">void</font> <a class="code" href="fileTable_c.html#a7">fileTable_printTemps</a> (fileTable ft)<font class="keyword"></font>
00123 <font class="keyword"></font>{
00124   <font class="keywordflow">if</font> (fileTable_isDefined (ft))
00125     {
00126       <font class="keywordtype">int</font> i;
00127 
00128       <font class="keywordflow">for</font> (i = 0; i &lt; ft-&gt;nentries; i++)
00129         {
00130           <font class="keywordflow">if</font> (ft-&gt;elements[i]-&gt;ftemp)
00131             {
00132               <font class="keywordflow">if</font> (fileId_isValid (ft-&gt;elements[i]-&gt;fder))
00133                 {
00134                   fprintf (stderr, <font class="stringliteral">"  %s:1\n\t%s:1\n"</font>, 
00135                            cstring_toCharsSafe (ft-&gt;elements[ft-&gt;elements[i]-&gt;fder]-&gt;fname),
00136                            <a class="code" href="cstring_c.html#a29">cstring_toCharsSafe</a> (ft-&gt;elements[i]-&gt;fname));
00137                 }
00138               <font class="keywordflow">else</font>
00139                 {
00140                   fprintf (stderr, <font class="stringliteral">"[no file]\n\t%s:1\n"</font>,
00141                            cstring_toCharsSafe (ft-&gt;elements[i]-&gt;fname));
00142                 }
00143             }
00144         }
00145     }
00146 }
00147 
00148 <font class="comment">/*</font>
00149 <font class="comment">** loads in fileTable from fileTable_dump</font>
00150 <font class="comment">*/</font>
00151 
00152 <font class="keyword">static</font> <font class="comment">/*@notnull@*/</font> ftentry
00153 ftentry_create (<font class="comment">/*@keep@*/</font> cstring tn, <font class="keywordtype">bool</font> temp, fileType typ, fileId der)<font class="keyword"></font>
00154 <font class="keyword"></font>{
00155   ftentry t = (ftentry) dmalloc (<font class="keyword">sizeof</font> (*t));
00156   
00157   <font class="keywordflow">if</font> (cstring_isUndefined (tn))
00158     {
00159       llbug (cstring_makeLiteral (<font class="stringliteral">"Undefined filename!"</font>));
00160     }
00161   
00162   t-&gt;fname = tn;
00163   
00164   t-&gt;basename = cstring_undefined;
00165   t-&gt;ftemp = temp;
00166   t-&gt;ftype = typ;
00167   t-&gt;fder  = der;
00168 
00169   <font class="comment">/* Don't set these until the basename is needed. */</font>
00170   t-&gt;fsystem = FALSE;
00171   t-&gt;fspecial = FALSE;
00172 
00173       <font class="keywordflow">return</font> t;
00174 }
00175 
00176 <font class="keyword">static</font> <font class="keywordtype">void</font>
00177 ftentry_free (<font class="comment">/*@only@*/</font> ftentry t)<font class="keyword"></font>
00178 <font class="keyword"></font>{
00179   <a class="code" href="cstring_c.html#a27">cstring_free</a> (t-&gt;fname);
00180   <a class="code" href="cstring_c.html#a27">cstring_free</a> (t-&gt;basename);
00181   <a class="code" href="general_c.html#a0">sfree</a> (t);
00182 }
00183 
00184 <font class="comment">/*@only@*/</font> <font class="comment">/*@notnull@*/</font> fileTable
<a name="l00185"></a><a class="code" href="fileTable_c.html#a10">00185</a> <a class="code" href="fileTable_c.html#a10">fileTable_create</a> ()<font class="keyword"></font>
00186 <font class="keyword"></font>{
00187   fileTable ft = (fileTable) dmalloc (<font class="keyword">sizeof</font> (*ft));
00188   
00189   ft-&gt;nentries = 0;
00190   ft-&gt;nspace = FTBASESIZE;
00191   ft-&gt;elements = (ftentry *) dmalloc (FTBASESIZE * <font class="keyword">sizeof</font> (*ft-&gt;elements));
00192   ft-&gt;htable = <a class="code" href="hashTable_c.html#a17">hashTable_create</a> (FTHASHSIZE);
00193   
00194   <font class="keywordflow">return</font> (ft);
00195 }
00196 
00197 <font class="keyword">static</font> <font class="keywordtype">void</font>
00198 fileTable_grow (fileTable ft)<font class="keyword"></font>
00199 <font class="keyword"></font>{
00200   <font class="keywordtype">int</font> i;
00201   ftentry *newent;
00202 
00203   llassert (fileTable_isDefined (ft));
00204 
00205   ft-&gt;nspace = FTBASESIZE;
00206 
00207   newent = (ftentry *) dmalloc ((ft-&gt;nentries + ft-&gt;nspace) * <font class="keyword">sizeof</font> (*newent));
00208 
00209   <font class="keywordflow">for</font> (i = 0; i &lt; ft-&gt;nentries; i++)
00210     {
00211       newent[i] = ft-&gt;elements[i];
00212     }
00213 
00214   <a class="code" href="general_c.html#a0">sfree</a> (ft-&gt;elements);
00215   ft-&gt;elements = newent;
00216 }
00217 
00218 <font class="keyword">static</font> fileId
00219 fileTable_internAddEntry (fileTable ft, <font class="comment">/*@only@*/</font> ftentry e)<font class="keyword"></font>
00220 <font class="keyword"></font>{
00221   llassert (fileTable_isDefined (ft));
00222 
00223   <font class="keywordflow">if</font> (ft-&gt;nspace &lt;= 0)
00224     fileTable_grow (ft);
00225 
00226   ft-&gt;nspace--;
00227 
00228   <a class="code" href="hashTable_c.html#a21">hashTable_insert</a> (ft-&gt;htable, e-&gt;fname, ft-&gt;nentries);
00229   ft-&gt;elements[ft-&gt;nentries] = e;
00230 
00231   ft-&gt;nentries++;
00232 
00233   <font class="keywordflow">return</font> (ft-&gt;nentries - 1);
00234 }
00235 
<a name="l00236"></a><a class="code" href="fileTable_c.html#a12">00236</a> <font class="keywordtype">void</font> <a class="code" href="fileTable_c.html#a12">fileTable_noDelete</a> (fileTable ft, cstring name)<font class="keyword"></font>
00237 <font class="keyword"></font>{
00238   fileId fid = <a class="code" href="fileTable_c.html#a27">fileTable_lookup</a> (ft, name);
00239 
00240   <font class="keywordflow">if</font> (fileId_isValid (fid)) {
00241     llassert (fileTable_isDefined (ft));
00242 
00243     ft-&gt;elements[fid]-&gt;ftype = FILE_NODELETE;
00244   }
00245 }
00246 
00247 <font class="keyword">static</font> fileId
00248 fileTable_addFilePrim (fileTable ft, <font class="comment">/*@only@*/</font> cstring name, 
00249                        <font class="keywordtype">bool</font> temp, fileType typ, fileId der)
00250    <font class="comment">/*@modifies ft@*/</font>
00251 {
00252   <font class="keywordtype">int</font> tindex = fileTable_getIndex (ft, name);
00253 
00254   llassert (ft != fileTable_undefined);
00255 
00256   <font class="keywordflow">if</font> (tindex != NOT_FOUND)
00257     {
00258       llcontbug (message (<font class="stringliteral">"fileTable_addFilePrim: duplicate entry: %q"</font>, name));
00259 
00260       <font class="keywordflow">return</font> tindex;
00261     }
00262   <font class="keywordflow">else</font>
00263     {
00264       ftentry e = ftentry_create (name, temp, typ, der);
00265       
00266       <font class="keywordflow">if</font> (der == fileId_invalid)
00267         {
00268           llassert (cstring_isUndefined (e-&gt;basename));
00269 
00270           e-&gt;basename = cstring_fromChars
00271             (<a class="code" href="general_c.html#a12">removePathFree</a> (removeAnyExtension
00272                              (cstring_toCharsSafe (name))));
00273           e-&gt;fsystem = <a class="code" href="context_c.html#a65">context_isSystemDir</a> (name);
00274           e-&gt;fspecial = <a class="code" href="context_c.html#a64">context_isSpecialFile</a> (name);
00275 
00276           <font class="keywordflow">if</font> (e-&gt;fspecial)
00277             {
00278               cstring srcname = <a class="code" href="cstring_c.html#a38">cstring_concatFree</a> (cstring_fromChars (removeAnyExtension (cstring_toCharsSafe (name))), cstring_makeLiteral (<font class="stringliteral">".c"</font>));
00279               fileId fid = <a class="code" href="fileTable_c.html#a27">fileTable_lookup</a> (ft, srcname);
00280 
00281               <a class="code" href="cstring_c.html#a27">cstring_free</a> (srcname);
00282 
00283               <font class="keywordflow">if</font> (fileId_isValid (fid))
00284                 {
00285                   fileId derid = ft-&gt;elements[fid]-&gt;fder;
00286 
00287                   ft-&gt;elements[fid]-&gt;fspecial = TRUE;
00288 
00289                   <font class="keywordflow">if</font> (fileId_isValid (derid))
00290                     {
00291                       ft-&gt;elements[derid]-&gt;fspecial = TRUE;
00292                     }
00293                 }
00294             }
00295         }
00296       <font class="keywordflow">else</font>
00297         {
00298           ftentry de = ft-&gt;elements[der];
00299 
00300           llassert (cstring_isUndefined (e-&gt;basename));
00301           e-&gt;basename = <a class="code" href="cstring_c.html#a9">cstring_copy</a> (de-&gt;basename);
00302           e-&gt;fsystem = de-&gt;fsystem;
00303           e-&gt;fspecial = de-&gt;fspecial;
00304         }
00305 
00306       <font class="keywordflow">return</font> (fileTable_internAddEntry (ft, e));
00307     }
00308 }
00309 
00310 fileId
<a name="l00311"></a><a class="code" href="fileTable_c.html#a14">00311</a> <a class="code" href="fileTable_c.html#a14">fileTable_addFile</a> (fileTable ft, cstring name)<font class="keyword"></font>
00312 <font class="keyword"></font>{
00313   <font class="comment">/* while (*name == '.' &amp;&amp; *(name + 1) == '/') name += 2; */</font>
00314   <font class="keywordflow">return</font> (fileTable_addFilePrim (ft, cstring_copy (name), 
00315                                  FALSE, FILE_NORMAL, fileId_invalid));
00316 }
00317 
00318 fileId
<a name="l00319"></a><a class="code" href="fileTable_c.html#a15">00319</a> <a class="code" href="fileTable_c.html#a15">fileTable_addFileOnly</a> (fileTable ft, <font class="comment">/*@only@*/</font> cstring name)<font class="keyword"></font>
00320 <font class="keyword"></font>{
00321   <font class="keywordflow">return</font> (fileTable_addFilePrim (ft, name, FALSE, FILE_NORMAL, fileId_invalid));
00322 }
00323 
00324 fileId
<a name="l00325"></a><a class="code" href="fileTable_c.html#a16">00325</a> <a class="code" href="fileTable_c.html#a16">fileTable_addHeaderFile</a> (fileTable ft, cstring name)<font class="keyword"></font>
00326 <font class="keyword"></font>{
00327   DPRINTF ((<font class="stringliteral">"Add header: %s"</font>, name));
00328   <font class="keywordflow">return</font> (fileTable_addFilePrim (ft, cstring_copy (name), FALSE, 
00329                                  FILE_HEADER, fileId_invalid));
00330 }
00331 
00332 <font class="keywordtype">bool</font>
<a name="l00333"></a><a class="code" href="fileTable_c.html#a17">00333</a> <a class="code" href="fileTable_c.html#a17">fileTable_isHeader</a> (fileTable ft, fileId fid)<font class="keyword"></font>
00334 <font class="keyword"></font>{
00335   <font class="keywordflow">if</font> (fileId_isInvalid (fid))
00336     {
00337       <font class="keywordflow">return</font> FALSE;
00338     }
00339 
00340   llassert (fileTable_isDefined (ft) &amp;&amp; fileTable_inRange (ft, fid));
00341   <font class="keywordflow">return</font> (ft-&gt;elements[fid]-&gt;ftype == FILE_HEADER);
00342 }
00343 
00344 <font class="keywordtype">bool</font>
<a name="l00345"></a><a class="code" href="fileTable_c.html#a18">00345</a> <a class="code" href="fileTable_c.html#a18">fileTable_isSystemFile</a> (fileTable ft, fileId fid)<font class="keyword"></font>
00346 <font class="keyword"></font>{
00347   <font class="keywordflow">if</font> (fileId_isInvalid (fid))
00348     {
00349       <font class="keywordflow">return</font> FALSE;
00350     }
00351 
00352   llassert (fileTable_isDefined (ft) &amp;&amp; fileTable_inRange (ft, fid));
00353   <font class="keywordflow">return</font> (ft-&gt;elements[fid]-&gt;fsystem);
00354 }
00355 
00356 <font class="keywordtype">bool</font>
<a name="l00357"></a><a class="code" href="fileTable_c.html#a19">00357</a> <a class="code" href="fileTable_c.html#a19">fileTable_isSpecialFile</a> (fileTable ft, fileId fid)<font class="keyword"></font>
00358 <font class="keyword"></font>{
00359   <font class="keywordflow">if</font> (fileId_isInvalid (fid))
00360     {
00361       <font class="keywordflow">return</font> FALSE;
00362     }
00363 
00364   llassert (fileTable_isDefined (ft) &amp;&amp; fileTable_inRange (ft, fid));
00365   <font class="keywordflow">return</font> (ft-&gt;elements[fid]-&gt;fspecial);
00366 }
00367 
00368 fileId
<a name="l00369"></a><a class="code" href="fileTable_c.html#a20">00369</a> <a class="code" href="fileTable_c.html#a20">fileTable_addLibraryFile</a> (fileTable ft, cstring name)<font class="keyword"></font>
00370 <font class="keyword"></font>{
00371   <font class="keywordflow">return</font> (fileTable_addFilePrim (ft, cstring_copy (name),
00372                                  FALSE, FILE_HEADER, fileId_invalid));
00373 }
00374 
00375 <font class="preprocessor"># ifndef NOLCL</font>
00376 <font class="preprocessor"></font>fileId
<a name="l00377"></a><a class="code" href="fileTable_c.html#a21">00377</a> <a class="code" href="fileTable_c.html#a21">fileTable_addImportFile</a> (fileTable ft, cstring name)<font class="keyword"></font>
00378 <font class="keyword"></font>{
00379   <font class="keywordflow">return</font> (fileTable_addFilePrim (ft, cstring_copy (name), 
00380                                  FALSE, FILE_HEADER, fileId_invalid));
00381 }
00382 
00383 fileId
<a name="l00384"></a><a class="code" href="fileTable_c.html#a22">00384</a> <a class="code" href="fileTable_c.html#a22">fileTable_addLCLFile</a> (fileTable ft, cstring name)<font class="keyword"></font>
00385 <font class="keyword"></font>{
00386   <font class="keywordflow">return</font> (fileTable_addFilePrim (ft, cstring_copy (name), 
00387                                  FALSE, FILE_HEADER, fileId_invalid));
00388 }
00389 <font class="preprocessor"># endif</font>
00390 <font class="preprocessor"></font>
00391 <font class="preprocessor"># ifndef NOLCL</font>
00392 <font class="preprocessor"></font><font class="keyword">static</font> <font class="keywordtype">int</font> tmpcounter = 0;
00393 <font class="preprocessor"># endif</font>
00394 <font class="preprocessor"></font>
00395 fileId
<a name="l00396"></a><a class="code" href="fileTable_c.html#a23">00396</a> <a class="code" href="fileTable_c.html#a23">fileTable_addMacrosFile</a> (fileTable ft)<font class="keyword"></font>
00397 <font class="keyword"></font>{
00398   cstring newname = cstring_fromChars 
00399     (makeTempName (cstring_toCharsSafe (context_tmpdir ()), <font class="stringliteral">"lmx"</font>, <font class="stringliteral">".llm"</font>));
00400 
00401   <font class="keywordflow">return</font> (fileTable_addFilePrim (ft, newname, TRUE, FILE_MACROS, fileId_invalid));
00402 }
00403 
00404 fileId
<a name="l00405"></a><a class="code" href="fileTable_c.html#a24">00405</a> <a class="code" href="fileTable_c.html#a24">fileTable_addCTempFile</a> (fileTable ft, fileId fid)<font class="keyword"></font>
00406 <font class="keyword"></font>{
00407 <font class="preprocessor"># if FALSE</font>
00408 <font class="preprocessor"></font>  <font class="comment">/* Can't control output file name for cl preprocessor */</font>
00409   cstring newname = <a class="code" href="cstring_c.html#a40">cstring_concatChars</a> (removeAnyExtension (fileName (fid)), <font class="stringliteral">".i"</font>);
00410 <font class="preprocessor"># else</font>
00411 <font class="preprocessor"></font>  cstring newname = cstring_fromChars 
00412     (makeTempName (cstring_toCharsSafe (context_tmpdir ()), <font class="stringliteral">"cl"</font>, <font class="stringliteral">".c"</font>));
00413 <font class="preprocessor"># endif</font>
00414 <font class="preprocessor"></font>
00415   llassert (fileTable_isDefined (ft));
00416 
00417   <font class="keywordflow">if</font> (!fileId_isValid (ft-&gt;elements[fid]-&gt;fder))
00418     {
00419       <font class="keywordflow">return</font> (fileTable_addFilePrim (ft, newname, TRUE, FILE_NORMAL, fid));
00420     }
00421   <font class="keywordflow">else</font> 
00422     {
00423       <font class="keywordflow">return</font> (fileTable_addFilePrim (ft, newname, TRUE, FILE_NORMAL,
00424                                      ft-&gt;elements[fid]-&gt;fder));
00425     }
00426 }
00427 
00428 <font class="preprocessor"># ifndef NOLCL</font>
00429 <font class="preprocessor"></font>fileId
<a name="l00430"></a><a class="code" href="fileTable_c.html#a25">00430</a> <a class="code" href="fileTable_c.html#a25">fileTable_addltemp</a> (fileTable ft)<font class="keyword"></font>
00431 <font class="keyword"></font>{
00432   <font class="keywordtype">char</font> *newname = makeTempName (cstring_toCharsSafe (context_tmpdir ()),
00433                                 <font class="stringliteral">"ls"</font>, <font class="stringliteral">".lsl"</font>);
00434   <font class="keywordtype">char</font> *onewname;
00435   fileId ret;
00436   
00437   <font class="keywordflow">if</font> (<a class="code" href="cstring_c.html#a45">cstring_hasNonAlphaNumBar</a> (cstring_fromChars (newname)))
00438     {
00439       <font class="keywordtype">char</font> *lastpath = (<font class="keywordtype">char</font> *)NULL;
00440 
00441       <font class="keywordflow">if</font> (tmpcounter == 0)
00442         {
00443           lldiagmsg
00444             (message
00445              (<font class="stringliteral">"Operating system generates tmp filename containing invalid charater: %s"</font>,
00446               <a class="code" href="cstring_c.html#a28">cstring_fromChars</a> (newname)));
00447           <a class="code" href="llerror_c.html#a22">lldiagmsg</a> (cstring_makeLiteral 
00448                      (<font class="stringliteral">"Try cleaning up the tmp directory.  Attempting to continue."</font>));
00449         }
00450       
00451       lastpath = strrchr (newname, CONNECTCHAR); <font class="comment">/* get the directory */</font>
00452       llassert (lastpath != NULL);
00453       *lastpath = <font class="charliteral">'\0'</font>;
00454 
00455       onewname = newname;
00456       newname = <a class="code" href="cstring_c.html#a29">cstring_toCharsSafe</a> (message (<font class="stringliteral">"%s%hlsl%d.lsl"</font>, 
00457                                               cstring_fromChars (newname),
00458                                               CONNECTCHAR,
00459                                               tmpcounter));
00460       <a class="code" href="general_c.html#a0">sfree</a> (onewname);
00461       tmpcounter++;
00462     }
00463   
00464   <font class="comment">/*</font>
00465 <font class="comment">  ** this is kind of yucky...need to make the result of cstring_fromChars</font>
00466 <font class="comment">  ** refer to the same storage as its argument.  Of course, this loses,</font>
00467 <font class="comment">  ** since cstring is abstract.  Should make it an only?</font>
00468 <font class="comment">  */</font>
00469 
00470   ret = fileTable_addFilePrim (ft, cstring_copy (cstring_fromChars (newname)),
00471                                TRUE, FILE_LSLTEMP, fileId_invalid);
00472   <a class="code" href="general_c.html#a0">sfree</a> (newname);
00473   <font class="keywordflow">return</font> (ret);
00474 }
00475 <font class="preprocessor"># endif</font>
00476 <font class="preprocessor"></font>
00477 <font class="keywordtype">bool</font>
<a name="l00478"></a><a class="code" href="fileTable_c.html#a26">00478</a> <a class="code" href="fileTable_c.html#a26">fileTable_exists</a> (fileTable ft, cstring s)<font class="keyword"></font>
00479 <font class="keyword"></font>{
00480   <font class="keywordtype">int</font> tindex = fileTable_getIndex (ft, s);
00481 
00482   <font class="keywordflow">if</font> (tindex == NOT_FOUND)
00483     <font class="keywordflow">return</font> FALSE;
00484   <font class="keywordflow">else</font>
00485     <font class="keywordflow">return</font> TRUE;
00486 }
00487 
00488 fileId
<a name="l00489"></a><a class="code" href="fileTable_c.html#a27">00489</a> <a class="code" href="fileTable_c.html#a27">fileTable_lookup</a> (fileTable ft, cstring s)<font class="keyword"></font>
00490 <font class="keyword"></font>{
00491   <font class="keywordtype">int</font> tindex = fileTable_getIndex (ft, s);
00492 
00493   <font class="keywordflow">if</font> (tindex == NOT_FOUND)
00494     {
00495       <font class="keywordflow">return</font> fileId_invalid;
00496     }
00497   <font class="keywordflow">else</font>
00498     {
00499       <font class="keywordflow">return</font> tindex;
00500     }
00501 }
00502 
00503 fileId
<a name="l00504"></a><a class="code" href="fileTable_c.html#a28">00504</a> <a class="code" href="fileTable_c.html#a28">fileTable_lookupBase</a> (fileTable ft, cstring base)<font class="keyword"></font>
00505 <font class="keyword"></font>{
00506   <font class="keywordtype">int</font> tindex = fileTable_getIndex (ft, base);
00507 
00508   <font class="keywordflow">if</font> (tindex == NOT_FOUND)
00509     {
00510       
00511       <font class="keywordflow">return</font> fileId_invalid;
00512     }
00513   <font class="keywordflow">else</font>
00514     {
00515       fileId der;
00516 
00517       llassert (fileTable_isDefined (ft));
00518 
00519       der = ft-&gt;elements[tindex]-&gt;fder;
00520       
00521       <font class="keywordflow">if</font> (!fileId_isValid (der))
00522         {
00523           der = tindex;
00524         }
00525 
00526       <font class="keywordflow">return</font> der; 
00527     }
00528 }
00529 
00530 cstring
<a name="l00531"></a><a class="code" href="fileTable_c.html#a29">00531</a> <a class="code" href="fileTable_c.html#a29">fileTable_getName</a> (fileTable ft, fileId fid)<font class="keyword"></font>
00532 <font class="keyword"></font>{
00533   <font class="keywordflow">if</font> (!fileId_isValid (fid))
00534     {
00535       llcontbug 
00536         (<a class="code" href="message_c.html#a18">message</a> (<font class="stringliteral">"fileTable_getName: called with invalid type id: %d"</font>, fid));
00537       <font class="keywordflow">return</font> cstring_makeLiteralTemp (<font class="stringliteral">"&lt;invalid&gt;"</font>);
00538     }
00539 
00540   llassert (fileTable_isDefined (ft));
00541   <font class="keywordflow">return</font> (ft-&gt;elements[fid]-&gt;fname);
00542 }
00543 
00544 cstring
<a name="l00545"></a><a class="code" href="fileTable_c.html#a30">00545</a> <a class="code" href="fileTable_c.html#a30">fileTable_getRootName</a> (fileTable ft, fileId fid)<font class="keyword"></font>
00546 <font class="keyword"></font>{
00547   fileId fder;
00548 
00549   <font class="keywordflow">if</font> (!fileId_isValid (fid))
00550     {
00551       llcontbug (message (<font class="stringliteral">"fileTable_getName: called with invalid id: %d"</font>, fid));
00552       <font class="keywordflow">return</font> cstring_makeLiteralTemp (<font class="stringliteral">"&lt;invalid&gt;"</font>);
00553     }
00554 
00555   <font class="keywordflow">if</font> (!fileTable_isDefined (ft))
00556     {
00557       <font class="keywordflow">return</font> cstring_makeLiteralTemp (<font class="stringliteral">"&lt;no file table&gt;"</font>);
00558     }
00559 
00560   fder = ft-&gt;elements[fid]-&gt;fder;
00561 
00562   <font class="keywordflow">if</font> (fileId_isValid (fder))
00563     {
00564       <font class="keywordflow">return</font> (ft-&gt;elements[fder]-&gt;fname);
00565     }
00566   <font class="keywordflow">else</font>
00567     {
00568       <font class="keywordflow">return</font> (ft-&gt;elements[fid]-&gt;fname);
00569     }
00570 }
00571 
00572 cstring
<a name="l00573"></a><a class="code" href="fileTable_c.html#a31">00573</a> <a class="code" href="fileTable_c.html#a31">fileTable_getNameBase</a> (fileTable ft, fileId fid)<font class="keyword"></font>
00574 <font class="keyword"></font>{
00575   <font class="keywordflow">if</font> (!fileId_isValid (fid))
00576     {
00577       llcontbug (message (<font class="stringliteral">"fileTable_getName: called with invalid id: %d"</font>, fid));
00578       <font class="keywordflow">return</font> cstring_makeLiteralTemp (<font class="stringliteral">"&lt;invalid&gt;"</font>);
00579     }
00580   
00581   <font class="keywordflow">if</font> (!fileTable_isDefined (ft))
00582     {
00583       <font class="keywordflow">return</font> cstring_makeLiteralTemp (<font class="stringliteral">"&lt;no file table&gt;"</font>);
00584     }
00585   
00586   <font class="keywordflow">return</font> (ft-&gt;elements[fid]-&gt;basename);
00587 }
00588 
00589 <font class="keywordtype">bool</font>
<a name="l00590"></a><a class="code" href="fileTable_c.html#a32">00590</a> <a class="code" href="fileTable_c.html#a32">fileTable_sameBase</a> (fileTable ft, fileId f1, fileId f2)<font class="keyword"></font>
00591 <font class="keyword"></font>{
00592   fileId fd1, fd2;
00593 
00594   <font class="keywordflow">if</font> (!fileId_isValid (f1))
00595     {
00596       <font class="keywordflow">return</font> FALSE;
00597     }
00598 
00599   <font class="keywordflow">if</font> (!fileId_isValid (f2))
00600     {
00601       <font class="keywordflow">return</font> FALSE;
00602     }
00603 
00604   llassert (fileTable_isDefined (ft));
00605 
00606   <font class="keywordflow">if</font> (f1 == f2) 
00607     {
00608       <font class="keywordflow">return</font> TRUE;
00609     }
00610 
00611   fd1 = ft-&gt;elements[f1]-&gt;fder;
00612 
00613   <font class="keywordflow">if</font> (!fileId_isValid (fd1))
00614     {
00615       fd1 = f1;
00616     }
00617 
00618   fd2 = ft-&gt;elements[f2]-&gt;fder;
00619 
00620 
00621   <font class="keywordflow">if</font> (!fileId_isValid (fd2))
00622     {
00623       fd2 = f2;
00624     }
00625 
00626   <font class="keywordflow">return</font> (fd1 == fd2);
00627 }
00628 
00629 <font class="keywordtype">void</font>
<a name="l00630"></a><a class="code" href="fileTable_c.html#a33">00630</a> <a class="code" href="fileTable_c.html#a33">fileTable_cleanup</a> (fileTable ft)<font class="keyword"></font>
00631 <font class="keyword"></font>{
00632   <font class="keywordtype">int</font> i;
00633   <font class="keywordtype">bool</font> msg;
00634   <font class="keywordtype">int</font> skip;
00635   
00636   llassert (fileTable_isDefined (ft));
00637 
00638   msg = ((ft-&gt;nentries &gt; 40) &amp;&amp; <a class="code" href="context_c.html#a189">context_getFlag</a> (FLG_SHOWSCAN));
00639   skip = ft-&gt;nentries / 10;
00640 
00641   <font class="keywordflow">if</font> (msg)
00642     {
00643       (<font class="keywordtype">void</font>) fflush (g_msgstream);
00644       fprintf (stderr, <font class="stringliteral">"&lt; cleaning"</font>);
00645     }
00646 
00647   <font class="keywordflow">for</font> (i = 0; i &lt; ft-&gt;nentries; i++)
00648     {
00649       ftentry fe = ft-&gt;elements[i];
00650 
00651       <font class="keywordflow">if</font> (fe-&gt;ftemp)
00652         {
00653           <font class="comment">/* let's be real careful now, hon! */</font>
00654           
00655           <font class="comment">/*</font>
00656 <font class="comment">          ** Make sure it is really a derived file</font>
00657 <font class="comment">          */</font>
00658           
00659           <font class="keywordflow">if</font> (fe-&gt;ftype == FILE_LSLTEMP || fe-&gt;ftype == FILE_NODELETE)
00660             {
00661               ; <font class="comment">/* already removed */</font> 
00662             }
00663           <font class="keywordflow">else</font> <font class="keywordflow">if</font> (fileId_isValid (fe-&gt;fder)) 
00664             {
00665               (<font class="keywordtype">void</font>) <a class="code" href="osd_c.html#a15">osd_unlink</a> (cstring_toCharsSafe (fe-&gt;fname));
00666             }
00667           <font class="keywordflow">else</font> <font class="keywordflow">if</font> (fe-&gt;ftype == FILE_MACROS)
00668             {
00669               (<font class="keywordtype">void</font>) <a class="code" href="osd_c.html#a15">osd_unlink</a> (cstring_toCharsSafe (fe-&gt;fname));
00670             }
00671           <font class="keywordflow">else</font>
00672             {
00673               llbug (message (<font class="stringliteral">"Temporary file is not derivative: %s "</font>
00674                               <font class="stringliteral">"(not deleted)"</font>, fe-&gt;fname));
00675             }
00676         }
00677       <font class="keywordflow">else</font>
00678         {
00679           ;
00680         }
00681 
00682       <font class="keywordflow">if</font> (msg &amp;&amp; ((i % skip) == 0))
00683         {
00684           (<font class="keywordtype">void</font>) fflush (g_msgstream);
00685 
00686           <font class="keywordflow">if</font> (i == 0) {
00687             fprintf (stderr, <font class="stringliteral">" "</font>);
00688           } <font class="keywordflow">else</font> {
00689             fprintf (stderr, <font class="stringliteral">"."</font>);
00690           }
00691 
00692           (<font class="keywordtype">void</font>) fflush (stderr);
00693         }
00694     }
00695   
00696   <font class="keywordflow">if</font> (msg)
00697     {
00698       fprintf (stderr, <font class="stringliteral">" &gt;\n"</font>);
00699     }
00700 }
00701 
00702 <font class="keywordtype">void</font>
<a name="l00703"></a><a class="code" href="fileTable_c.html#a34">00703</a> <a class="code" href="fileTable_c.html#a34">fileTable_free</a> (<font class="comment">/*@only@*/</font> fileTable f)<font class="keyword"></font>
00704 <font class="keyword"></font>{
00705   <font class="keywordtype">int</font> i = 0;
00706   
00707   <font class="keywordflow">if</font> (f == (fileTable)NULL) 
00708     {
00709       <font class="keywordflow">return</font>;
00710     }
00711 
00712   <font class="keywordflow">while</font> ( i &lt; f-&gt;nentries ) 
00713     {
00714       ftentry_free (f-&gt;elements[i]);
00715       i++;
00716     }
00717   
00718   <a class="code" href="hashTable_c.html#a12">hashTable_free</a> (f-&gt;htable);
00719   <a class="code" href="general_c.html#a0">sfree</a> (f-&gt;elements);
00720   <a class="code" href="general_c.html#a0">sfree</a> (f);
00721 }
00722 
00723 <font class="comment">/*</font>
00724 <font class="comment">** unique temp filename are constructed from &lt;dir&gt;&lt;pre&gt;&lt;pid&gt;&lt;msg&gt;.&lt;suf&gt;</font>
00725 <font class="comment">** requires: &lt;dir&gt; must end in '/'</font>
00726 <font class="comment">*/</font>
00727 
00728 <font class="keyword">static</font> <font class="keywordtype">void</font> nextMsg (<font class="keywordtype">char</font> *msg)<font class="keyword"></font>
00729 <font class="keyword"></font>{
00730   <font class="comment">/*@+charint@*/</font>
00731   <font class="keywordflow">if</font> (msg[0] &lt; <font class="charliteral">'Z'</font>) 
00732     {
00733       msg[0]++; 
00734     }
00735   <font class="keywordflow">else</font> 
00736     {
00737       msg[0] = <font class="charliteral">'A'</font>;
00738       <font class="keywordflow">if</font> (msg[1] &lt; <font class="charliteral">'Z'</font>)
00739         { 
00740           msg[1]++; 
00741         }
00742       <font class="keywordflow">else</font>
00743         {
00744           msg[1] = <font class="charliteral">'A'</font>;
00745           <font class="keywordflow">if</font> (msg[2] &lt; <font class="charliteral">'Z'</font>) 
00746             {
00747               msg[2]++;
00748             }
00749           <font class="keywordflow">else</font>
00750             {
00751               msg[2] = <font class="charliteral">'A'</font>;
00752               <font class="keywordflow">if</font> (msg[3] &lt; <font class="charliteral">'Z'</font>) 
00753                 {
00754                   msg[3]++; 
00755                 }
00756               <font class="keywordflow">else</font>
00757                 {
00758                   llassertprint (FALSE, (<font class="stringliteral">"nextMsg: out of unique names!!!"</font>));
00759                 }
00760             }
00761         }
00762     }
00763   <font class="comment">/*@-charint@*/</font>
00764 }
00765 
00766 <font class="keyword">static</font> <font class="comment">/*@only@*/</font> <font class="keywordtype">char</font> *makeTempName (<font class="keywordtype">char</font> *dir, <font class="keywordtype">char</font> *pre, <font class="keywordtype">char</font> *suf)<font class="keyword"></font>
00767 <font class="keyword"></font>{
00768   <font class="keyword">static</font> <font class="keywordtype">int</font> pid = 0; 
00769   <font class="keyword">static</font> <font class="comment">/*@owned@*/</font> <font class="keywordtype">char</font> *msg = NULL; 
00770   <font class="keyword">static</font> <font class="comment">/*@only@*/</font> <font class="keywordtype">char</font> *pidname = NULL;
00771   size_t maxlen;
00772   <font class="keywordtype">char</font> *buf;
00773 
00774   llassert (strlen (pre) &lt;= 3);
00775 
00776   <font class="comment">/*</font>
00777 <font class="comment">  ** We limit the temp name to 8 characters:</font>
00778 <font class="comment">  **   pre: 3 or less</font>
00779 <font class="comment">  **   msg: 3</font>
00780 <font class="comment">  **   pid: 2  (% 100)</font>
00781 <font class="comment">  */</font>
00782 
00783   <font class="keywordflow">if</font> (msg == NULL)
00784     {
00785       msg = <a class="code" href="general_c.html#a27">mstring_copy</a> (<font class="stringliteral">"AAA"</font>); <font class="comment">/* there are 26^3 temp names */</font>
00786     }
00787 
00788   <font class="keywordflow">if</font> (pid == 0) 
00789     {
00790       <font class="comment">/*@+matchanyintegral@*/</font>
00791       pid = <a class="code" href="osd_c.html#a16">osd_getPid</a> ();
00792       <font class="comment">/*@=matchanyintegral@*/</font>
00793     }
00794 
00795   <font class="keywordflow">if</font> (pidname == NULL) 
00796     {
00797       pidname = <a class="code" href="cstring_c.html#a29">cstring_toCharsSafe</a> (message (<font class="stringliteral">"%d"</font>, pid % 100));
00798     }
00799   <font class="keywordflow">else</font> 
00800     {
00801       pidname = mstring_createEmpty ();
00802     }
00803   
00804   maxlen = (strlen (dir) + strlen (pre) + strlen (msg) 
00805             + strlen (pidname) + strlen (suf) + 2);
00806 
00807   buf = <a class="code" href="general_c.html#a29">mstring_create</a> (size_toInt (maxlen));
00808 
00809   sprintf (buf, <font class="stringliteral">"%s%s%s%s%s"</font>, dir, pre, pidname, msg, suf);
00810   nextMsg (msg);
00811 
00812   <font class="keywordflow">while</font> (<a class="code" href="osd_c.html#a9">osd_fileExists</a> (buf))
00813     {
00814       sprintf (buf, <font class="stringliteral">"%s%s%s%s%s"</font>, dir, pre, pidname, msg, suf);
00815       nextMsg (msg);
00816     }
00817 
00818   <font class="keywordflow">return</font> buf;
00819 }
00820   
00821 
00822 
</div></pre><hr><address><small>Generated at Fri Nov 3 18:57:41 2000 for LCLint by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.3 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2000</small></address>
</body>
</html>
